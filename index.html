<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" 
      content="width=device-width, initial-scale=1.0,
               minimum-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">
<title>ソフトテニス ダブルスマッチ スコアボードアプリ</title>

<!-- 既存フォント -->
<!-- Google Fonts Preconnect -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=RocknRoll+One&family=Seymour+One&family=Rubik+Doodle+Shadow&family=Saira:ital,wght@0,100..900;1,100..900&family=BBH+Hegarty&family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">

<!-- PWA用 -->
<meta name="theme-color" content="#006400">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ソフトテニスSB">

<!-- マニフェスト（別ファイル） -->
<link rel="manifest" href="manifest.json">

<!-- Google Analytics (集計ツール)-->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZJXT1XNPN2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZJXT1XNPN2');
</script>
</head>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  font-family:"Kosugi Maru",sans-serif;
  background: #006400;
  color:#fff;
  overflow:hidden;
}

/* --- アプリ基本設定 --- */

/* --- すべてのテキスト選択を禁止 --- */
* {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* --- サーバー点滅 --- */
@keyframes blink {
  0%, 50%, 100% { opacity: 1; }
  25%, 75% { opacity: 0; }
}
.blinking { animation: blink 0.6s linear; }

/* テキストをゆっくり点滅（1秒周期） */
.blink-text {
  animation: textBlink 1.5s linear infinite;
}
@keyframes textBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* ---------------------------- スケーリング（全スマホ対応版 ---------------------------- */
#appScaleWrapper {
  width: 400px;   /* デザイン基準幅 */
  height: 800px;  /* デザイン基準高さ */
  transform-origin: top left;
  position: fixed;
  top: 0;
  left: 0;
  overflow: hidden;
}
/* ---------------------------- スケーリング（全スマホ対応版 ---------------------------- */

/* --------------------------------- 会社名表示 --------------------------------- */
#companyName {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  font-weight: bold;
  font-family: "BBH Hegarty", sans-serif;
  color: #fff;
  text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
  opacity: 1;
  z-index: 999;
  transition: opacity 1s ease;
}

/* フェードイン → 数秒後フェードアウト */
@keyframes fadeInOut {
  0% { opacity: 0; }
  20% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; }
}
/* --------------------------------- 会社名表示 --------------------------------- */

/* --------------------------------- タイトル画面の表示アニメーション --------------------------------- */
/* --- タイトル画面 --- */
#titleWrapper {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%); /* 常に画面中央に */
  width: 100%;
  height: 100dvh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#titleScreen {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100dvh;
  text-align: center;
  background: linear-gradient(-45deg, #004d00, #006400, #008000, #006400);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  overflow: hidden;
}

/* --- タイトル文字 --- */
#titleText {
  font-family: "RocknRoll One", sans-serif;
  font-weight: 400;
  font-style: normal;
  color: #fff;
  letter-spacing: 3px;
  text-shadow: 3px 3px 8px rgba(0,0,0,0.6);
  position: relative;
}

/* --- ソフトテニス文字ラッパー --- */
.title-main-wrapper {
  position: relative;
  display: inline-block;
  transform: translateX(20px);
  animation: textShake 1.5s forwards;
  animation-delay: 0.3s;
}

/* --- ボール --- */
.ball-left {
  position: absolute;
  left: -50px;
  top: 0;
  font-size: 1em;
  z-index: 2;
  animation: ballBounce 1.5s forwards;
}

/* --- 影（ボールの真下に配置） --- */
.ball-shadow {
  position: absolute;
  left: -50px;
  top: 1.13em;                     /* ← ボール1個分 下へ移動！（ここが修正点） */
  width: 1em;
  height: 0.3em;
  background: rgba(0,0,0,0.3);
  border-radius: 50%;
  z-index: 1;
  animation: shadowBounce 1.5s forwards;
}

/* --- ボール：高バウンド + 減衰 + 3秒版 --- */
@keyframes ballBounce {
  0%   { transform: translateY(-150%); }  /* 1回目：超ジャンプ */
  18%  { transform: translateY(0); }

  32%  { transform: translateY(-80%); }   /* 2回目：高め */
  45%  { transform: translateY(0); }

  58%  { transform: translateY(-35%); }   /* 3回目：やや高め */
  70%  { transform: translateY(0); }

  82%  { transform: translateY(-15%); }   /* 4回目：弱く */
  100% { transform: translateY(0); }
}


/* --- 影：ボール同期の減衰バウンド 3秒版 --- */
@keyframes shadowBounce {
  /* 1回目（最大） */
  0%   { transform: translateY(-150%) scaleX(0.45) scaleY(0.75); opacity: 0.4; }
  18%  { transform: translateY(0) scaleX(1.8) scaleY(0.35); opacity: 1; }

  /* 2回目 */
  32%  { transform: translateY(-80%) scaleX(0.6) scaleY(0.65); opacity: 0.6; }
  45%  { transform: translateY(0) scaleX(1.5) scaleY(0.4); opacity: 0.95; }

  /* 3回目 */
  58%  { transform: translateY(-35%) scaleX(0.75) scaleY(0.55); opacity: 0.5; }
  70%  { transform: translateY(0) scaleX(1.3) scaleY(0.4); opacity: 0.85; }

  /* 4回目（収束） */
  82%  { transform: translateY(-15%) scaleX(0.9) scaleY(0.5); opacity: 0.4; }
  100% { transform: translateY(0) scaleX(1.0) scaleY(0.45); opacity: 0.7; }
}

/* --- テキスト揺れの減衰 3秒版 --- */
@keyframes textShake {
  0%   { transform: translateX(20px) translateY(0); }
  18%  { transform: translateX(20px) translateY(-5px); }  /* 大揺れ */

  32%  { transform: translateX(20px) translateY(3px); }
  45%  { transform: translateX(20px) translateY(-2px); }

  58%  { transform: translateX(20px) translateY(1.5px); }
  70%  { transform: translateX(20px) translateY(-1px); }

  100% { transform: translateX(20px) translateY(0); }
}

/* --- 各行文字アニメ --- */
.title-main, .line {
  display: block;
  opacity: 0;
  transform: scale(0.8) translateY(20px);
  animation: fadeUp 1s ease forwards, shine 2s ease-in-out infinite;
  animation-fill-mode: forwards;
  color: #fff;
}

.title-main { animation-delay: 0.3s; }
.line:nth-child(2) { animation-delay: 0.8s; }
.line:nth-child(3) { animation-delay: 1.3s; }

/* --- 文字浮かび上がり --- */
@keyframes fadeUp {
  0% { opacity: 0; transform: scale(0.8) translateY(20px); }
  60% { opacity: 1; transform: scale(1.05) translateY(-5px); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* --- 光るシャイン --- */
@keyframes shine {
  0%, 100% { text-shadow: 3px 3px 8px rgba(0,0,0,0.6); }
  50% { text-shadow: 3px 3px 20px rgba(255,255,255,0.8); }
}

/* --- 背景グラデーション --- */
@keyframes gradientBG {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}
/* --------------------------------- タイトル画面の表示アニメーション終り --------------------------------- */


/* Smash!!!!ロゴ表示 */
@keyframes smoothSpinPop {
  0% {transform: scale(0) rotate(0deg);opacity: 0;}
  50% {transform: scale(1.5) rotate(540deg);opacity: 1;}
  100% {transform: scale(1) rotate(1080deg);}
}

#smashText {
  font-size: 3rem;
  font-weight: bold;
  color: #ff0;
  text-shadow: 2px 2px 6px #000;
  text-align: center;
  animation: smoothSpinPop 1s linear forwards;
}

#smashExclamations {
  font-size: 4rem;
  font-weight: bold;
  text-shadow: 2px 2px 6px #000;
  animation: rainbowColors 1s linear infinite;
  display: inline-block;
  letter-spacing: 4px;  /* !!!!の間隔を広げる */
}

@keyframes rainbowColors {
  0% { color: red; }
  20% { color: orange; }
  40% { color: yellow; }
  60% { color: green; }
  80% { color: blue; }
  100% { color: purple; }
}

/* ------------------------------------------- 設定画面全体 ------------------------------------------- */

/* ------------------------------------------- 共通スタイル ------------------------------------------- */
* {
  box-sizing: border-box;
}

input, select, button {
  padding: 6px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  font-family: "Kosugi Maru", sans-serif;
}

button {
  cursor: pointer;
  transition: all 0.2s;
}

button:hover { opacity: 0.9; }

/* ------------------------------------------- 設定画面 ------------------------------------------- */
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 5px;
}

.setup-block {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

#setupScreen {
  display: none;
  position: relative;
  width: 100%;
}

/* 上部透明枠 */
#setupExtraTop {
  width: 100%;
  height: 100px;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
}

/* ===============================
   設定画面タイトル
   =============================== */
.setup-header {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  margin-top: 20px;
  margin-bottom: 20px;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
  height: 52px;
}

.setup-title {
  font-size: 18px;
  line-height: 48px;
  margin: 0;
}

/* ===============================
   設定画面 インフォメーションボタン
   （試合画面と同じ思想）
   =============================== */
.help-footer-btn {
  position: fixed;
  bottom: 2px;
  right: 12px;

  width: 36px;
  height: 36px;
  border-radius: 50%;

  background-color: #2f80ed;
  color: #ffffff;
  border: 2px solid #ffffff;

  font-size: 20px;
  font-weight: bold;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 1;

  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;

  box-shadow: 0 2px 6px rgba(0,0,0,0.25);

  transition:
    background-color 0.2s ease,
    transform 0.2s ease,
    box-shadow 0.2s ease;

  z-index: 999;
}

.help-footer-btn:hover {
  background-color: #1c6ed5;
  transform: scale(1.05);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

.help-footer-btn:active {
  transform: scale(0.95);
}

/* ===============================
   共通 インフォメーションモーダル
   （設定画面・試合画面 共通）
   =============================== */

/* モーダル背景 */
.help-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  z-index: 2000;
}

/* 表示時 */
.help-modal.show {
  display: block;
}

/* モーダル本体 */
.help-modal-content {
  max-width: 400px;           /* 幅調整 */
  width: 90%;                 /* 画面幅に応じて縮小 */
  max-height: 70vh;           /* 高さ制限 */
  margin: 15vh auto 0;        /* 上余白＋中央寄せ */
  padding: 16px 18px;
  background: #f9f9f9;
  color: #333;
  font-size: 15px;            /* ベース文字サイズを少し大きく */
  line-height: 1.5;
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  text-align: left;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* モーダル本文（スクロール可能） */
.modal-body {
  overflow-y: auto;
  padding-right: 5px;         /* スクロールバーとの隙間 */
  font-size: 1em;             /* 統一文字サイズ */
}

/* 見出し */
.help-modal-content h2 {
  text-align: center;
  margin-bottom: 12px;
  font-size: 1.2em;           /* 見出しを少し大きく */
}

.help-modal-content h3 {
  margin-top: 16px;
  margin-bottom: 8px;
  font-size: 1em;             /* 統一文字サイズ */
}

/* 段落 */
.modal-body p {
  margin-bottom: 12px;
  font-size: 1em;             /* 統一文字サイズ */
}

/* リスト */
.modal-body ul {
  margin-bottom: 12px;
  padding-left: 18px;
  font-size: 1em;             /* 統一文字サイズ */
}

/* 閉じるボタン */
.help-close {
  margin-top: 12px;
  font-size: 13px;            /* 読みやすく調整 */
  background: #e0e0e0;
  border: none;
  color: #333;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 4px;
  align-self: center;
  transition: background 0.2s, color 0.2s;
}

.help-close:hover {
  background: #d4d4d4;
  color: #000;
}

/* 注意書き・補足 */
.help-modal-content .modal-body .note {
  font-size: 12px;    /* 文字サイズ */
  color: #666;        /* 色 */
  line-height: 1.4;   /* 行間 */
  background: rgba(0,0,0,0.03); /* 背景を付ける場合 */
  padding: 8px 12px;
  margin: 10px 0;
  border-left: 3px solid #6fd3f5;
  border-radius: 6px;
}



/* ===============================
   試合画面 インフォメーションボタン
   =============================== */
.match-info-btn {
  position: fixed;
  bottom: 2px;
  right: 12px;

  width: 36px;
  height: 36px;
  border-radius: 50%;

  background-color: #2f80ed;  /* 統一 */
  color: #ffffff;
  border: 2px solid #ffffff;

  font-size: 20px;
  font-weight: bold;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 1;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);

  transition:
    background-color 0.2s ease,
    transform 0.2s ease,
    box-shadow 0.2s ease;

  z-index: 999;
}

.match-info-btn:hover {
  background-color: #1c6ed5;  /* 統一 */
  transform: scale(1.05);
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

.match-info-btn:active {
  transform: scale(0.95);
}

/* 下余白透明枠 */
#setupSubFrame {
  width: 100%;
  height: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
}

/* アナウンス上段 */
#setupHintTextTop {
  width: 100%;
  height: 34px;
  margin: 4px 0;
  pointer-events: none;
  text-align: center;
  color: white;
  font-size: 16px;
  line-height: 18px;
}

/* 下アナウンス */
#setupMessageFrame {
  width: 100%;
  text-align: center;
  height: 20px;
  margin-bottom: 0px;
  color: white;
  font-size: 0px;
  pointer-events: none;
}

#setupHintTextBottom {
  width: 100%;
  height: 20px;
  margin: 4px 0;
  text-align: center;
  color: white;
  font-size: 16px;
  line-height: 18px;
}

/* ------------------------------------------- 大会名関連 ------------------------------------------- */
.tournament-wrapper {
  width: 100%;
  max-width: 400px;
  margin: 4px auto;
}

#tournamentNameInput {
  width: 100%;
  max-width: 400px;
  height: 38px;
  text-align: center;
  font-size: 18px;
  border-radius: 8px;
  border: none;
}

.tournament-save-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 400px;
  margin: 4px auto;
  gap: 6px;
}

.tournament-btn {
  flex: 0 0 38px;
  height: 38px;
  font-size: 16px;
  color: #fff;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(to bottom, #33AADD, #0077B6);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.18);
  transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.15s ease;
}

.tournament-btn:hover {
  background: linear-gradient(to bottom, #4BBBEA, #1490CC);
}

.tournament-btn:active {
  background: linear-gradient(to bottom, #1490CC, #006AA3);
  transform: translateY(3px);
}

/* 大会名保存・初期化ボタン横並び用 */
/* 横並び用親 */
.tournament-buttons-row {
  display: flex;
  gap: 8px;          /* 中央の隙間を6pxに統一 */
  width: 100%;
  max-width: 400px;  /* 親幅を固定 */
  margin: 4px 0;
}

/* ▽ 保存ボタン */
.save-tournament-btn {
  flex: 1;              /* 横幅均等 */
  height: 38px;
  font-size: 14px;
  font-weight: bold;
  font-family: "Kosugi Maru", sans-serif;
  color: #fff;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;

  background: linear-gradient(to bottom, #FFB733, #FF8C00);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.18);
  transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.15s ease;
}

/* 大会名初期化ボタン（灰系・横並び用） */
.reset-tournament {
  flex: 1;              /* 横幅均等 */
  height: 38px;
  font-size: 14px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: #fff;

  background: linear-gradient(to bottom, #7a7a7a, #555555);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.18);
  transition: transform 0.15s ease, background 0.15s ease, box-shadow 0.2s ease;
}

.reset-tournament:hover {
  background: linear-gradient(to bottom, #8a8a8a, #666666);
}

.reset-tournament:active {
  background: linear-gradient(to bottom, #666666, #4d4d4d);
  transform: translateY(3px);
}

.tournament-select {
  flex: 1;
  height: 38px;
  font-size: 16px;
  text-align: center;
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 0 6px;
}

/* 削除ボタン */
.delete-button {
  width: 100%;
  max-width: 400px;
  height: 38px;
  margin: 4px auto;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
  border-radius: 12px;
  background: linear-gradient(to bottom, #d9534f, #b52b27);
}

.delete-button:hover {
  background: linear-gradient(to bottom, #e06660, #c33b30);
}

.delete-button:active {
  background: linear-gradient(to bottom, #b52b27, #8c1e1b);
  transform: translateY(3px);
}

/* ------------------------------------------- チーム入力・保存 ------------------------------------------- */
.team-inputs-wrapper {
  width: 100%;
  max-width: 400px;
  margin: 4px auto;
}

.team-inputs {
  display: flex;
  justify-content: space-between;
  gap: 6px;
}

.team-column {
  width: 49%;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.team-column input {
  width: 100%;
  height: 32px;
  padding: 6px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: center;
}

.team-buttons-row {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  align-items: center;
}

.team-buttons-row button {
  flex: 1;
  height: 38px;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
}

.save-button {
  background: linear-gradient(to bottom, #FFB733, #FF8C00);
  color: #fff;
}

.save-button:hover {
  background: linear-gradient(to bottom, #FFC54D, #FF9A33);
}

.save-button:active {
  background: linear-gradient(to bottom, #FF9A33, #FF7A00);
  transform: translateY(3px);
}

.reset-button {
  background: linear-gradient(to bottom, #7a7a7a, #555555);
  color: #fff;
}

.reset-button:hover {
  background: linear-gradient(to bottom, #8a8a8a, #666666);
}

.reset-button:active {
  background: linear-gradient(to bottom, #666666, #4d4d4d);
  transform: translateY(3px);
}

/* ------------------------------------------- チーム呼出し ------------------------------------------- */
.team-restore-wrapper {
  width: 100%;
  max-width: 400px;
  margin: 4px auto;
}

.team-restore-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.team-restore-select {
  flex: 1;
  min-width: 0;
  height: 38px;
  font-size: 16px;
  text-align: center;
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 0 6px;
}

.team-restore-btn {
  flex: 0 0 36px;
  height: 36px;
  font-size: 14px;
  color: #fff;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(to bottom, #33AADD, #0077B6);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.18);
}

.team-restore-btn:hover {
  background: linear-gradient(to bottom, #4BBBEA, #1490CC);
}

.team-restore-btn:active {
  background: linear-gradient(to bottom, #1490CC, #006AA3);
  transform: translateY(3px);
}

/* ------------------------------------------- ゲームマッチ選択・開始 ------------------------------------------- */
.select-wrapper {
  width: 100%;
  max-width: 400px;
  margin: 4px auto;
}

.match-type-select {
  width: 100%;
  height: 38px;
  font-size: 18px;
  border-radius: 12px;
  text-align: center;
  border: none;
  color: #fff;
  background: linear-gradient(to bottom, #33AADD, #0077B6);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.18);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

.match-type-select option {
  color: #000;
  background: #fff;
}

.start-wrapper {
  width: 100%;
  display: flex;
  justify-content: center;
  margin: 4px 0;
}

.start-btn {
  width: 100%;
  max-width: 400px;
  height: 38px;
  font-size: 18px;
  font-weight: bold;
  color: #fff;
  border-radius: 12px;
  background: linear-gradient(to bottom, #FFB733, #FF8C00);
  box-shadow: 0 4px 6px rgba(0,0,0,0.25),
              inset 0 2px 4px rgba(255,255,255,0.3),
              inset 0 -2px 4px rgba(0,0,0,0.15);
}

.start-btn:hover {
  background: linear-gradient(to bottom, #FFC54D, #FF9A33);
}

.start-btn:active {
  background: linear-gradient(to bottom, #FF9A33, #FF7A00);
  transform: translateY(3px);
}

/* アプリURLコピー用（コンパクト版） */
.share-url-wrapper-compact {
  display: flex;
  flex-wrap: wrap;       /* 画面幅が狭い場合のみ改行 */
  max-width: 400px;
  width: 90%;
  margin: 14px auto;
  gap: 2px;
  font-size: 10px;
  align-items: center;
}

.share-label {
  flex: 0 0 auto;        /* ラベルは必要な幅だけ確保 */
  white-space: nowrap;
  margin-right: 4px;     /* ラベルとURLの距離を調整 */
}

#appURL {
  flex: 1 1 auto;        /* 入力欄が残り幅いっぱい */
  min-width: 120px;
  padding: 4px 6px;
  font-size: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background-color: #f9f9f9;
  overflow-x: auto;
  white-space: nowrap;
}

#copyURL {
  padding: 4px 6px;
  font-size: 10px;
  background-color: #2a5298;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#copyURL:hover {
  background-color: #1e3c72;
}

/* アプリURLコピー用（コンパクト版） */

#settingsFooter, .other-text {
  margin-top: 4px;
}

/* 著作権関連 */
#settingsFooter {
  margin-top: 0px;
  padding-top: 2px;
  font-size: 12px;
  text-align: center;
  opacity: 0.6;
  cursor: pointer;
}

/* モーダル全体 */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: rgba(0,0,0,0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* モーダル表示時 */
.modal.show {
  display: block;
  opacity: 1;
}

/* モーダル内部 */
.modal-content {
  background-color: #fff;
  color: #222;
  margin: 5% auto;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  max-height: 90vh;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  transform: translateY(30px);
  transition: transform 0.3s ease;
}

/* モーダル表示時のスライド */
.modal.show .modal-content {
  transform: translateY(0);
}

/* モーダル本文 */
.modal-body {
  overflow-y: auto;
  padding-right: 5px;
}

/* 閉じるボタン */
.close {
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  align-self: flex-end;
  cursor: pointer;
  margin-bottom: 10px;
}

.close:hover {
  color: #f00;
}

.modal-content h2 {
  font-size: 1.2em;
  margin-bottom: 10px;
}

.modal-body p {
  font-size: 0.95em;
  line-height: 1.5;
}

/* 著作権関連 */

/* -- OFUSE設置 -- */
.support-section {
  font-size: 9.5px;
  text-align: center;
  padding: 6px 0 4px;
  margin-top: 10px;
  color: rgba(255, 255, 255, 0.45);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.support-section a {
  color: rgba(255, 255, 255, 0.55);
  text-decoration: none;
  border-bottom: 1px dotted rgba(255, 255, 255, 0.4);
}

.support-section a:hover {
  color: rgba(255, 255, 255, 0.75);
}

/* ===== モーダル背景 ===== */
.support-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.25); /* 背景を少し薄く */
  z-index: 1000;
}

/* ===== モーダル本体 ===== */
.support-modal-content {
  max-width: 300px;               /* 横幅を小さく */
  margin: 15vh auto 0;
  padding: 16px 18px;
  background: #f9f9f9;            /* 明るい背景 */
  color: #333;                     /* 文字は濃いめ */
  font-size: 13px;
  line-height: 1.6;
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15); /* 軽めの影 */
  text-align: center;
}

.support-modal-content a {
  color: #4CAF50;                 /* リンクも明るくアクセント */
  text-decoration: underline;
}

.support-close {
  margin-top: 12px;
  font-size: 12px;
  background: #e0e0e0;            /* ボタンも明るく */
  border: none;
  color: #333;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 4px;
  transition: background 0.2s, color 0.2s;
}

.support-close:hover {
  background: #d4d4d4;             /* ホバーで少し濃く */
  color: #000;
}

/* -- OFUSE設置 -- */

/* ------------------------------------------- 設定画面全体 ------------------------------------------- */

/* 試合画面全体 */
#gameScreen {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  box-sizing: border-box;
  padding-top: 0;
  padding-bottom: 0;
  margin-top: 0;
  height: auto;
  position: relative;

  /* 縦スクロールのみ許可、横は非表示 */
  overflow-y: auto;
  overflow-x: hidden;

  /* はみ出し防止のために幅指定（推奨） */
  width: 100%;
  max-width: 100vw;
}

/* 全体を中央寄せにする外枠 */
#centerWrapper {
  width: 100%;
  display: flex;
  justify-content: center; /* 横中央寄せ */
  margin-top: 1px;
}

/* 既存の outerContainer を横揃え中央に */
#outerContainer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2px; /* A・vs・B の間のバランス調整 */
}

/* ------------------- お天気と日時（2段表示＋調整版） ------------------- */
#dateWeatherContainer {
    width: 100%;
    max-width: 400px; /* ← 390px → 400px */
    margin: 2px auto;
    display: flex;
    flex-direction: column;   /* ※2段表示を維持 */
    gap: 4px;
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.25);
    border-radius: 12px;
    backdrop-filter: blur(4px);
    color: #fff;
    font-family: "Segoe UI", sans-serif;
}

/* 日時（少し大きく） */
#safeDateTimeBox {
    font-size: 15px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0px; /* 天気との間隔 */
}

/* 曜日カラー */
.week-sun { color: #ff6b6b; }   /* 日曜 */
.week-sat { color: #4dabf7; }   /* 土曜 */
.week-weekday { color: #ffffff; } /* 平日 */

/* 天気全体枠 */
#weatherBox {
    display: flex;
    align-items: center;
    justify-content: center;   /* 中央寄せは維持 */

    font-size: 12px;
    font-weight: 400;

    gap: 4px;                  /* ★ 8px → 4px に調整（詰めすぎない最適値） */

    width: 100%;
    max-width: 100%;
    white-space: nowrap;       /* 1段表示維持 */

    overflow: visible;         /* ← 切らない */
}

/* 天気アイコン */
#weatherBox i {
    font-size: 15px;
    padding: 1px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    flex-shrink: 0;
    line-height: 1;
}

/* hover */
#weatherBox i:hover {
    transform: translateY(-1px) scale(1.1);
    background: rgba(255,255,255,0.3);
}

/* 天気別カラー */
.wi-day-sunny { color: #FFD93D; background: #FFD93D33; }
.wi-day-cloudy { color: #FFB347; background: #FFB34733; }
.wi-cloud { color: #90E0EF; background: #90E0EF33; }
.wi-showers { color: #48CAE4; background: #48CAE433; }
.wi-rain, .wi-rain-wind { color: #0077B6; background: #0077B633; }
.wi-snow, .wi-snowflake-cold { color: #CAF0F8; background: #CAF0F833; }
.wi-na { color: #FF6B6B; background: #FF6B6B33; }

#weatherBox span.region {
    max-width: none;
    overflow: visible;
    text-overflow: clip;
    white-space: nowrap;
    font-size: 12px; /* 任意 */
}


#weatherBox span.region.prefecture {
    font-size: 11px;
    opacity: 0.9;
}

#weatherBox .weather-name {
    opacity: 0.85;      /* 少し控えめ */
    margin-right: 2px; /* 数値との間隔 */
}

/* 天気表示の横間隔を完全に均一化 */
#weatherBox span,
#weatherBox i {
    margin-right: 4px;
}

/* 最後だけ余白なし */
#weatherBox span:last-child,
#weatherBox i:last-child {
    margin-right: 0;
}

/* 風 */
.strong-wind {
    color: #4fa3ff;
}

/* 雨 */
.heavy-rain {
    color: #2b7cff;
    font-weight: 600;
}

/* 雷 */
.thunder-alert {
    color: #ffcc00;
    font-weight: 600;
}

/* モーダル位置調整（画面トップに近く表示） */
#addressModal {
    display: none;              /* ← 初期は非表示 */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);

    justify-content: center;    /* JSで表示された時に有効 */
    align-items: flex-start;    /* 上寄せ */
    padding-top: 60px;

    z-index: 9999;
}


#addressModalContent {
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:300px;
    color:#333;
}

#addressModalContent input {
    width: 95%;
    padding: 6px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

#addressModalContent button {
    padding: 6px 12px;
    margin: 4px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background-color: #48CAE4;
    color: #fff;
    font-weight: 500;
}

#addressModalContent button:hover {
    background-color: #0096C7;
}
/* ------------------- お天気と日時（2段表示＋調整版） ------------------- */

/* 試合画面_大会名表示 */
#tournamentDisplay {
  display: block;
  width: 100%;
  text-align: center;
  font-weight: bold;
  color: #ffffff;
  letter-spacing: 1px;
  margin-top: 3px;
  margin-bottom: 3px;
  font-family: "Kosugi Maru", sans-serif;

  /* 折り返し禁止 + はみ出し防止 */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* デフォルトフォントサイズ */
  font-size: 21px;

  position: relative;
  z-index: 5;
}

/* 狭い画面（600px以下）では大会名も縮小 */
@media (max-width: 600px) {
  #tournamentDisplay {
    font-size: 4.6vw;  /* finalDisplay より少し大きめ */
  }
}

/* 試合画面_--- チーム名表示（ぷっくり・フラット版） --- */
.team-name-display {
  width: 155px;
  height: 40px;
  line-height: 40px;
  border-radius: 10px;
  background: #fff; /* JSで変更可能（単色） */
  color: #000;
  font-weight: bold;
  text-align: center;
  margin: 3px 5px;
  box-sizing: border-box;
  font-size: 18px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* JSと干渉しないように background の transition は入れない */
  transition: box-shadow 0.2s ease;

  /* --- ぷっくり立体・浮かない版 --- */
  box-shadow:
    /* 上の白ハイライト（光） */
    inset 0 2px 4px rgba(255, 255, 255, 0.7),

    /* 下の陰影（丸み） */
    inset 0 -3px 5px rgba(0, 0, 0, 0.18),

    /* わずかな外側影（浮かない程度の自然さ） */
    0 0 3px rgba(0, 0, 0, 0.15);
}

/* 試合画面_--- ペア名表示 --- */
.pair-name{
  font-size:16px;
  text-align:center;
  margin:3px 0;
}

/* 試合画面_vs（レディ）ボタン設定（オレンジ背景・白文字・ぷっくり） */
.ready-btn {
  width: 40px;
  height: 30px;
  background: linear-gradient(to bottom, #ffca7a, #FFA500); /* 上から下のグラデーションで立体感 */
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  color: #ffffff; /* 白文字 */
  font-weight: bold;
  box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3); /* ぷっくり立体感 */
  transition: all 0.2s ease;
  font-family: "Kosugi Maru", sans-serif;
  margin: 0px 5px;
}

.ready-btn:hover {
  background: linear-gradient(to bottom, #ffb84d, #FF8C00);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.35);
}

.ready-btn:active {
  background: linear-gradient(to bottom, #FF8C00, #FF6A00);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) inset;
  transform: translateY(1px);
}

/* Readyボタンが押せない状態（水色・クリック無効化・ぷっくり維持） */
.ready-btn.inactive {
  background: linear-gradient(to bottom, #A6DFFF, #87CEFA); /* 水色グラデーション */
  color: #ffffff; /* 白文字 */
  pointer-events: none; /* クリック無効化 */
  cursor: default;
  box-shadow: 0 3px 5px rgba(0,0,0,0.3); /* 立体感を維持 */
  opacity: 1; /* グレー化防止 */
  transition: all 0.2s ease;
}

/* 試合画面_vs（レディ）ボタン押す前の消灯処理（従来の透明化） */
.inactive {
  opacity: 0.4;        /* 消灯イメージ */
  pointer-events: none; /* クリック無効化 */
}

/* 試合画面_vs（レディ）ボタン設定終り */

/* 試合画面_--- コントロールボタン --- */
.controls{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:1px;
  width:100%;
  align-items:center;
  gap:0px;
  font-family: "Kosugi Maru", sans-serif;
}

/* 試合画面_--- ファイナル・ジャッジ文字標準表示 --- */
.display-fixed {
  width: 100%;
  text-align: center;
  font-weight: bold;
  margin: 1px;
  min-height: 20px;

  /* 通常は20px固定 */
  font-size: 16px;

  /* 折り返し・はみ出し防止 */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 狭い画面（600px以下）では自動縮小 */
@media (max-width: 600px) {
  .display-fixed {
    font-size: 4vw; /* 横幅に応じて自動で小さくなる */
  }
}

/* finalDisplay を入れる透明の枠 */
#finalDisplayWrapper {
  width: 390px;          /* ★ 測定用の固定幅 */
  height: auto;
  overflow: hidden;      /* はみ出し確認用 */
  white-space: nowrap;
  background: transparent;
  margin: 0 auto;        /* 中央寄せ（必要なら） */
}

/* 試合画面_--- ファイナル表示 --- */
#finalDisplay {
  font-weight: bold;
  text-align: center;
  max-width: 100%;
  display: block;   /* ブロック要素で幅が有効になる */
  margin-top: 1px;
  margin-bottom: 0px;
  font-family: "Kosugi Maru", sans-serif;
  width: 100%;
  white-space: nowrap;         /* 折り返さない */
  overflow: hidden;            /* はみ出し防止 */
  
  font-size: 16px;             /* デフォルト16px */
  
  /* 白ベース + 濃いパステル虹色グラデーション */
  background: linear-gradient(
    90deg,
    #ffffff,
    #ff9999,
    #fff266,
    #99ff99,
    #66ffff,
    #6699ff,
    #cc99ff,
    #ffffff
  );
  background-size: 400% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;

  /* 軽めの影で明るさを維持 */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.15);

  /* アニメーション速度 */
  animation: rainbowShift 3s linear infinite;
}

@keyframes rainbowShift {
  0% { background-position: 100% 0%; }
  100% { background-position: 0% 0%; }
}

/* 試合画面_--- デュース等ジャッジ表示 --- */
#deuceDisplay {
  color: #FFD700;         /* ゴールド系でテニスっぽく鮮やか */
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  margin-top: 3px;
  margin-bottom: 3px;

  /* オプション: 少し光らせたい場合 */
  text-shadow: 0 0 3px rgba(255, 215, 0, 0.8);
}

/* 試合画面_得点盤用透明枠内始め */
#overlay-wrapper {
  flex-shrink: 0;   /* ← flex圧縮を防ぐ */
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-direction: column; /* ← 上下の伸びを許可 */
  width: 100%;  /* ← 横幅を固定 */
  height: 140px; /* ← 縦幅を固定 */
  max-width: 100%;
  margin: 2px auto;
  /* border: 2px solid red; */ /* 確認用は不要 */
  padding: 0px; /* ← はみ出し防止の余白を追加 */
  box-sizing: border-box;
  background: rgba(0, 0, 0, 0.3); /* ← 半透明の黒背景（透明度30%） */
  border-radius: 10px; /* ← Rをつける（角丸） */
}

/* --- 試合画面_得点表示標準 --- */
.points-wrapper {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 0px;
  margin-top: 0px;
}
/* --- 試合画面_ポイント盤の外枠 --- */
.points-container {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  flex-wrap: nowrap;
  width: 110px;
  gap: 0px;
}

.overlay-frame {
  display: flex;
  justify-content: space-between; /* 横方向は均等に並べる */
  align-items: flex-start;        /* ← 上揃えに固定 */
  width: 100%;
  gap: 1px;                       /* 少し余白を付ける */
  min-width: 0;
}
.overlay-box {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-width: 0; /* flex内での縮小を許可 */
}
.overlay-inner {
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* 内部は上端揃え */
  align-items: center;         /* 中央揃えにしたいものだけ中央 */
}
.split-box {
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* ← 上端に寄せる！ */
  height: 100%;
}
.split-top {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 10px;
  margin-top: 0px;
}

/* サーバー表示始め */
.split-middle {
  display: flex;
  justify-content: center;  /* 親の中央に配置 */
  align-items: center;
  width: 100%;             
  height: 20px;
  background-color: transparent;
  margin-top: 7px;
  margin-bottom: 5px;
}

.middle-frame {
  display: flex;
  justify-content: center;  /* 中央寄せ */
  align-items: center;
  gap: 26px;                /* 白丸S同士の間隔 */
}

/* 白丸S：電球・ボールのような立体感 */
.middle-box {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 26px;
  height: 26px;
  background: radial-gradient(circle at 30% 30%, #ffffff, #cccccc); /* ぷっくり光沢 */
  border-radius: 50%;
  box-sizing: border-box;
  position: relative;
  box-shadow: 
      0 2px 4px rgba(0,0,0,0.3),       /* 下に軽い影 */
      inset 0 -2px 4px rgba(255,255,255,0.5); /* 内側ハイライトで球体感 */
  opacity: 0.1; /* デフォルト消灯 */
  transition: opacity 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
}

/* 点灯状態：完全に光る */
.middle-box.active {
  opacity: 1;
  background: radial-gradient(circle at 30% 30%, #ffffff, #eeeeee); /* 明るい球体 */
  box-shadow: 
      0 2px 8px rgba(255,255,255,0.8), /* 発光感 */
      0 4px 10px rgba(0,0,0,0.4),
      inset 0 -2px 4px rgba(255,255,255,0.6);
}

/* 中央のS文字 */
.middle-symbol {
  color: red;
  font-size: 14px;
  font-family: "Saira", sans-serif;
  font-weight: 700;
  line-height: 1;
  text-align: center;
  user-select: none;
  text-shadow: 0 0 2px #fff; /* 光の反射感 */
}
/* サーバー表示終り */

.split-bottom {
  display: flex;             /* flex で中央揃え */
  justify-content: center;   /* 横中央 */
  align-items: center;       /* 縦中央 */
  height: 20px;              /* 枠の高さ */
}

/* サイドバー（#1・#5）を少し細くする */
.overlay-box:first-child,
.overlay-box:last-child {
  flex: 0.6; /* 左右を少し細くする */
}

/* 試合画面_ゲームポイント盤そのもの */
.mini-game-container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 41px;              
  height: 41px;
  margin: 0px 0px 0px 0px;  /* 上1px・右0px・下1px・左0px */
  padding: 0;
  background: black;
  border: 2px solid #fff;
  border-radius: 10px;
  box-sizing: border-box;
  position: relative;
  overflow: hidden;          /* 内部のズレを防止 */
}

/* 試合画面_ゲームポイント盤_数字 */
.mini-flip-container {
  position: relative;
  width: 100%;               /* 親の幅にフィット */
  height: 100%;              /* 親の高さにフィット */
  perspective: 800px;
  font-size: 36px;           /* 数字サイズ統一 */
  font-family: "Saira", sans-serif;
  font-weight: 700;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.mini-flipper {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.3s ease-in-out;
}

.mini-front, .mini-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  border-radius: 8px;
  background: transparent;
  text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
}

#gameAFront, #gameABack { color: #0000FF; } /* blue → #0000FF */
#gameBFront, #gameBBack { color: #008000; } /* green → #008000 */

.mini-back { transform: rotateX(180deg); }

/* 試合画面_ポイント盤数字 */
.flip-container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 120px;
  height: 110px;
  font-size: 114px;
  font-family: "Saira", sans-serif;
  font-weight: 700;
  overflow: hidden;
}

/* 数字スパンの設定 */
.front span, .back span {
  display: inline-block;
  transform-origin: center;
  transition: transform 0.25s ease-in-out;
}

/* 桁数に応じた縮尺（数字のみ対象） */
.flip-container[data-length="2"] .front span,
.flip-container[data-length="2"] .back span {
  transform: scale(0.7);
}

.flip-container[data-length="3"] .front span,
.flip-container[data-length="3"] .back span {
  transform: scale(0.5);
}

.flipper {
  position:relative;
  width:100%;
  height:100%;
  transform-style:preserve-3d;
  transition:transform 0.3s ease-in-out;
}
.front, .back {
  position:absolute;
  width:100%;
  height:100%;
  backface-visibility:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  border-radius:12px;
  background:black;
  border:2px solid #fff;
  box-sizing:border-box;
  text-shadow:-1px -1px 0 #fff,1px -1px 0 #fff,-1px 1px 0 #fff,1px 1px 0 #fff;
}

#pointAFlip .front, #pointAFlip .back { color: #0000FF; } /* blue → #0000FF */
#pointBFlip .front, #pointBFlip .back { color: #008000; } /* green → #008000 */

.back { transform: rotateX(180deg); }
.flip { transform: rotateX(-180deg); }

/* 試合画面A側（左）ポイント盤＆ポイント追加ボタン */
#pointAFlip {
  width: 90px;
  height: 106px;
  margin-right: 15px; /* 中央ゲームポイント盤との間 */
  margin-left: 0px;   /* 左端は詰める */
  margin-top: 0px;    /* 上からの距離を調整 */

  /* 立体感＋背景 */
  background: #4CAF50; /* 初期色 */
  border-radius: 12px; /* 角丸でぷっくり感 */
  box-shadow: 
    0 8px 12px rgba(0,0,0,0.3),          /* 外側影で浮き感 */
    inset 0 -4px 8px rgba(255,255,255,0.5), /* 内側ハイライト */
    inset 0 4px 8px rgba(0,0,0,0.15);      /* 内側下影で丸み強調 */

  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.3s;
}

/* 押下アニメーション */
#pointAFlip:active {
  transform: scale(0.92); /* 強めに縮む */
  box-shadow:
    0 3px 5px rgba(0,0,0,0.35),       /* 凹んだ影 */
    inset 0 4px 8px rgba(255,255,255,0.2),
    inset 0 -4px 8px rgba(0,0,0,0.2);
}

/* 試合画面_B側（右）ポイント盤＆ポイント追加ボタン */
#pointBFlip {
  width: 90px;
  height: 106px;
  margin-left: 15px; /* 中央ゲームポイント盤との間 */
  margin-right: 0px; /* 右端は詰める */
  margin-top: 0px;   /* 上からの距離を調整 */

  /* 立体感＋背景 */
  background: #FF5722; /* 初期色 */
  border-radius: 12px; /* 角丸でぷっくり感 */
  box-shadow: 
    0 8px 12px rgba(0,0,0,0.3),          /* 外側影で浮き感 */
    inset 0 -4px 8px rgba(255,255,255,0.5), /* 内側ハイライト */
    inset 0 4px 8px rgba(0,0,0,0.15);      /* 内側下影で丸み強調 */

  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.3s;
}

/* 押下アニメーション */
#pointBFlip:active {
  transform: scale(0.92); /* 強めに縮む */
  box-shadow:
    0 3px 5px rgba(0,0,0,0.35),       /* 凹んだ影 */
    inset 0 4px 8px rgba(255,255,255,0.2),
    inset 0 -4px 8px rgba(0,0,0,0.2);
}

/* 試合画面_ポイント盤内ロゴ（ぷっくりボタン） */
.rogo-text {
  display: block;
  margin: 0 auto;
  width: fit-content;
  transform: translateX(0px);
  text-align: center;

  /* ★ フォント変更 */
  font-family: 'BBH Hegarty', sans-serif;
  font-size: 17px;
  font-weight: bold;

  color: #FFFFFF;
  letter-spacing: 0px;

  /* ★ JS で上下色を変更するグラデ背景（そのまま保持） */
  background: linear-gradient(to bottom, #0000FF 50%, #008000 50%);

  padding: 2px 6px;
  border-radius: 6px;

  /* ★ ぷっくり影 */
  box-shadow:
    0 3px 6px rgba(0,0,0,0.35),
    inset 0 2px 3px rgba(255,255,255,0.25),
    inset 0 -2px 3px rgba(0,0,0,0.15);

  text-shadow: 0 1px 1px rgba(0,0,0,0.4);
  position: relative;
  top: 6px;
  cursor: pointer;

  transition:
    transform 0.12s ease,
    box-shadow 0.12s ease;
}

/* ★ホバー時：軽く浮く */
.rogo-text:hover {
  transform: translateX(1px) translateY(-1px) scale(1.00);
  box-shadow:
    0 5px 8px rgba(0,0,0,0.38),
    inset 0 2px 3px rgba(255,255,255,0.25),
    inset 0 -2px 3px rgba(0,0,0,0.15);
}

/* ★ クリック（押し込み強め） */
.rogo-text:active {
  transform: translateX(2px) translateY(1px) scale(0.90); /* ← しっかり凹む */
  box-shadow:
    0 2px 3px rgba(0,0,0,0.28),            /* 外側影を弱めてボタンが沈む */
    inset 0 4px 6px rgba(255,255,255,0.18), /* 内側上の光を少し強く */
    inset 0 -4px 6px rgba(0,0,0,0.25);      /* 内側下影を強めて凹み感UP */
}

/* 試合画面_--- サイド_ポイント積み上げ外枠 --- */
.side-bar {
  width: 26px;
  height: 106px;
  display: flex;
  flex-direction: column-reverse;
  justify-content: flex-start;
  align-items: center;
  margin: 0px 2px 0px 2px;  /* 上0px・右2px・下0px・左2px */
  border: none;
  background: transparent;
}
/* 試合画面_--- サイド_ポイントブロック --- */
.score-block {
  width: 100%;
  height: 14px;
  margin: 1px 0;
  border-radius: 4px;
  transition: all 0.3s ease-in-out;
}

/* 試合画面_得点盤用透明枠内終り */

/* 試合画面_アナウンスの共通設定 */
#showInfo,
#independentTextFrame,
#infoText {
  white-space: nowrap;     /* 折り返し禁止 */
  overflow: hidden;        /* はみ出し非表示 */
  text-overflow: ellipsis; /* 末尾を…に */
}

/* 試合画面_アナウンスベース */
#showInfo {
  font-size: 16px;
  height: 30px;
  font-weight: bold;
  text-align: center;
  margin-top: 3px;
  margin-bottom: 3px;
}

/* 試合画面アナウンス（試合画面読込み直後に表示） */
#independentTextFrame {
  position: relative;
  width: 100%;
  height: 20px;
  text-align: center;
  margin-top: 0;
  margin-bottom: 0;
  font-size: 18px;
  color: white;
  pointer-events: none;
  z-index: 10;
}

/* 試合画面_アナウンス（メイン） */
#infoText {
  font-size: 16px;
  height: 30px;
  font-weight: bold;
  text-align: center;
  margin-top: 3px;
  margin-bottom: 3px;
}

/* --- 補助エリア（ボタンや追加情報用） --- */
#extraArea {
  width: 100%;
  height: auto;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

/* 試合画面_コート用親枠始め */
.court-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 400px;
  height: 240px;
  margin: 3px auto 1px auto; /* 上1px、右auto、下1px、左auto */
  background: transparent;
  position: relative;
  box-sizing: border-box;
}

/* 左右の透明エリア */
.court-side {
  flex: 0 0 auto;
  height: 100%;
  position: relative;
  background: transparent;
  display: flex;
  justify-content: center;
  align-items: center;
  box-sizing: border-box;
}

/* コートを置く中央エリア */
.court-center {
  flex: 0 0 240px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative; /* ← これが基準になる */
}

/* 試合画面_--- コート --- */
#courtContainer{position:relative;width:100%;max-width:400px;aspect-ratio:1/1;margin:0px 5px;background:#228B22;box-sizing:border-box;transition:transform 0.5s;}
.court-line{position:absolute;background:#fff;}
.baseline-top{top:0;left:0;width:100%;height:2px;}
.baseline-bottom{bottom:0;left:0;width:100%;height:2px;}
.double-left{top:0;bottom:0;left:0;width:2px;}
.double-right{top:0;bottom:0;right:0;width:2px;}
.single-left{top:0;bottom:0;left:10%;width:2px;}
.single-right{top:0;bottom:0;right:10%;width:2px;}
.service-top{top:25%;left:10%;right:10%;height:2px;}
.service-bottom{bottom:25%;left:10%;right:10%;height:2px;}
.center-line{top:25%;height:50%;left:50%;width:2px;transform:translateX(-50%);}
.center-mark-top{top:0;left:50%;width:2px;height:10px;transform:translateX(-50%);}
.center-mark-bottom{bottom:0;left:50%;width:2px;height:10px;transform:translateX(-50%);}
.net{top:50%;left:0;right:0;height:2px;position:absolute;background:#ccc;}

/* 試合画面_--- コート内チーム名（ぷっくり・フラット版） --- */
.team-box {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 72px;
  max-width: 100%;
  height: 30px;
  line-height: 30px;
  color: #000;
  text-align: center;
  border-radius: 8px;
  font-weight: bold;
  font-size: 12px;
  pointer-events: auto;
  user-select: none;
  touch-action: none;
  font-family: "Kosugi Maru", sans-serif;

  /* 初期背景色（JSで変更可能） */
  background: #4CAF50;

  /* --- ぷっくり質感・フラット（浮かせない） --- */
  box-shadow:
    /* わずかな外側影（浮かずに輪郭強調） */
    0 0 2px rgba(0, 0, 0, 0.15),

    /* 上の白ハイライト */
    inset 0 2px 4px rgba(255, 255, 255, 0.6),

    /* 下の陰影 */
    inset 0 -2px 4px rgba(0, 0, 0, 0.15);

  /* 背景は JS が扱うので transition から外す */
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

/* --- ホバー＆指が触れる直前の軽い反応（少し拡大） --- */
.team-box:hover {
  transform: translate(-50%, -50%) scale(1.03);
  box-shadow:
    0 0 3px rgba(0, 0, 0, 0.20),
    inset 0 2px 4px rgba(255, 255, 255, 0.6),
    inset 0 -2px 4px rgba(0, 0, 0, 0.17);
}

/* --- タッチ（スマホ）用：押す直前に反応する --- */
@media (pointer: coarse) {
  .team-box:active {
    transform: translate(-50%, -50%) scale(1.03);
    box-shadow:
      0 0 3px rgba(0, 0, 0, 0.20),
      inset 0 2px 4px rgba(255, 255, 255, 0.6),
      inset 0 -2px 4px rgba(0, 0, 0, 0.17);
  }
}

/* Aチーム */
.bg-teamA {
  background: #FFFFFFE6; /* rgba(255,255,255,0.9) → #FFFFFFE6 */
}

/* Bチーム */
.bg-teamB {
  background: #FFFF00E6; /* rgba(255,255,0,0.9) → #FFFF00E6 */
}

/* 試合画面_--- コート内選手（ぷっくり・フラット版） --- */
.player-box {
  width: 72px;
  height: 30px;
  line-height: 30px;
  background: #f0f0f0;
  color: #000;
  text-align: center;
  border-radius: 8px;
  font-weight: bold;
  font-size: 13px;
  pointer-events: auto;
  position: absolute;
  transform-origin: center center;
  user-select: none;
  touch-action: none;
  font-family: "Kosugi Maru", sans-serif;

  box-shadow:
    0 0 2px rgba(0, 0, 0, 0.15),
    inset 0 2px 4px rgba(255, 255, 255, 0.6),
    inset 0 -2px 4px rgba(0, 0, 0, 0.15);

  /* 拡大と影の変化を滑らかに */
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

/* --- ホバー & タッチ前反応（近づいたら少し拡大） --- */
.player-box:hover {
  transform: scale(1.03);
  box-shadow:
    0 0 3px rgba(0, 0, 0, 0.20),
    inset 0 2px 4px rgba(255, 255, 255, 0.6),
    inset 0 -2px 4px rgba(0, 0, 0, 0.17);
}

/* --- タッチ環境用（指が触れる直前の反応） --- */
@media (pointer: coarse) {
  .player-box:active {
    transform: scale(1.03);
    box-shadow:
      0 0 3px rgba(0, 0, 0, 0.20),
      inset 0 2px 4px rgba(255, 255, 255, 0.6),
      inset 0 -2px 4px rgba(0, 0, 0, 0.17);
  }
}

/* Aチーム選手 */
.player-box.teamA {
  background: #FFFFFFE6; /* rgba(255,255,255,0.9) → #FFFFFFE6 */
}

/* Bチーム選手 */
.player-box.teamB {
  background: #FFFF00E6; /* rgba(255,255,0,0.9) → #FFFF00E6 */
}

/* 左右の回転ボタン領域 */
#courtSideLeft,
#courtSideRight {
  width: 50px;
  height: 230px;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: auto;
  z-index: 5;
}

#courtSideLeft { left: 1px; }
#courtSideRight { right: 1px; }

/* 左右ボタン共通デザイン：枠のみ透明 */
#courtSideLeft button,
#courtSideRight button {
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.05); /* ← 背景の薄い白は残す */
  border: 2px dashed transparent;        /* ← 枠を完全透明にする */
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

/* hover時の変化（背景のみ強調、枠は透明のまま） */
#courtSideLeft button:hover,
#courtSideRight button:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: transparent;
}

/* デフォルトボタン（中央） */
#courtSideDefault {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 40px;
  height: 40px;
  margin: auto;
}

/* デフォルトボタン共通デザイン：枠を透明に */
#courtSideDefault button {
  width: 100%;
  height: 100%;
  border: 2px solid transparent;      /* ← 枠を透明に */
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1); /* ← 背景の淡い白は残す */
  cursor: pointer;
  transition: 0.3s;
}

/* hover時：背景だけ明るく、枠は透明のまま */
#courtSideDefault button:hover {
  background: rgba(255, 255, 255, 0.25);
  border-color: transparent;
}

/* 試合画面_コート用親枠終り */

/* 左右入れ替え時（コートが左に90°回転） */
#outerContainer.swapped {
  flex-direction: row-reverse !important;
}

/* ------------------- チーム名と選手名背景色変更スクロールバー始り ------------------- */
.team-picker-wrapper {
  width: 330px;
  height: 30px;
  margin: 2px auto;
  overflow-x: hidden;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
  border-radius: 10px;
  border: 2px solid #fff;
  background: #222;
  position: relative;
}

.team-picker-item {
  height: 30px;
  position: relative;
  scroll-snap-align: center;
  margin: 0;
  border-radius: 6px;
  overflow: hidden;
  transition: transform 0.3s;
}

.team-picker-item.center {
  transform: scale(1.22);
  border: 2px solid #fff;
}

.team-scroll-bgA, .team-scroll-bgB {
  position: absolute;
  top: 0; bottom: 0;
  width: 50%;
}
.team-scroll-bgA { left: 0; }
.team-scroll-bgB { right: 0; }

.team-scroll-labelA, .team-scroll-labelB {
  position: absolute;
  top: 0; bottom: 0;
  line-height: 30px;
  font-weight: bold;
  font-size: 12px;
  color: #000;
  pointer-events: none;
  font-family: "Kosugi Maru", sans-serif; /* フォント追加 */
}
.team-scroll-labelA { left: 4%; width: 50%; text-align: center; }
.team-scroll-labelB { left: 46%; width: 50%; text-align: center; }

.team-picker-wrapper::-webkit-scrollbar { display: none; }

:root {
  --teamB-bg-color: #ffd0ff;
}

body::after {
  content: "";
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: env(safe-area-inset-bottom);
  background: var(--teamB-bg-color);
  z-index: 999;
  pointer-events: none;
}

/* ------------------- チーム名と選手名背景色変更スクロールバー終り ------------------- */

/* ------------------- 得点盤文字色とロゴ背景色の変更始り（中央修正） ------------------- */
.scorePicker-wrap {
  width: 330px;
  height: 30px;
  margin: 2px auto;
  overflow-x: hidden;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
  border-radius:10px;
  border: 2px solid #fff;
  background:#222;
  font-family: "Saira", sans-serif;
  position:relative;
  padding-top: 0;
  padding-bottom: 0;
}

.scorePicker-item {
  height: 30px;
  scroll-snap-align: center;
  position:relative;
  margin:0;
  border-radius:6px;
  overflow:hidden;
  transition: transform .22s;
}

.scorePicker-item.center {
  transform: scale(1.22);
  border:1px solid #fff;
}

/* 背景左右 */
.scorePicker-bgA, .scorePicker-bgB {
  position:absolute; top:0; bottom:0; width:50%;
}
.scorePicker-bgA { left:0; }
.scorePicker-bgB { right:0; }

/* ラベル左右：中央の白線が正しく中央に来るよう調整 */
.scorePicker-labelA, .scorePicker-labelB {
  position:absolute;
  top:0; bottom:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  border:1px solid #fff;
  box-sizing:border-box;
  font-weight:900;
  z-index:8;
  pointer-events:none;
  width:50%;
}

/* 左右ぴったり半分に分割 */
.scorePicker-labelA { left:0; }
.scorePicker-labelB { right:0; }

/* 数字部分（変形・縁取り） */
.scorePicker-labelA span, .scorePicker-labelB span {
  font-size:30px;
  transform-origin:center;
  display:inline-block;
  transform: scaleX(2.8) scaleY(0.68);
  line-height:1;
  text-shadow:
    0.6px 0.6px 0 #fff,
    -0.6px -0.6px 0 #fff,
    0.6px -0.6px 0 #fff,
    -0.6px 0.6px 0 #fff;
  padding:2px 6px;
  border-radius:4px;
}

.scorePicker-wrap::-webkit-scrollbar { display:none; }

/* ------------------- 中央拡大時の文字位置ズレ補正（追加部分） ------------------- */
.scorePicker-item.center .scorePicker-labelA span {
  transform: translateX(50%) scaleX(2.8) scaleY(0.68);
}

.scorePicker-item.center .scorePicker-labelB span {
  transform: translateX(-50%) scaleX(2.8) scaleY(0.68);
}
/* ------------------- 得点盤文字色とロゴ背景色の変更終り（中央修正） ------------------- */

/* ------------------- 背景とコートの色（始り） ------------------- */
.picker-wrapper {
  width: 330px;
  height: 30px;
  margin: 2px auto;
  overflow-x: hidden;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
  border-radius: 10px;
  border: 2px solid #fff;
  background: #222;
  position: relative;
}

.picker-item {
  height: 30px;
  position: relative;
  scroll-snap-align: center;
  margin: 0;
  border-radius: 6px;
  overflow: hidden;
  transition: transform 0.3s;
}

.picker-item.center {
  transform: scale(1.22);
  border: 2px solid #fff;
}

/* 背景レイヤー */
.bg-court, .bg-out {
  position: absolute;
  top: 0; bottom: 0;
}
.bg-court { left: 0; width: 65%; }
.bg-out { right: 0; width: 35%; }

/* 白線 */
.divider, .divider-left {
  position: absolute;
  top: 0; bottom: 0;
  width: 5px;
  background: #fff;
}
.divider { right: 35%; }
.divider-left { left: 159px; }

/* 文字レイヤー（ノーマルに変更） */
.label-court, .label-out {
  position: absolute;
  top: 0; bottom: 0;
  line-height: 30px;
  font-weight: bold;
  font-size: 12px;
  color: #fff;
  pointer-events: none;
  text-shadow: none; /* 影なし */
  font-family: "Kosugi Maru", sans-serif; /* フォント追加 */
}
.label-court { left: 0; width: 60%; text-align: center; }
.label-out { left: 56%; right: 0; text-align: center; }

.picker-wrapper::-webkit-scrollbar { display: none; }

:root {
  --out-color: #2E8B57; /* 初期アウト色 */
}

body::after {
  content: "";
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: env(safe-area-inset-bottom);
  background: var(--out-color);
  z-index: 999;
  pointer-events: none;
}
/* ------------------- 背景とコートの色（終り） ------------------- */

/* ------------------- お気に入りスクロールバー ------------------- */
.favorites-picker-wrapper {
  width: 330px;
  height: 30px;
  margin: 2px auto;
  overflow-y: scroll;
  scrollbar-width: none;
  -ms-overflow-style: none;
  border-radius: 10px;
  border: 2px solid #fff;
  background: #222;
  scroll-snap-type: y mandatory;
  position: relative;
  scroll-behavior: smooth;
}

.favorites-picker-wrapper::-webkit-scrollbar {
  width: 0;
  background: transparent;
}

.favorites-picker-item {
  display: flex;
  height: 30px;
  line-height: 30px;
  font-size: 10px;
  font-family: "Kosugi Maru", sans-serif;
  text-align: center;
  cursor: pointer;
  scroll-snap-align: center;
  position: relative;
  transition: transform 0.2s;

}

.favorites-picker-item span.number {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: rgba(255,255,255,0.3);
  font-weight: normal;
  pointer-events: none;
  font-size: 16px;
}

.favorites-picker-item.active span.number {
  color: #fff;
  font-weight: bold;
}

.fav-color {
  flex: 0 0 16.6666%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Kosugi Maru', sans-serif;
  background: #444;
}

.fav-color.left { color: #000; }
.fav-color.middle { background: #000; font-weight: bold; }
.fav-color.right { color: #fff; }
.fav-color.middle span { color: inherit; }

/* 左から3番目と4番目の文字（A と D）横長＆白縁 */
.favorites-picker-item > .fav-color:nth-of-type(3) span,
.favorites-picker-item > .fav-color:nth-of-type(4) span {
  font-family: 'Saira', sans-serif;
  font-size: 16px;
  transform: scaleX(1.8);
  white-space: nowrap;

  color: inherit;

  /* 白縁を細く（0.5px） */
  -webkit-text-stroke: 0.5px #ffffff;
}

/* 左から5番目と6番目（イン・アウト）は白固定 */
.favorites-picker-item > .fav-color:nth-of-type(5) span,
.favorites-picker-item > .fav-color:nth-of-type(6) span {
  color: #fff !important;
}

/* タブレット長押し保存対応用 */
#favoritesPicker {
  touch-action: pan-y;
}

/* ------------------- お気に入りスクロールバー終り ------------------- */

/* リセットボタン（ぷっくり水色） */
.reset-btn {
  width: 161px;
  height: 36px;
  flex: 0 0 auto;
  min-width: 120px;
  max-width: 180px;
  padding: 2px;
  margin: 1px 0;
  font-size: 18px;
  border-radius: 12px; /* 角丸強めでぷっくり感 */
  font-weight: bold;
  border: none;
  color: #ffffff; /* 白文字 */
  text-align: center;
  font-family: "Kosugi Maru", sans-serif;
  cursor: pointer;

  /* ぷっくり浮き出た感じ */
  background: linear-gradient(to bottom, #a0dfff, #5eb8ff);
  box-shadow: 
    0 4px 6px rgba(0, 0, 0, 0.25),        /* 外側影で浮き感 */
    inset 0 2px 4px rgba(255,255,255,0.3), /* 内側上ハイライト */
    inset 0 -2px 4px rgba(0,0,0,0.15);     /* 内側下影で丸み強調 */

  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

.reset-btn:hover {
  background: linear-gradient(to bottom, #87cefa, #5eb8ff);
  box-shadow: 
    0 5px 8px rgba(0, 0, 0, 0.3),
    inset 0 2px 4px rgba(255,255,255,0.3),
    inset 0 -2px 4px rgba(0,0,0,0.15);
}

.reset-btn:active {
  background: linear-gradient(to bottom, #5eb8ff, #3a9fff);

  /* 押し込み感を強く */
  transform: translateY(3px); /* ← 1px → 3px に増量 */
  
  /* 外側影を薄く、内側影で凹みを表現 */
  box-shadow: 
    0 1px 2px rgba(0, 0, 0, 0.2) inset,
    inset 0 1px 2px rgba(255,255,255,0.2),
    inset 0 -2px 4px rgba(0,0,0,0.25);
}

/* 設定画面に戻るボタン（ぷっくりオレンジ） */
.settings-btn {
  width: 161px;
  height: 36px;
  flex: 0 0 auto;
  min-width: 120px;
  max-width: 180px;
  padding: 2px;
  margin: 1px 0;
  font-size: 18px;
  border-radius: 12px; /* 丸み強めでぷっくり感 */
  font-weight: bold;
  border: none;
  color: #ffffff; /* 白文字 */
  text-align: center;
  font-family: "Kosugi Maru", sans-serif;
  cursor: pointer;

  /* ぷっくり浮き出た感じ */
  background: linear-gradient(to bottom, #ffca7a, #ff8c00);
  box-shadow: 
    0 4px 6px rgba(0, 0, 0, 0.25),        /* 外側影で浮き感 */
    inset 0 2px 4px rgba(255,255,255,0.3), /* 内側上ハイライト */
    inset 0 -2px 4px rgba(0,0,0,0.15);     /* 内側下影で丸み強調 */

  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

.settings-btn:hover {
  background: linear-gradient(to bottom, #ffb84d, #ff7f00);
  box-shadow: 
    0 5px 8px rgba(0, 0, 0, 0.3),
    inset 0 2px 4px rgba(255,255,255,0.3),
    inset 0 -2px 4px rgba(0,0,0,0.15);
}

.settings-btn:active {
  background: linear-gradient(to bottom, #ff8c00, #ff6a00);

  /* 押し込み感を強化 */
  transform: translateY(3px); /* ← 1px → 3px に増量 */
  
  /* 内側影を強めて凹みを強調 */
  box-shadow: 
    0 1px 2px rgba(0, 0, 0, 0.2) inset,
    inset 0 1px 2px rgba(255,255,255,0.2),
    inset 0 -2px 4px rgba(0,0,0,0.25);
}

/* 透明枠ボタン用の共通クラス(予備) */
.extraControls {
  text-align: center;   /* 中央揃え */
  margin-top: 4px;      /* 上余白 */
  background: transparent; /* 背景を透明 */
}

/* ===== 上から舞い落ちる紙吹雪（回転ランダム／サイン波揺れ／長時間版） ===== */
.confetti {
  position: fixed;
  top: -10px;
  width: 10px;
  height: 10px;
  opacity: 0.9;
  border-radius: 2px;
  pointer-events: none;
  z-index: 9999;
  animation: confettiFall linear forwards;
}

/* 🎐 落下中にサイン波の横揺れと回転ランダムを加える */
@keyframes confettiFall {
  0% {
    transform: translateX(0) translateY(0) rotate(var(--start-rotate));
    opacity: 1;
  }
  100% {
    transform: translateX(calc(var(--drift) + sin(var(--t) * 3.1415) * var(--wind) * 1vw))
               translateY(100vh)
               rotate(calc(var(--start-rotate) + var(--rotate-speed) * 1turn));
    opacity: 0.8;
  }
}

</style>
</head>

<body>

<!-- スケーリング対応 -->
<div id="appScaleWrapper">

  <!-- アプリタイトル表示 -->
  <div id="titleWrapper" style="display:flex;"> <!-- 初期は表示 -->
    <div id="titleScreen" style="
      display:flex; 
      justify-content:center; 
      align-items:center; 
      width:100%; 
      height:100dvh; 
      text-align:center; 
      background: linear-gradient(-45deg, #004d00, #006400, #008000, #006400); 
      background-size: 400% 400%; 
      animation: gradientBG 15s ease infinite;
    ">
      <!-- 初期は空、JSで会社名→タイトル→Smash!!!!を挿入 -->
    </div>
  </div>

<div class="setup-block">
  <div class="container" id="setupScreen">

    <!-- タイトル + ヘルプボタン -->
    <div class="setup-header">
      <span id="setupInfoText" class="setup-title">▲▽▲▽▲▽▲ 設定画面 ▲▽▲▽▲▽▲</span>
      <button id="helpButtonFooter" class="help-footer-btn" aria-label="インフォメーション">i</button>

    </div>

    <div id="setupSubFrame">
      <span id="setupHintTextTop" class="blink-text" style="font-size:16px; color:white;">
        大会名・チーム名・選手名等を入力・保存・呼出
      </span>
    </div>

<div class="tournament-wrapper">
  <input type="text" id="tournamentNameInput" maxlength="20" placeholder="大会名">
</div>

<div class="tournament-buttons-row">
  <!-- ▽ 保存ボタン -->
  <button id="saveTournamentButton" class="save-tournament-btn">▽ 保存</button>

  <!-- 大会名初期化ボタン -->
  <button id="resetTournamentButton" class="reset-tournament">初期化</button>
</div>

<div class="tournament-save-wrapper">
  <select id="tournamentList" class="tournament-select">
    <option value="">-- 大会名を選択 --</option>
  </select>

  <button id="loadTournamentButton" class="tournament-btn">▲</button>
</div>

    <button onclick="deleteSelectedOption('tournamentList', saveTournamentsToLocalStorage)"
      class="delete-button">
      大会名削除
    </button>

    <div class="team-inputs-wrapper">
      <div class="team-inputs">

        <!-- Aチーム -->
        <div class="team-column">
          <input type="text" id="teamA" maxlength="10" placeholder="Aチーム名">
          <input type="text" id="playerA1" maxlength="10" placeholder="A選手1">
          <input type="text" id="playerA2" maxlength="10" placeholder="A選手2">
        </div>

        <!-- Bチーム -->
        <div class="team-column">
          <input type="text" id="teamB" maxlength="10" placeholder="Bチーム名">
          <input type="text" id="playerB1" maxlength="10" placeholder="B選手1">
          <input type="text" id="playerB2" maxlength="10" placeholder="B選手2">
        </div>

      </div>

      <!-- ★ チーム保存・初期化（4ボタン横並び） -->
      <div class="team-buttons-row">
        <button onclick="saveTeam('A')"
          class="button-base button-small save-button">▽ 保存</button>

        <button id="resetTeamAButton"
        class="reset-button reset-team small">
  初期化
</button>

        <button onclick="saveTeam('B')"
          class="button-base button-small save-button">▽ 保存</button>

        <button id="resetTeamBButton"
        class="reset-button reset-team small">
  初期化
</button>

      </div>
    </div>

    <div class="team-restore-wrapper">
      <div class="team-restore-row">
        <button onclick="applyToTeam('A')" class="team-restore-btn">▲</button>

        <select id="teamList" class="team-restore-select">
          <option value="">-- チーム・ペアを選択 --</option>
        </select>

        <button onclick="applyToTeam('B')" class="team-restore-btn">▲</button>
      </div>
    </div>

    <button onclick="deleteSelectedOption('teamList', saveTeamsToLocalStorage)"
      class="delete-button">
      チーム・ペア削除
    </button>

    <div id="setupMessageFrame"></div>
    <span id="setupHintTextBottom">
      何ゲームマッチか選び[ 試合開始 ]をタップ
    </span>

    <div class="select-wrapper">
      <select id="matchTypeSelect" class="match-type-select">
        <option value="3">3ゲームマッチ（2ｹﾞｰﾑ先取）</option>
        <option value="5" selected>5ゲームマッチ（3ｹﾞｰﾑ先取）</option>
        <option value="7">7ゲームマッチ（4ｹﾞｰﾑ先取）</option>
        <option value="9">9ゲームマッチ（5ｹﾞｰﾑ先取）</option>
      </select>
    </div>

    <div class="start-wrapper">
      <button class="start-btn" onclick="startMatch()">試合開始</button>
    </div>

<!-- アプリURLコピー（コンパクト・ラベル付き） -->
<div class="share-url-wrapper-compact">
  <span class="share-label">アプリURLを友達と共有：</span>
  <input type="text" id="appURL" value="https://tok-dot.github.io" readonly>
  <button id="copyURL">コピー</button>
</div>

<!-- シンプルOKダイアログ -->
<div id="simpleAlertDialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
  <div style="background:#fff; padding:16px 24px; border-radius:8px; text-align:center; min-width:180px;">
    <div id="simpleAlertMessage" style="margin-bottom:12px; font-size:14px; color:#333;"></div>
    <button onclick="simpleAlertOK()" style="padding:6px 12px; font-size:12px; border:none; border-radius:4px; background:#2a5298; color:#fff; cursor:pointer;">OK</button>
  </div>
</div>

<!-- 著作権関連表示 -->
<div id="settingsFooter">
  © 2025-2026 Tok.DoT / Hiroki Sato. All rights reserved.
</div>

<!-- 利用規約ダイアログ -->
<div id="termsDialog" class="modal">
  <div class="modal-content">
    <button class="close">✕</button>
    <h2>Smash!!!! 利用規約</h2>
    <div class="modal-body">
      <p>
  最終更新日：2025年12月25日<br><br>

  本規約は、Smash!!!!（以下「本アプリ」）の利用条件を定めるものです。<br>
  本アプリを利用することで、本規約に同意したものとみなします。<br><br>

  <strong>1. 利用条件</strong><br>
  本アプリは、個人での応援や部活動のサポートなど、応援目的で無料で自由にご利用いただけます。<br>
  商用利用、再配布、改変はご遠慮ください。<br>
  <em>禁止行為の例：</em><br>
  - 不正アクセスや不正な改ざん行為<br>
  - 他の利用者に迷惑をかける行為<br>
  - 法律・公序良俗に反する行為<br><br>
        <strong>2. 著作権</strong><br>
        本アプリの著作権は、Tok.DoT / Hiroki Satoに帰属します。<br>
        © 2025–2026 Tok.DoT / Hiroki Sato. All Rights Reserved.<br><br>

        <strong>3. 免責事項</strong><br>
        - 本アプリの利用によって生じたいかなる損害についても、運営者は一切責任を負いません。<br>
        - 本アプリの内容は、予告なく変更・停止・終了される場合があります。<br>
        - 本アプリの情報は参考目的で提供しており、正確性を保証するものではありません。<br><br>

        <strong>4. ユーザーの責任</strong><br>
        - 利用者は、自身の端末やデータの管理を自己責任で行ってください。<br>
        - 本アプリを使用した際のトラブルや誤操作について、運営者は責任を負いません。<br><br>

        <strong>5. プライバシー</strong><br>
        - 本アプリは個人情報を保存しません。<br>
        - 匿名のアクセス情報を収集する場合があります（アナリティクス利用）。<br><br>

        <strong>6. 改訂</strong><br>
        - 本利用規約は、予告なく改訂されることがあります。<br>
        - 最新版は本アプリ内で確認できます。<br><br>

        <strong>7. 任意の支援について</strong><br>
        - 本アプリでは、任意で開発者を支援できるリンク（OFUSE）を設置しています。<br>
        - 支援は完全に自由であり、利用や登録は不要です。
      </p>
    </div>
  </div>
</div>

<!-- 著作権関連表示 -->

<!-- OFUSE設置設定画面用（フッター・トリガーのみ） -->

<!-- OFUSEボタン（フッター左側に設置） -->
<section class="support-section">
  <a href="#" id="openSupportModal">OFUSEで応援する</a>
</section>

<!-- 応援モーダル -->
<div id="supportModal" class="support-modal" aria-hidden="true">
  <div class="support-modal-content">
    <p>
      このスコアボードアプリは、<br>無料でご利用いただけます。<br>
      もし役に立ったと感じていただけたら、<br>
      開発の励みになりますので<br>
      <a href="https://ofuse.me/tokdot" target="_blank" rel="noopener">
        OFUSEで応援する
      </a>
      をお願いします。
    </p>

    <button class="support-close" type="button">閉じる</button>
  </div>
</div>
<!-- OFUSE設置 -->

<!-- 設定画面 インフォメーションモーダル -->
<div id="helpModal" class="help-modal" aria-hidden="true">
  <div class="help-modal-content">

    <h2>インフォメーション</h2>

    <div class="modal-body">

      <h3>はじめての方へ</h3>
      <p>
        Smash!!!! は、インターネットを使って動作するアプリです。
        スマートフォンのブラウザから「ホーム画面に追加」（iPhone・Androidともに対応）すると、
        他のアプリと同じように、アイコンをタップして起動できます。
      </p>

      <h3>このアプリについて</h3>
      <p>
        このアプリは、ソフトテニス ダブルスマッチの観戦をどなたでも気軽に楽しめるように作られています。
        特にソフトテニスの試合ではスコアボードが無いことも多く、
        「今の得点はどうなっているの？」と分かりにくい場面があります。
      </p>
      <p>
        このアプリは、観戦しながら得点を記録するだけで、
        試合の流れや状況が自然に分かるように設計しています。
        難しい操作はありませんので、スマートフォンに不慣れな方でも安心してお使いいただけます。
      </p>

      <p class="note">
        ※ 公式な記録を残すものではありません。観戦や応援を楽しむための補助ツールです。
      </p>

      <h3>設定画面について</h3>
      <p>
        設定画面では、試合のゲームマッチ数を確認し、［試合開始］ボタンを押すだけで準備が完了します。
        最初に大会名やチーム・ペア名を入力すると、観戦がより楽しめます。
      </p>

      <h3>大会名の入力・保存</h3>
      <ul>
        <li>「大会名」欄に大会名を入力</li>
        <li>▽ 保存ボタンで端末に保存</li>
        <li>保存した大会名は ▲ 呼び出しボタンで再入力できます</li>
        <li>初期化ボタンで入力内容を消せます</li>
      </ul>

      <h3>チーム・選手名の入力・保存</h3>
      <ul>
        <li>Aチーム・Bチームの名前や選手名を入力</li>
        <li>▽ 保存ボタンで端末に保存</li>
        <li>保存したチームやペアは ▲ 呼び出しボタンで再入力できます</li>
        <li>初期化ボタンで入力内容を消せます</li>
      </ul>

      <p class="note">
        ※ 保存した内容を削除する場合は、一覧から選択して削除してください。
      </p>

      <h3>ゲームマッチ数の選択</h3>
      <ul>
        <li>試合のゲームマッチ数を一覧から選択</li>
        <li>［試合開始］ボタンで試合を始められます</li>
      </ul>

      <h3>ひとこと</h3>
      <p>
        操作に迷ったときは、端末の戻るボタンでリロード（アプリの再起動）して最初からやり直しても問題ありません。
        ご自身のペースでゆっくりお使いください。
      </p>

    </div>

    <button class="help-close" type="button" id="closeHelp">閉じる</button>
  </div>
</div>

</div> <!-- setupScreen閉じ -->
</div> <!-- setup-block閉じ -->

<!-- 試合画面トップ -->
<div class="container" id="gameScreen" style="display:none;">
  <div id="topBar" style="text-align:center;">

<!-- 試合画面用 インフォメーションボタン -->
<button
  id="matchInfoButton"
  class="match-info-btn"
  aria-label="インフォメーション">
  i
</button>

<!-- ================== お天気と日時 ================== -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">

<div id="dateWeatherContainer">
    <!-- 日時 -->
    <div id="safeDateTimeBox"></div>

    <!-- 天気（クリックで住所入力） -->
    <div id="weatherBox" style="cursor:pointer;"></div>
</div>

<!-- 住所入力モーダル -->
<div id="addressModal">
    <div id="addressModalContent">
        <p>住所を入力し検索してください</p>
        <input type="text" id="addressInput" placeholder="例：福島県 / 福島県福島市">
        <div id="modalButtons" style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:10px;">
            <button id="addressSearchBtn" style="background-color:#4CAF50; color:white; border:none; padding:6px 12px; border-radius:4px;">検索</button>
            <button id="addressConfirmBtn" disabled style="background-color:#008CBA; color:white; border:none; padding:6px 12px; border-radius:4px;">決定</button>
            <button id="addressCancelBtn" style="background-color:#f44336; color:white; border:none; padding:6px 12px; border-radius:4px;">キャンセル</button>
        </div>
        <div id="resolvedAddress" style="
            margin-top:10px;
            padding-top:6px;
            font-size:12px;
            color:#000080;
            line-height:1.4;
            border-top:1px solid rgba(0,0,0,0.15);
        "></div>
    </div>
</div>
<!-- ================== お天気と日時 ================== -->

<!-- 試合画面大会名表示 -->
<div id="tournamentDisplay"></div>

<!-- 試合画面チーム名とペア名表示 -->
<div id="centerWrapper">
  <div id="outerContainer">
    
    <div id="teamAInfo">
      <div style="text-align:center;">
        <div class="team-name-display bg-teamA" id="displayTeamA">Aチーム</div>
        <div style="height:0px;"></div>
        <p class="pair-name" id="pairA">選手1・選手2ペア</p>
      </div>
    </div>

    <!-- 透明枠にvs（レディ）ボタン -->
    <div class="ready-container">
      <button id="readyButton" class="ready-btn">vs</button>
    </div>

    <div id="teamBInfo">
      <div style="text-align:center;">
        <div class="team-name-display bg-teamB" id="displayTeamB">Bチーム</div>
        <div style="height:0px;"></div>
        <p class="pair-name" id="pairB">選手1・選手2ペア</p>
      </div>
    </div>

  </div>
</div>

<!-- ファイナル表示の固定枠（透明） -->
<div id="finalDisplayWrapper">
    <div id="finalDisplay" class="display-fixed"></div>
</div>

<!-- 試合画面ジャッジ表示 -->
  <div id="deuceDisplay" class="display-fixed"></div>

 <div id="extraArea">
  <!-- ここに追加の要素が入る -->
</div>

<!-- 得点盤用の透明枠始め -->
<div class="overlay-scale-wrapper">
<div id="overlay-wrapper">
    <div class="overlay-frame">
      <!-- #1 -->
      <div class="overlay-box">
      <div class="overlay-inner" style="margin-top:15px;">
      <div class="side-bar" id="barA"></div>
      </div></div>
      <!-- #2 -->
      <div class="overlay-box">
      <div class="overlay-inner" style="margin-top:15px;">
      <div class="points-container">
      <div class="flip-container" id="pointAFlip">
      <div class="flipper">
      <div class="front"><span>0</span></div>
      <div class="back"><span>0</span></div>
      </div></div></div></div></div>
      <!-- #3（上下分割） -->
      <div class="overlay-box split-box">
      <!-- #3a 上段：A側ゲームポイント盤 -->
      <div class="split-top">
      <div class="overlay-inner" style="margin-top:20px;">
      <div class="mini-game-container">
      <div class="mini-flip-container">
      <div class="mini-flipper">
      <div class="mini-front" id="gameAFront">0</div>
      <div class="mini-back" id="gameABack">0</div>
      </div></div></div></div>
      <!-- #3a 上段：B側ゲームポイント盤 -->
      <div class="overlay-inner" style="margin-top:20px;">
      <div class="mini-game-container">
      <div class="mini-flip-container">
      <div class="mini-flipper">
      <div class="mini-front" id="gameBFront">0</div>
      <div class="mini-back" id="gameBBack">0</div>
      </div></div></div></div></div>
      <!-- #3c 中段：サーバー表示 -->
      <div class="split-middle">
      <div class="overlay-inner">
      <div class="middle-frame">
      <div class="middle-box left">
      <span class="middle-symbol">S</span>
      </div>
      <div class="middle-box right">
      <span class="middle-symbol">S</span>
      </div></div></div></div>
      <!-- #3b 下段：ロゴテキスト用 -->
      <div class="split-bottom">
      <div class="overlay-inner" style="margin-top:0px;">
      <div class="rogo-text" onclick="undoPoint(event)">Tok<span style="color:#FF8C00;">.</span>DoT</div>
      </div></div></div>
      <!-- #4 -->
      <div class="overlay-box">
      <div class="overlay-inner" style="margin-top:15px;">
      <div class="points-container">
      <div class="flip-container" id="pointBFlip">
      <div class="flipper">
      <div class="front"><span>0</span></div>
      <div class="back"><span>0</span></div>
      </div></div></div></div></div>
      <!-- #5 -->
      <div class="overlay-box">
      <div class="overlay-inner" style="margin-top:15px;">
      <div class="side-bar" id="barB"></div>
      </div></div></div></div>
      </div>
<!-- 得点盤用の透明枠終り -->

<div id="independentTextFrame">
  <span id="infoText" class="blink-text">
    ① サーバーをタップ → ② [ vs ]をタップ
  </span>
</div>

<!-- コート用親枠 -->
<div class="court-wrapper">

  <!-- 左側の透明ブロック -->
  <div class="court-side left-side">
    <!-- コート左に90度回転ボタン -->
    <div id="courtSideLeft">
      <button></button>
    </div>
  </div>

  <!-- 中央（コートを配置する枠） -->
  <div class="court-center">
    <div id="courtContainer">

      <div class="court-line baseline-top"></div>
      <div class="court-line baseline-bottom"></div>
      <div class="court-line double-left"></div>
      <div class="court-line double-right"></div>
      <div class="court-line single-left"></div>
      <div class="court-line single-right"></div>
      <div class="court-line service-top"></div>
      <div class="court-line service-bottom"></div>
      <div class="court-line center-line"></div>
      <div class="court-line center-mark-top"></div>
      <div class="court-line center-mark-bottom"></div>
      <div class="court-line net"></div>

      <!-- 選手ボックス -->
      <div id="playerA1Display" class="player-box bg-teamA"></div>
      <div id="playerA2Display" class="player-box bg-teamA"></div>
      <div id="playerB1Display" class="player-box bg-teamB"></div>
      <div id="playerB2Display" class="player-box bg-teamB"></div>

      <!-- コート内チーム名 -->
      <div id="courtTeamA" class="team-box bg-teamA"></div>
      <div id="courtTeamB" class="team-box bg-teamB"></div>

      <!-- コート回転デフォルトボタン -->
      <div id="courtSideDefault">
        <button onclick="resetCourtRotation()"></button>
      </div>
    </div>
  </div>

  <!-- 右側の透明ブロック -->
  <div class="court-side right-side">
    <!-- コート右に90度回転ボタン -->
    <div id="courtSideRight">
      <button></button>
    </div>
  </div>

</div>

<!-- チーム名と選手名の背景色の変更 -->
<div class="team-picker-wrapper" id="teamPicker"></div>

<!-- 得点盤文字色とロゴ背景色の変更 -->
<div class="scorePicker-wrap" id="scorePickerCustom"></div>

<!-- 背景色とコート色の変更 -->
<div class="picker-wrapper" id="picker"></div>

 <!-- お気に入りスクロールバー -->
  <div class="favorites-picker-wrapper" id="favoritesPicker"></div>

<div class="controls-container" style="display:flex; align-items:center; gap:10px; justify-content:center;">

<button class="reset-btn" onclick="resetMatch()">リセット</button>

<button class="settings-btn" onclick="returnToSetup()">設定</button>

</div>
<div class="extraControls">
</div>

<!-- コート上に余白 -->
<div id="extraAreaTop" style="width:100%; height:20px; display:flex; justify-content:center; align-items:center; gap:5px;">
</div>

<!-- コート下に余白 -->
<div id="extraAreaBottom" style="width:100%; height:20px;"></div>

<!-- 試合画面用 インフォメーションモーダル -->
<div id="matchInfoModal" class="help-modal" aria-hidden="true">
  <div class="help-modal-content">

    <h2>インフォメーション</h2>

    <div class="modal-body">

      <h3>試合画面について</h3>

      <h4>◎ ゲーム開始前にやること</h4>

      <p><strong>□ 観戦場所とチームの位置を合わせる</strong><br>
      観戦する場所を基準に、チームの位置（コートを回転）を調整します。</p>

      <p><strong>□ 選手のポジションを合わせる</strong><br>
      コート内のチームをタップして変更します。<br>
      ※ ゲーム中もポジションの変更は可能です。</p>

      <p><strong>□ サーバーをタップ</strong><br>
      コート内の選手（デュースサイドにいる選手）をタップして、最初のサービスサイド（サーブ側）を設定します。</p>

      <h4>◎ ゲームが開始されたら</h4>

      <p><strong>□ [ vs ] ボタンをタップ</strong><br>
      両チーム・ペア名の間にある [ vs ]（対戦）ボタンをタップします。<br>
      ※ この操作で試合が開始されます。
      </p>

      <p class="note">
        ※ ポイント0-0・ゲームカウント0-0時点はサーバーの変更が可能です。<br>
        ※ ゲーム中（1ポイント以上入ると）は、サーバーを変更できません。
      </p>

      <p><strong>ポイントの追加</strong><br>
      ・ポイント盤をタップしてポイントを追加します。</p>

      <p><strong>ポイントを戻す</strong><br>
      ・[ Tok.DoT ] のロゴをタップしてポイントを戻します。</p>

      <p class="note">
        ※ ポイント0-0・ゲームカウント0-0まで戻ると、リセットボタンと同様にスコアボードが消灯します。
      </p>

      <p><strong>サービスサイドチームの点灯</strong><br>
      ・サービスサイドチームのⓢボール（サーブ権を持つチームの目印）が点灯します。</p>

      <p><strong>コート回転</strong><br>
      ・コートサイド（両サイド）をタップして回転します。</p>

      <p><strong>コート回転のリセット</strong><br>
      ・コートの中央をタップしてデフォルト位置に戻します。</p>

      <p><strong>試合画面のリセット</strong><br>
      ・[ リセット ] ボタンでゲーム開始前の状態に戻ります。</p>

      <p><strong>設定画面に戻る</strong><br>
      ・[ 設定 ] ボタンで設定画面に戻ります。</p>

      <p class="match-note">
        ※ ポイント・ゲームカウントはリセットされます。
      </p>

      <h4>◎ より楽しく応援するために</h4>

      <p><strong>試合画面のカスタマイズ</strong><br>
      コート下にあるフリックスクロールバーを回して、試合画面の色や表示をカスタマイズできます。</p>

      <p><strong>お気に入りの保存</strong><br>
      ・フリックスクロールバーの一番下（★の下、①～⑤）にお気に入りを保存できます。<br>
      ・スクロールバーを長押し（約3秒以上）すると保存されます。<br>
      ・既に保存されている場合は上書きされます。</p>

      <p class="note">
        ※ ★は本アプリのデフォルト設定です。保存できません。<br>
        ※ お気に入りスクロールバーは、アプリ起動直後、フリックすると一度だけ回転します<br>
        ※ 一部端末（主にタブレット等）では長押し保存機能が使えない場合があります。
      </p>

      <p><strong>お気に入りの削除</strong><br>
      ・フリックスクロールバーを横にスライドし、削除できます。</p>

      <!-- 会場のお天気登録 -->
      <p><strong>会場のお天気登録</strong></p>

      <p><strong>お天気登録</strong><br>
      ① 日時とお天気ボックスをタップして会場の住所を入力し [ 検索 ]<br>
      ② 表示地点（自動判定）： ●●● を確認して [ 決定 ]<br>
      ③ 10分おきに情報が更新されます
      </p>

      <p><strong>思い出を記録</strong><br>
      ・端末のスクリーンショット機能を使って思い出を記録できます
      </p>

      <p>上記をご理解の上、アプリをご使用ください。</p>

    </div>

    <button class="help-close" type="button" id="closeMatchInfo">閉じる</button>

  </div>
</div>

</div>
</div>

<!-- ==================== 終了確認ダイアログ（アプリ風） ==================== -->
<div id="exitConfirm" style="
  display:none;
  position:fixed;
  inset:0;
  background:linear-gradient(
    rgba(0,0,0,0.65),
    rgba(0,0,0,0.75)
  );
  z-index:9999;
  align-items:center;
  justify-content:center;
  backdrop-filter: blur(6px);
">
  <div style="
    background:linear-gradient(135deg,#1e3c72,#2a5298);
    padding:22px 18px;
    border-radius:18px;
    text-align:center;
    color:white;
    width:82%;
    max-width:340px;
    box-shadow:0 10px 30px rgba(0,0,0,0.45);
  ">
    <div style="
      font-size:1.2rem;
      font-weight:600;
      margin-bottom:22px;
    ">
      アプリをリロードしますか？
    </div>

    <!-- ★ ボタン配置：リロード（左） / キャンセル（右） -->
    <div style="display:flex; gap:12px;">

      <!-- リロード（左） -->
      <button onclick="exitApp()" style="
        flex:1;
        padding:12px 0;
        border-radius:12px;
        border:none;
        font-size:1rem;
        font-weight:600;
        background:linear-gradient(135deg,#ff416c,#ff4b2b);
        color:white;
        box-shadow:0 4px 12px rgba(255,75,43,0.45);
      ">
        リロード
      </button>

      <!-- キャンセル（右） -->
      <button onclick="closeExitConfirm()" style="
        flex:1;
        padding:12px 0;
        border-radius:12px;
        border:none;
        font-size:1rem;
        font-weight:600;
        background:#ffffff;
        color:#2a5298;
        box-shadow:0 4px 10px rgba(0,0,0,0.25);
      ">
        キャンセル
      </button>

    </div>
  </div>
</div>
<!-- ==================== 終了確認ダイアログ（アプリ風） ==================== -->

<!-- ==================== 確認ダイアログ（OK / キャンセル） ==================== -->
<div id="confirmDialog" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  z-index:9999;
  align-items:center;
  justify-content:center;
  backdrop-filter: blur(5px);
">
  <div style="
    background:linear-gradient(135deg,#1e3c72,#2a5298);
    padding:20px 18px;
    border-radius:16px;
    text-align:center;
    color:white;
    width:80%;
    max-width:320px;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
  ">
    <div style="
      font-size:1.2rem;
      font-weight:600;
      margin-bottom:20px;
    " id="confirmMessage">
      この操作を実行しますか？
    </div>

    <!-- ★ ボタン配置：OK（左） / キャンセル（右） -->
    <div style="display:flex; gap:12px;">
      
      <!-- OK（左） -->
      <button onclick="okConfirm()" style="
        flex:1;
        padding:10px 0;
        border-radius:12px;
        border:none;
        font-size:1rem;
        font-weight:600;
        background:linear-gradient(135deg,#00c6ff,#0072ff);
        color:white;
        box-shadow:0 4px 12px rgba(0,114,255,0.45);
      ">
        OK
      </button>

      <!-- キャンセル（右） -->
      <button onclick="closeConfirm()" style="
        flex:1;
        padding:10px 0;
        border-radius:12px;
        border:none;
        font-size:1rem;
        font-weight:600;
        background:#ffffff;
        color:#2a5298;
        box-shadow:0 4px 10px rgba(0,0,0,0.25);
      ">
        キャンセル
      </button>

    </div>
  </div>
</div>
<!-- ==================== 確認ダイアログ（OK / キャンセル） ==================== -->

<!-- ==================== シンプル確認ダイアログ（OK / キャンセル） ==================== -->
<div id="simpleConfirmDialog" style="
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.5);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:12px;
    text-align:center;
    color:#333;
    width:80%;
    max-width:300px;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
  ">
    <div id="simpleConfirmMessage" style="margin-bottom:16px; font-size:1rem;">
      メッセージ
    </div>

    <!-- ★ ボタン配置：OK（左） / キャンセル（右） -->
    <div style="display:flex; gap:12px; justify-content:center;">

      <!-- OK（左） -->
      <button onclick="simpleOK()" style="
        flex:1;
        padding:10px 0;
        border:none;
        border-radius:10px;
        background:#0072ff;
        color:white;
        font-weight:600;
      ">OK</button>

      <!-- キャンセル（右） -->
      <button onclick="simpleCancel()" style="
        flex:1;
        padding:10px 0;
        border:none;
        border-radius:10px;
        background:#e0e0e0;
        font-weight:600;
        color:#333;
      ">キャンセル</button>

    </div>
  </div>
</div>
<!-- ==================== シンプル確認ダイアログ（OK / キャンセル） ==================== -->

<!-- ==================== シンプル OKのみ ダイアログ ==================== -->
<div id="simpleAlertDialog" style="
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.5);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:12px;
    text-align:center;
    color:#333;
    width:80%;
    max-width:300px;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
  ">
    <div id="simpleAlertMessage" style="margin-bottom:16px; font-size:1rem;">
      メッセージ
    </div>
    <button onclick="simpleAlertOK()" style="
      width:100%;
      padding:10px 0;
      border:none;
      border-radius:10px;
      background:#0072ff;
      color:white;
      font-weight:600;
    ">OK</button>
  </div>
</div>
<!-- ==================== シンプル OKのみ ダイアログ ==================== -->

<script>
/* ================== 本番・開発切り替え ================== */
const IS_PRODUCTION = true;

function devLog(...args){
  if(!IS_PRODUCTION) console.log(...args);
}
/* ======================================================== */

// -------------------- 既存のゲームロジック --------------------

// -------------------- 試合管理用変数 --------------------
let pointA = 0;
let pointB = 0;
let scoreA = 0, scoreB = 0, gameA = 0, gameB = 0;
let matchType = 7;  // デフォルト：7ゲームマッチ

// -------------------- サーバー・レシーバー管理 --------------------
// 選択されたサーバー（初期は未選択）
let selectedServer = { team: '', name: '' };
let serverIndicatorLocked = false;

// 現在のサーバー／レシーバー
let currentServerTeam = '';     // 現在サーブしているチーム（'A' or 'B'）
let currentReceiverTeam = '';   // 現在レシーブしているチーム（'A' or 'B'）
let currentServerName = '';     // 現在サーブしている選手名
let currentReceiverName = '';   // 現在レシーブしている選手名

// -------------------- 試合進行・履歴管理 --------------------
let historyStack = [];
let matchEnded = false;
let deuceCount = 0;
let finalInitDone = false;

// -------------------- 表示・コート管理 --------------------
let teamAName = 'Aチーム';
let teamBName = 'Bチーム';
let playerA1 = '選手1', playerA2 = '選手2';
let playerB1 = '選手1', playerB2 = '選手2';
let tournamentName = '';
let courtRotation = 0;
let independentRotation = 0; // 左右回転ボタン用
let infoTextTimeout = null;

// -------------------- ファイナルゲーム管理 --------------------
let totalPointsInFinal = 0;  // ファイナルゲーム中の合計ポイント数
let wasDeuce = false;  // 既存の deuceCount と併用して「直前がデュース状態だったか」を判定するためのフラグ
let lastTotalPoints = 0;     // 前回の累計ポイント（交代判定用）
let lastChangeType = "";     // "サイズ" or "サービス"
let lastGameCountA = 0;
let lastGameCountB = 0;

// --- オール表示中のサーバー固定 ---
let currentServerFixed = false;

// タイマー管理用（グローバル）
let gameCountTimeout = null;
let finalChangeTimeout = null;

// ポイントなどの操作許可フラグ
let matchControlsEnabled = false;

// 保存用配列（localStorage連動）
let favorites = JSON.parse(localStorage.getItem('favorites3bars') || '[]');
let scrollTimeout = null;

// vsボタンON・OFF用
let vsButtonEnabled = true; // 押せる状態かどうか

// グローバル（既にあるなら重複を避ける）
let isBarSwapped = false; // true のとき barA と barB の見た目は入れ替わっている

// === A/B入れ替え状態を保持 ===
let isSwappedAB = false;

// ★追加: 1ゲーム中のサーバー交代フラグ
let serverChangedThisGame = false;

let initialServerSelected = false;

let initialServerTeam = null;

let finalGameActive = false; // ファイナルゲーム中かどうか

// 表示混線防止変数
let displayVersion = 0;

// ---------------- 入力中フラグ（Android対策） ----------------
let isTextInputActive = false;

let updatingPositions = false;
let resizeTimer = null;

let allowExit = false;

// ==================== 共通フラグ・タイマー ====================
let isUndoing = false;               // Undo 中フラグ
let finalGameTimeoutId = null;       // ファイナルゲーム表示タイマー
let matchWinnerTimeoutId = null;     // 勝利表示タイマー
const MAX_HISTORY = 100;             // Undo 履歴上限
let readyMessageTimers = [];

// ----------------------------------- アプリ基本プログラム -----------------------------------
window.onload = function() {

  // タイトル演出を呼び出し
  playTitleSequence();

  // 以下、既存の処理はそのまま
  setTimeout(() => { window.scrollTo(0,1); }, 100);
  setTimeout(updatePlayerPositions, 300);
  loadSavedTeams();

  // --- コート回転ボタン ---
  document.querySelector('#courtSideLeft button').addEventListener('click', () => rotateCourt(-90));
  document.querySelector('#courtSideRight button').addEventListener('click', () => rotateCourt(90));

  // --- チーム名タップでポジションチェンジ ---
  document.getElementById('courtTeamA').addEventListener('click', () => { if (!matchEnded) swapPlayers('A'); });
  document.getElementById('courtTeamB').addEventListener('click', () => { if (!matchEnded) swapPlayers('B'); });

  // ==================== 初期サーバー選択 ====================
  ['playerA1Display','playerA2Display'].forEach(id => attachServerSelection('A', id));
  ['playerB1Display','playerB2Display'].forEach(id => attachServerSelection('B', id));

  // --- サーバー選択メッセージを点滅 ---
  const infoText = document.getElementById("infoText");
  infoText.classList.add("blink-text");
  setTimeout(() => infoText.classList.remove("blink-text"), 1000);
};

// ----------------------------------- ウィンドウ・ポイント・Ready ボタン処理 -----------------------------------
window.addEventListener('resize', () => {
  if (isTextInputActive) return;

  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    updatePlayerPositions();
  }, 200);
});

document.getElementById("pointAFlip").addEventListener("click", () => { pointA++; updatePointDisplay('A'); });
document.getElementById("pointBFlip").addEventListener("click", () => { pointB++; updatePointDisplay('B'); });

document.getElementById('readyButton').addEventListener('click', handleReadyButton);

// ----------------------------------- タイトル演出関数 -----------------------------------
function playTitleSequence() {
  if (isTextInputActive) return; // ★追加
  const titleWrapper = document.getElementById('titleWrapper');
  const titleScreen = document.getElementById('titleScreen');
  titleWrapper.style.display = 'flex';

  // ① 会社名表示（フェードイン + ズーム）
  titleScreen.innerHTML = `
  <style>
    /* サブタイトル専用フォント */
    #companySub {
      font-family: 'Comfortaa', sans-serif;
      margin-top: 6px;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.8);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.55);
      transform: translateX(-30px);
      opacity: 0;
      transition: transform 0.8s ease, opacity 0.8s ease;
    }
  </style>

  <h1 id="companyName" style="
    position: fixed;
    top: 42%;
    left: 40%;
    transform: translate(-50%, -50%) scale(0.8);
    font-family: 'BBH Hegarty', sans-serif;
    font-size: 2.5rem;
    color: #fff;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    opacity: 0;
    z-index: 999;
    transition: opacity 1s ease, transform 1s ease;
    text-align: center;
    letter-spacing: 0.05em;
  ">
    <div>Tok<span style="color:#FF8C00;">.</span>DoT</div>
    <div id="companySub">Take Your Step</div>
  </h1>
  `;

  const company = document.getElementById('companyName');
  const sub = document.getElementById('companySub');

  setTimeout(() => {
    // 会社名フェードイン + ズーム
    company.style.opacity = 1;
    company.style.transform = 'scale(1.1)';

    // サブタイトルを左からスッと出す
    setTimeout(() => {
      sub.style.opacity = 1;
      sub.style.transform = 'translateX(0)';
    }, 300);

  }, 100);

  // 会社名表示後、フェードアウト + 縮小
  setTimeout(() => {
    company.style.opacity = 0;
    company.style.transform = 'scale(1.3)';
    setTimeout(() => {
      company.style.display = 'none';

      // ② タイトル表示
      titleScreen.innerHTML = `
        <h1 id="titleText" style="text-align:center;transform: translateY(-20px);">
          <span class="title-main-wrapper">
            <span class="ball ball-left">●</span>
            <span class="ball-shadow"></span>
            <span class="title-main">ソフトテニス</span>
          </span>
          <span class="line">ダブルスマッチ</span>
          <span class="line">スコアボードアプリ</span>
        </h1>
      `;
      if (typeof animateTitleText === 'function') animateTitleText();

      // ③ 3秒後に Smash!!!! 表示
      setTimeout(() => {
        titleScreen.innerHTML = `
          <h1 id="smashText" style="
            font-family: 'Rubik Doodle Shadow', system-ui;
            font-weight: 400;
            font-style: normal;
            font-size: 4rem;
            text-align:center;
            margin-top: -10px;
          ">
            <span style="color:white;">Smash</span>
            <span id="smashExclamations">!!!!</span>
          </h1>
        `;

        setTimeout(() => {
          titleWrapper.style.display = 'none';
          document.getElementById('setupScreen').style.display = 'flex';

          // 戻るボタン対処
          history.pushState({ screen: 'setup' }, '', location.href);

          blinkElement('setupHintTextTop');
          setTimeout(() => blinkElement('setupHintTextBottom'), 4000);
        }, 5000);

      }, 3000);

    }, 1000);

  }, 2000);
}

// ----------------------------------- サーバー選択共通関数 -----------------------------------
function attachServerSelection(team, id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('click', () => {
    if (matchEnded) return;

    // ★ 追加：サーバータップ可能か
    if (!canSelectServerOnCourt()) return;

    if (!isDeuceSide(team, id)) return;
    serverIndicatorLocked = false;
    const name = (id.endsWith('1Display')) ? ((team==='A')?playerA1:playerB1) : ((team==='A')?playerA2:playerB2);
    selectedServer.team = team;
    selectedServer.name = name;
    showServerBlink(team);
    const teamName = (team==='A')?teamAName:teamBName;
    const color = (team==='A')?"#ffffff":"#ffff00";
    showInfo(`サーバー　${teamName}　${name} さん`, color);
    adjustAllInfoFonts();
    (team==='A')?initialServerTeam='A':initialServerTeam='B';
    updateServerByGameCount();
  });
}

// ----------------------------------- コート内ポジションチェンジ -----------------------------------
function swapPlayers(team) {
    let message = "";
    let color = "#ffffff";

    if (team === 'A') {
        [playerA1, playerA2] = [playerA2, playerA1];
        message = `${teamAName} の ${playerA2}さん デュースサイド に移動`;
        color = "#ffffff";
    } else if (team === 'B') {
        [playerB1, playerB2] = [playerB2, playerB1];
        message = `${teamBName} の ${playerB2}さん デュースサイド に移動`;
        color = "#ffff00";
    }

    setTimeout(updatePlayerPositions, 0);
    showInfo(message, color);
    adjustAllInfoFonts();
    showServerBlink(team);
}

// --- タイマー全キャンセル関数 ---
function cancelReadyDisplayTimers() {
    readyMessageTimers.forEach(t => clearTimeout(t));
    readyMessageTimers = [];
    const finalDisplay = document.getElementById("finalDisplay");
    if (finalDisplay) finalDisplay.textContent = "";
}

// ----------------------------------- Ready ボタン共通処理（安全版） -----------------------------------
function handleReadyButton() {
  if (!vsButtonEnabled) return;

  if (!selectedServer.team) {
    const infoText = document.getElementById("infoText");
    infoText.textContent = "① サーバーをタップ → ② [ vs ]をタップ";
    infoText.style.color = "#ff8080";
    infoText.classList.add("blink-text");
    readyMessageTimers.push(setTimeout(() => infoText.classList.remove("blink-text"), 1000));
    return;
  }

  // 既存演出用タイマーは念のためキャンセル
  cancelReadyDisplayTimers();

  disableMatchDisplays();
  enableMatchDisplays();

  const matchTypeSelect = document.getElementById('matchTypeSelect');
  let matchTypeText = matchTypeSelect.options[matchTypeSelect.selectedIndex]
    .text.replace(/（.*?）/g, '').trim();

  const finalDisplay = document.getElementById('finalDisplay');
  if (!finalDisplay) return;

  function formatPair(team) {
    const base =
      (team === 'A')
        ? `${playerA1}・${playerA2}`
        : `${playerB1}・${playerB2}`;

    const trimmed = base.trim();
    if (trimmed === '' || trimmed === '・') {
      return 'ペア';
    }
    return trimmed + 'ペア';
  }

  // --- 演出順序は一切変更なし ---
  finalDisplay.textContent = "レディ";
  readyMessageTimers.push(setTimeout(() => adjustFinalDisplayFont(), 0));

  readyMessageTimers.push(setTimeout(() => {
    const serverTeam = selectedServer.team;
    const receiverTeam = (serverTeam === 'A') ? 'B' : 'A';

    const serverTeamName = (serverTeam === 'A') ? teamAName : teamBName;
    const receiverTeamName = (receiverTeam === 'A') ? teamAName : teamBName;

    const serverPair = formatPair(serverTeam);
    const receiverPair = formatPair(receiverTeam);

    const serverColor = (serverTeam === 'A') ? "#ffffff" : "#ffff00";
    const recvColor = (receiverTeam === 'A') ? "#ffffff" : "#ffff00";

    finalDisplay.textContent = `サービスサイド　${serverTeamName}　${serverPair}`;
    finalDisplay.style.color = serverColor;
    adjustFinalDisplayFont();

    readyMessageTimers.push(setTimeout(() => {
      finalDisplay.textContent = `レシーブサイド　${receiverTeamName}　${receiverPair}`;
      finalDisplay.style.color = recvColor;
      adjustFinalDisplayFont();

      readyMessageTimers.push(setTimeout(() => {
        finalDisplay.textContent = matchTypeText + "　プレーボール";
        adjustFinalDisplayFont();

        readyMessageTimers.push(setTimeout(() => {
          finalDisplay.textContent = "";
          adjustFinalDisplayFont();
        }, 5000));

      }, 5000));

    }, 5000));

    currentServerTeam = serverTeam;
    currentReceiverTeam = receiverTeam;

  }, 1500));

  vsButtonEnabled = false;
  document.getElementById('readyButton').classList.add('inactive');
}

// --- Readyボタン再度有効化関数 ---
function resetVsButton() {
  vsButtonEnabled = true;
  const readyBtn = document.getElementById('readyButton');
  readyBtn.classList.remove('inactive');
}

// --- リセットや設定画面復帰時に呼ぶ ---
function onResetOrReturnFromSettings() {
  resetVsButton();
  // 他のリセット処理があればここに追加
}
// ----------------------------------- アプリ基本プログラム -----------------------------------

// -------------------- 試合開始 --------------------
// --- 試合開始画面に移動 ---
function startMatch() {

  // ★ 入力中なら試合開始しない
  if (isTextInputActive) {
  document.activeElement?.blur();
  if (startMatch._retrying) return;
  startMatch._retrying = true;
  setTimeout(() => {
    startMatch._retrying = false;
    startMatch();
  }, 300);
  return;
}


    // 🔥 試合開始時に必ず false に戻す（安全）
    matchEnded = false;

    // 入力値取得
    tournamentName = document.getElementById('tournamentNameInput').value || '';
    teamAName = document.getElementById('teamA').value || 'Aチーム';
    teamBName = document.getElementById('teamB').value || 'Bチーム';
    playerA1 = document.getElementById('playerA1').value || '選手1';
    playerA2 = document.getElementById('playerA2').value || '選手2';
    playerB1 = document.getElementById('playerB1').value || '選手1';
    playerB2 = document.getElementById('playerB2').value || '選手2';
    matchType = parseInt(document.getElementById('matchTypeSelect').value);
    
    // ポイント盤関連の消灯
    disableMatchDisplays();

    // ゲーム情報リセット
    gameA = gameB = scoreA = scoreB = 0;
    historyStack = [];
    matchEnded = false;
    deuceCount = 0;
    finalInitDone = false;

    // サーバー情報初期化
    selectedServer = { team: '', name: '' };
    currentServer = 'A';
    currentReceiver = 'B';

    // コート回転初期化
    courtRotation = 0;
    independentRotation = 0;

    // コート回転リセット（選手位置も初期化）
    resetCourtRotation();

  // ★ 念のため全 input / textarea のフォーカス解除
  document.querySelectorAll('input, textarea').forEach(el => el.blur());

    // 画面切替
    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'flex';
    document.getElementById('tournamentDisplay').textContent = tournamentName;

    // 描画後に位置を更新（重要: clientWidth/clientHeightが確定後）
    setTimeout(() => {
        updatePlayerPositions();
        updateScore();
    }, 300);

    // 上部チーム名表示に文字数制限
    const truncateName = (name, maxLen) => name.length > maxLen ? name.slice(0, maxLen) : name;
    document.getElementById('displayTeamA').textContent = truncateName(teamAName, 5);
    document.getElementById('displayTeamB').textContent = truncateName(teamBName, 5);

    // ペア名更新
    document.getElementById('pairA').textContent = `${truncateName(playerA1,3)}・${truncateName(playerA2,3)}ペア`;
    document.getElementById('pairB').textContent = `${truncateName(playerB1,3)}・${truncateName(playerB2,3)}ペア`;

    // サーバー案内表示
    const infoText = document.getElementById("infoText");
    infoText.textContent = "① サーバーをタップ → ② [ vs ]をタップ";
    infoText.style.color = "#ffffff";
    infoText.classList.add("blink-text");
    setTimeout(() => { infoText.classList.remove("blink-text"); }, 1000);
}

function preCheckFinal() {
    const finalDisplay = document.getElementById('finalDisplay');
    if (!finalDisplay) return;

    // 3ゲームマッチはファイナルなし
    if (matchType === 3) return;

    const finalThreshold = (matchType === 5 ? 2 : matchType === 7 ? 3 : 4);

    // ファイナルゲーム中のみ
    if (gameA === finalThreshold && gameB === finalThreshold) {
        // 現在の表示がチェンジ表示でなければ "ファイナルゲーム" を表示
        if (!finalDisplay.textContent.includes("チェンジ")) {
            finalDisplay.textContent = "ファイナルゲーム";
            adjustFinalDisplayFont();
        }
    }
}

// 🎊 上から舞い落ちる紙吹雪（回転ランダム／サイン波揺れ／長時間版）
function launchConfetti() {
  const colors = [
    '#ff4d4d', '#ffb84d', '#ffff4d', '#4dff4d',
    '#4dffff', '#4d4dff', '#b84dff', '#ffffff', '#ff66b3'
  ];
  
  const confettiCount = 300; // 豪華版

  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.classList.add('confetti');

    // 🎨 ランダム設定
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = 6 + Math.random() * 8 + 'px';
    confetti.style.height = 6 + Math.random() * 8 + 'px';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.opacity = 0.5 + Math.random() * 0.5;
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';

    // ⏱ 落下時間と遅延を長く
    confetti.style.animationDuration = (5 + Math.random() * 5) + 's'; // 5〜10秒
    confetti.style.animationDelay = Math.random() * 2 + 's';

    // 🎐 横揺れ設定（-100〜+100px）
    confetti.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
    confetti.style.setProperty('--wind', (Math.random() * 2 - 1).toFixed(2));

    // サイン波用の時刻変数
    confetti.style.setProperty('--t', Math.random().toFixed(2));

    // 回転ランダム
    confetti.style.setProperty('--start-rotate', (Math.random() * 360).toFixed(0) + 'deg');
    confetti.style.setProperty('--rotate-speed', (1 + Math.random() * 2).toFixed(2)); // 1～3回転

    document.body.appendChild(confetti);

    // 🎬 アニメーション終了後に削除
    setTimeout(() => confetti.remove(), 11000); // 10秒＋余裕
  }
}

// -------------------- 情報テキスト表示（infoText制御） --------------------
function showInfo(message, color = "#ffffff", duration = 5000) {
  const infoText = document.getElementById("infoText");
  if (!infoText) return;

  // 既存タイマーがあればクリア
  if (infoTextTimeout) {
    clearTimeout(infoTextTimeout);
    infoTextTimeout = null;
  }

  // メッセージ表示（改行を <br> に変換）
  if (isTextInputActive) return;
  infoText.innerHTML = message.replace(/\n/g, "<br>");
  infoText.style.color = color;

  // フォントサイズ調整
  infoText.style.fontSize = '18px';
  infoText.style.lineHeight = '1.2';
  if (message.length > 20) infoText.style.fontSize = '16px';

  // 点滅アニメ開始
  infoText.classList.add("blink-text");

  // 1秒後に点滅停止
  setTimeout(() => {
    infoText.classList.remove("blink-text");
  }, 1000);

  // 指定時間後に自動で消去
  infoTextTimeout = setTimeout(() => {
    infoText.textContent = "";
    infoTextTimeout = null;
  }, duration);
}

// --- サーバーの選手を点滅表示 ---
function showServerBlink(team) {
  // すべてのプレイヤーの点滅を解除
  ['playerA1Display','playerA2Display','playerB1Display','playerB2Display'].forEach(id => {
    document.getElementById(id).classList.remove('blinking');
  });

  if (!team || team === '') return;

  let targetId = null;

  if (team === 'A') {
    // Aチーム: 下側, 左=A1, 右=A2
    targetId = (currentServer === 'A1') ? 'playerA1Display' : 'playerA2Display';
  } else if (team === 'B') {
    // Bチーム: 上側, 左=B2, 右=B1（入れ替え済み）
    // currentServerが 'B1' の場合は右の B1Display
    // currentServerが 'B2' の場合は左の B2Display
    targetId = (currentServer === 'B1') ? 'playerB1Display' : 'playerB2Display';
  }

  const el = document.getElementById(targetId);
  if (!el) return;

  // 点滅開始（3秒間）
  let blinkCount = 0;
  const blinkInterval = setInterval(() => {
    el.classList.add('blinking');
    setTimeout(() => el.classList.remove('blinking'), 600);
    blinkCount++;
    if (blinkCount >= 5) {
      clearInterval(blinkInterval);
      el.classList.remove('blinking');
    }
  }, 600);
}

// --------------------------------- チーム名と選手名を保存関連 ---------------------------------
function saveTeam(team) {

    // ★ 入力中ならフォーカスを外す（Android対策）
    if (isTextInputActive) {
        document.activeElement?.blur();
    }

    // ★ blur完了（300ms）を待ってからDOM操作
    setTimeout(() => {

        const teamList = document.getElementById('teamList');
        let teamName, pairName;

        if (team === 'A') {
            teamName = document.getElementById('teamA').value || 'Aチーム';
            pairName = `${document.getElementById('playerA1').value || '選手1'}・${document.getElementById('playerA2').value || '選手2'}`;
        } else if (team === 'B') {
            teamName = document.getElementById('teamB').value || 'Bチーム';
            pairName = `${document.getElementById('playerB1').value || '選手1'}・${document.getElementById('playerB2').value || '選手2'}`;
        }

        const displayText = `${teamName} - ${pairName}`;

        // ★ 重複チェック
        for (let i = 0; i < teamList.options.length; i++) {
            if (teamList.options[i].value === displayText) {
                showSimpleAlert('そのチーム・ペアは<br>保存されています');
                return;
            }
        }

        // ★ 新規のみ追加
        const option = document.createElement('option');
        option.value = displayText;
        option.text = displayText;
        teamList.appendChild(option);

        saveTeamsToLocalStorage();

        // ★ 保存完了メッセージ
        showSimpleAlert('チーム・ペアを保存しました');

    }, 300);
}

function saveTeamsToLocalStorage() {
    const teamList = document.getElementById('teamList');
    const teams = [];
    for (let i = 0; i < teamList.options.length; i++) {
        if(teamList.options[i].value) teams.push(teamList.options[i].value);
    }
    localStorage.setItem('savedTeams', JSON.stringify(teams));
}

function loadSavedTeams() {
    const savedTeams = JSON.parse(localStorage.getItem('savedTeams') || '[]');
    const teamList = document.getElementById('teamList');
    savedTeams.forEach(teamText => {
        const option = document.createElement('option');
        option.value = teamText;
        option.text = teamText;
        teamList.appendChild(option);
    });
}

function applyToTeam(teamSide, retry = false) {

    if (isTextInputActive && !retry) {
        document.activeElement?.blur();
        setTimeout(() => applyToTeam(teamSide, true), 300);
        return;
    }

    const teamList = document.getElementById('teamList');
    const selected = teamList.value;

    // ★ 未選択時：既存のシンプルOKダイアログを使用
    if (!selected) {
        showSimpleAlert('チーム・ペアを選択してください');
        return;
    }

    const parts = selected.split(' - ');
    if (parts.length !== 2) return;

    const teamName = parts[0];
    const pairName = parts[1];
    const players = pairName.split('・');
    if (players.length !== 2) return;

    if (teamSide === 'A') {
        document.getElementById('teamA').value = teamName;
        document.getElementById('playerA1').value = players[0];
        document.getElementById('playerA2').value = players[1];
    } else {
        document.getElementById('teamB').value = teamName;
        document.getElementById('playerB1').value = players[0];
        document.getElementById('playerB2').value = players[1];
    }

    // ★ 反映後にデフォルトへ戻す
    teamList.selectedIndex = 0;

}


// --------------------------------- チーム名と選手名を保存関連 ---------------------------------

// ----------------------- チーム名・選手名 削除共通処理（シンプルダイアログ版 修正版） -----------------------
function deleteSelectedOption(selectId, saveFn) {
  const select = document.getElementById(selectId);
  if (!select) return;

  const idx = select.selectedIndex;
  if (idx <= 0) {
    showSimpleAlert('リストから選択してください');
    return;
  }

  const text = select.options[idx].text;
  showSimpleConfirm(`「${text}」<br>を削除しますか？`, function(result){
    if(!result) return; // キャンセルなら何もしない

    select.remove(idx);
    saveFn?.();
  });
}
// ----------------------- チーム名・選手名 削除共通処理（シンプルダイアログ版 修正版） -----------------------


// --------------------------------- 入力中フラグ制御（Android 対策） ---------------------------------
let inputBlurTimer = null;

document.addEventListener('focusin', (e) => {
  if (e.target.matches('input, textarea')) {
    isTextInputActive = true; // グローバル変数を使用
  }
});

document.addEventListener('focusout', (e) => {
  if (!e.target.matches('input, textarea')) return;

  clearTimeout(inputBlurTimer);
  inputBlurTimer = setTimeout(() => {
    isTextInputActive = false;
  }, 300); // 300ms が Android で安定
});
// --------------------------------- 入力中フラグ制御（Android 対策） ---------------------------------

// ----------------------- 設定画面：大会名 初期化（シンプルダイアログ版） -----------------------
document.getElementById('resetTournamentButton')?.addEventListener('click', () => {
  const tournamentInput = document.getElementById('tournamentNameInput');
  if (!tournamentInput) return;

  tournamentInput.blur(); // Android対策

  setTimeout(() => {
    showSimpleConfirm('大会名を初期化しますか？', function(result){
      if(!result) return; // キャンセルなら何もしない

      // OKが押された場合
      tournamentInput.value = tournamentInput.defaultValue;
      tournamentInput.style.fontSize = '16px';
      tournamentInput.style.fontFamily = '"Kosugi Maru", sans-serif';
    });
  }, 300);
});
// ----------------------- 設定画面：大会名 初期化（シンプルダイアログ版） -----------------------

// ------------------ 設定画面：チーム名・選手名 初期化 共通関数（シンプルダイアログ版） ------------------
function resetTeamFields(team) {
  const isA = team === 'A';
  const label = isA ? '左' : '右';

  const fieldIds = isA
    ? ['teamA', 'playerA1', 'playerA2']
    : ['teamB', 'playerB1', 'playerB2'];

  showSimpleConfirm(`チーム名・ペア名を<br>初期化しますか？`, function(result){
    if(!result) return; // キャンセルなら何もしない

    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      el.value = el.defaultValue;
      el.style.fontSize = '16px';
      el.style.fontFamily = '"Kosugi Maru", sans-serif';
    });

    updatePlayerPositions?.();
    adjustAllInfoFonts?.();
  });
}
// ------------------ 設定画面：チーム名・選手名 初期化 共通関数（シンプルダイアログ版） ------------------


// --------------------------------- 設定画面：Aチーム個別初期化ボタン ---------------------------------
document.getElementById('resetTeamAButton')?.addEventListener('click', () => {
  resetTeamFields('A');
});
// --------------------------------- 設定画面：Bチーム個別初期化ボタン ---------------------------------
document.getElementById('resetTeamBButton')?.addEventListener('click', () => {
  resetTeamFields('B');
});

// --------------------------------- 設定画面：チーム名・選手名 一括初期化（従来の resetTeamsButton 用） ---------------------------------
document.getElementById('resetTeamsButton')?.addEventListener('click', () => {
  ['A','B'].forEach(team => resetTeamFields(team));

  // 白丸S（サーバー）リセット
  currentServer = '';
  selectedServer.team = '';
  selectedServer.name = '';
  updateServerIndicator?.();

  adjustAllInfoFonts?.();
});
// --------------------------------- 設定画面：チーム名・選手名 一括初期化 ---------------------------------

function blinkElement(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('blink-text');
  setTimeout(() => {
    el.classList.remove('blink-text');
  }, 1000);
}

function isDeuceSide(team, playerId) {
    if (team === 'A') {
        // Aチーム: 右側 = A2
        return playerId === 'playerA2Display';
    } else if (team === 'B') {
        // Bチーム: 右側 = B2（入れ替え済み）
        return playerId === 'playerB2Display';
    }
    return false;
}

// --- 大会名保存（シンプルOKダイアログ版） ---
document.getElementById('saveTournamentButton').addEventListener('click', () => {
    const name = document.getElementById('tournamentNameInput').value.trim();
    if (!name) {
        showSimpleAlert('大会名を入力してください');
        return;
    }

    let saved = JSON.parse(localStorage.getItem('savedTournaments') || '[]');

    // ★ 重複チェック：メッセージを出す
    if (saved.includes(name)) {
        showSimpleAlert('その大会名は保存されています');
        return;
    }

    // 新規のみ保存
    saved.push(name);
    localStorage.setItem('savedTournaments', JSON.stringify(saved));
    updateTournamentList();

    showSimpleAlert('大会名を保存しました');
});

// --- 大会名リスト更新 ---
function updateTournamentList() {
    const select = document.getElementById('tournamentList');

    // 既存 option（HTMLの初期1件）以外を削除
    while (select.options.length > 1) {
        select.remove(1);
    }

    const saved = JSON.parse(localStorage.getItem('savedTournaments') || '[]');
    saved.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}

// --- 大会名呼び出し（シンプルOKダイアログ版） ---
document.getElementById('loadTournamentButton').addEventListener('click', () => {
    const select = document.getElementById('tournamentList');
    const selected = select.value;

    if (!selected) {
        showSimpleAlert('大会名を選択してください');
        return;
    }

    document.getElementById('tournamentNameInput').value = selected;

    // ★ 呼び出し後にデフォルトへ戻す
    select.selectedIndex = 0;
});

// --- 大会名リストを localStorage に保存 ---
function saveTournamentsToLocalStorage() {
    const selectEl = document.getElementById('tournamentList');
    const tournamentNames = [];
    for (let i = 1; i < selectEl.options.length; i++) { // 0番目は初期項目スキップ
        tournamentNames.push(selectEl.options[i].text);
    }
    localStorage.setItem('savedTournaments', JSON.stringify(tournamentNames));
}

// --- 初期読み込みでリスト更新と長押し設定 ---
window.addEventListener('load', () => {
    updateTournamentList();
});

// --- 試合画面_ポイントが2桁の時の縮尺用 ---
document.addEventListener('DOMContentLoaded', () => {
  updateFlipLength(); // 初期化時に実行
});

// --- 桁数更新関数 ---
function updateFlipLength() {
  document.querySelectorAll('.flip-container').forEach(el => {
    const span = el.querySelector('.front span');
    if (span) {
      const num = span.textContent.trim().replace(/\D/g, ''); // 数字のみ取得
      el.dataset.length = num.length;
    }
  });
}

// --- adjustFinalDisplayFont()：多段階スムーズ縮小（スケール対応） ---
function adjustFinalDisplayFont() {
    const el = document.getElementById("finalDisplay");
    const wrap = document.getElementById("finalDisplayWrapper");
    const app = document.getElementById("appScaleWrapper");
    if (!el || !wrap || !app) return;

    // ★ 現在の scale を取得
    const style = window.getComputedStyle(app);
    const matrix = style.transform;

    let scale = 1;
    if (matrix && matrix !== "none") {
        const values = matrix.match(/matrix\\(([^)]+)\\)/);
        if (values) {
            const parts = values[1].split(",");
            scale = parseFloat(parts[0]);  // X方向
        }
    }

    // ★ 見た目の最大幅（スケール後）
    const maxWidth = wrap.clientWidth;

    // ★ 段階フォントサイズ（大→小へ）
    const fontSteps = [20, 18, 16, 14, 12, 10];

    for (let size of fontSteps) {
        el.style.fontSize = size + "px";

        // ★ scrollWidth（元サイズ）× scale = 見た目の幅
        let visualWidth = el.scrollWidth * scale;

        if (visualWidth <= maxWidth) {
            return;  // ← このサイズで収まったので終了
        }
    }

    // ★ 最低サイズでも収まらない場合 → 最低値で固定
    el.style.fontSize = "10px";
}


// --- 大会名フォントサイズ自動調整 ---
function adjustTournamentDisplayFont() {
    const el = document.getElementById('tournamentDisplay');
    if (!el) return;

    // デフォルト21px
    let fontSize = 21;

    // 文字数が多ければ小さめに開始
    if (el.textContent.length > 18) fontSize = 18;
    if (el.textContent.length > 24) fontSize = 16;

    el.style.fontSize = fontSize + "px";

    // 横幅に収まるまで1pxずつ縮小（最低10px）
    const maxWidth = el.clientWidth;
    while (el.scrollWidth > maxWidth && fontSize > 10) {
        fontSize--;
        el.style.fontSize = fontSize + "px";
    }
}

// --- 汎用：フォント自動縮小処理（大会名と同方式） ---
function adjustAutoFont(id, baseSize = 18, minSize = 10) {
    const el = document.getElementById(id);
    if (!el) return;

    let fontSize = baseSize;

    // 文字数で開始サイズを調整（大会名と同じロジック）
    if (el.textContent.length > 18) fontSize = baseSize - 2;
    if (el.textContent.length > 24) fontSize = baseSize - 4;

    el.style.fontSize = fontSize + "px";

    // 要素幅に収まるまで1pxずつ縮小
    const maxWidth = el.clientWidth;
    while (el.scrollWidth > maxWidth && fontSize > minSize) {
        fontSize--;
        el.style.fontSize = fontSize + "px";
    }
}

// --- 3つのアナウンス要素をまとめて調整 ---
function adjustAllInfoFonts() {
    adjustAutoFont("showInfo", 18, 10);
    adjustAutoFont("infoText", 18, 10);
}

// --- ポイント盤タップでポイント追加ロジック ---
function updatePointDisplay(team) {
  if (team === 'A') {
    const front = pointAFlip.querySelector(".front span");
    const back  = pointAFlip.querySelector(".back span");
    front.textContent = pointA;
    back.textContent  = pointA;
  } else if (team === 'B') {
    const front = pointBFlip.querySelector(".front span");
    const back  = pointBFlip.querySelector(".back span");
    front.textContent = pointB;
    back.textContent  = pointB;
  }
}

// --- ポイント盤タップでポイント追加ロジック続き ---
document.addEventListener("DOMContentLoaded", () => {
    const pointAFlip = document.getElementById("pointAFlip");
    if (pointAFlip) {
        pointAFlip.addEventListener("click", () => addPoint("A"));
    }

    const pointBFlip = document.getElementById("pointBFlip");
    if (pointBFlip) {
        pointBFlip.addEventListener("click", () => addPoint("B"));
    }
});

// --------------------- 白丸S点灯・消灯処理の為のコード（始め） ---------------------
function updateServerIndicator() {
  const aIndicator = document.querySelector('.middle-box.left');
  const bIndicator = document.querySelector('.middle-box.right');
  if (!aIndicator || !bIndicator) return;

  // matchEnded → 消灯固定
  if (matchEnded) {
    aIndicator.classList.remove('active');
    bIndicator.classList.remove('active');
    aIndicator.style.opacity = 0.3;
    bIndicator.style.opacity = 0.3;
    return;
  }

  // --- 修正① ここを変更 ---
  // serverIndicatorLocked のときは「状態を変更しない」
  // → 消灯しないので不具合が起きない
  if (serverIndicatorLocked) {
    return;
  }
  // --------------------------------------

  // 一旦全て消灯
  aIndicator.classList.remove('active');
  bIndicator.classList.remove('active');
  aIndicator.style.opacity = 0.3;
  bIndicator.style.opacity = 0.3;

  // サーバー点灯
  if (currentServerTeam === 'A') {
    aIndicator.classList.add('active');
    aIndicator.style.opacity = 1.0;
  } else if (currentServerTeam === 'B') {
    bIndicator.classList.add('active');
    bIndicator.style.opacity = 1.0;
  }

  // --- 修正② 最終再点灯（DOM反映競合対策） ---
  setTimeout(() => {
    forceUpdateServerIndicator();
  }, 0);
}


// DOM反映競合対策のための実行
function forceUpdateServerIndicator() {
  const aIndicator = document.querySelector('.middle-box.left');
  const bIndicator = document.querySelector('.middle-box.right');
  if (!aIndicator || !bIndicator) return;

  // matchEnded の場合は点灯禁止
  if (matchEnded) return;

  // ロック中は触らない
  if (serverIndicatorLocked) return;

  // 再点灯
  if (currentServerTeam === 'A') {
    aIndicator.classList.add('active');
    aIndicator.style.opacity = 1.0;
    bIndicator.classList.remove('active');
    bIndicator.style.opacity = 0.3;
  } else if (currentServerTeam === 'B') {
    bIndicator.classList.add('active');
    bIndicator.style.opacity = 1.0;
    aIndicator.classList.remove('active');
    aIndicator.style.opacity = 0.3;
  }
}
// --------------------- 白丸S点灯・消灯処理の為のコード（終り） ---------------------

// --- 現在サーバーを取得（DOMに依存せず変数から取得） ---
function getCurrentServerFromIndicator() {
  return currentServerTeam; // currentServerTeam が 'A' または 'B' を保持
}


// --- 白丸Sの消灯処理 ---
function resetServerIndicator() {
  const aIndicator = document.querySelector('.middle-box.left');
  const bIndicator = document.querySelector('.middle-box.right');
  if (!aIndicator || !bIndicator) return;

  aIndicator.classList.remove('active');
  bIndicator.classList.remove('active');
  aIndicator.style.opacity = 0.3;
  bIndicator.style.opacity = 0.3;

  currentServerTeam = 'A';
  currentReceiverTeam = 'B';

// 重要：白丸Sの自動点灯をロック（リセット直後は点灯させない）
  serverIndicatorLocked = true;

}

// --- 得点ボタンの有効／無効制御 ---
function disableScoreButtons(disable) {
  const buttons = [document.getElementById('pointAFlip'), document.getElementById('pointBFlip')];
  buttons.forEach(btn => {
    if (!btn) return;
    btn.style.pointerEvents = disable ? "none" : "auto";  // クリック可否
    btn.style.opacity = disable ? "0.5" : "1";            // 見た目で無効化を表示
  });
}

// --------------------------- コート回転 ---------------------------
function rotateCourt(angle) {

  // 🔥 ゲーム終了中は回転禁止（ここで完全に止める）
  if (matchEnded) {
    devLog("ゲーム終了中のため回転しません");
    return;
  }

  courtRotation += angle;
  const court = document.getElementById('courtContainer');
  court.style.transform = `rotate(${courtRotation}deg)`;

  updatePlayerPositions();
  updateCourtLayout();
  updateABSwapByRotation();
}

// --- コート独立回転 ---
function rotateCourtIndependent(angle) {

  // 🔥 ゲーム終了中は回転禁止
  if (matchEnded) {
    devLog("ゲーム終了中のため独立回転しません");
    return;
  }

  independentRotation += angle;
  const court = document.getElementById('courtContainer');
  court.style.transform = `rotate(${courtRotation + independentRotation}deg)`;

  updatePlayerPositions();
  updateCourtLayout();
  updateABSwapByRotation();
}

// --- コート・UIレイアウト更新 ---
function updateCourtLayout() {
  const outerContainer = document.getElementById('outerContainer');
  const overlayWrapper = document.getElementById('overlay-wrapper');
  const pointAFlip = document.getElementById('pointAFlip');
  const pointBFlip = document.getElementById('pointBFlip');
  const gameAFront = document.getElementById('gameAFront');
  const gameBFront = document.getElementById('gameBFront');

  if (!outerContainer || !overlayWrapper) return;

}

// --------------------------- コート回転 ---------------------------

// --------------------- コート回転リセット ---------------------------
function resetCourtRotation() {

  // 🔥 ゲーム終了中はリセット禁止（回転処理を止める）
  if (matchEnded) {
    devLog("ゲーム終了中のためリセットしません");
    return;
  }

  courtRotation = 0;
  independentRotation = 0;

  const court = document.getElementById('courtContainer');
  if (court) court.style.transform = `rotate(0deg)`;

  updatePlayerPositions();
  updateCourtLayout();
  updateABSwapByRotation();

  // 外側UI強制解除
  const outerContainer = document.getElementById('outerContainer');
  const overlayWrapper = document.getElementById('overlay-wrapper');
  if (outerContainer) outerContainer.classList.remove('swapped');
  if (overlayWrapper) overlayWrapper.classList.remove('swapped');
}

function updatePlayerPositions(){

  // ★ 多重実行防止
  if (updatingPositions) return;
  updatingPositions = true;

  requestAnimationFrame(() => {

    const court = document.getElementById('courtContainer');
    if (!court) {
      updatingPositions = false;
      return;
    }

    const w = court.clientWidth;
    const h = court.clientHeight;

    const baselineTop = court.querySelector('.baseline-top')?.offsetTop ?? 0;
    const baselineBottom = court.querySelector('.baseline-bottom')?.offsetTop ?? h;

    const endLineOffset = 0.15 * h;
    const extraOffset = h * 0.115;

    const aY = baselineBottom - endLineOffset;
    const bY = baselineTop + endLineOffset - extraOffset;

    const spacing = 95;
    const xCenter = w / 2;

    const setPos = (id, top, left) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.top = top + 'px';
      el.style.left = left + 'px';
    };

    setPos('playerA1Display', aY, xCenter - spacing/2 - 35);
    setPos('playerA2Display', aY, xCenter + spacing/2 - 35);
    setPos('playerB2Display', bY, xCenter - spacing/2 - 35);
    setPos('playerB1Display', bY, xCenter + spacing/2 - 35);

    document.getElementById('playerA1Display').textContent = playerA1.slice(0,5);
    document.getElementById('playerA2Display').textContent = playerA2.slice(0,5);
    document.getElementById('playerB1Display').textContent = playerB1.slice(0,5);
    document.getElementById('playerB2Display').textContent = playerB2.slice(0,5);

    document.getElementById('courtTeamA').textContent =
      teamAName.length > 5 ? teamAName.slice(0,5) : teamAName;
    document.getElementById('courtTeamB').textContent =
      teamBName.length > 5 ? teamBName.slice(0,5) : teamBName;

    setPos('courtTeamA', h*0.75 - 15, xCenter - 35);
    setPos('courtTeamB', h*0.25 - 15, xCenter - 35);

    const allRotatable = [
      'playerA1Display','playerA2Display',
      'playerB1Display','playerB2Display',
      'courtTeamA','courtTeamB'
    ];

    allRotatable.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.transform =
        `rotate(${-courtRotation - independentRotation}deg)`;
    });

    updatingPositions = false;
  });
}

/* ------------------- vs（レディ）ボタンを押す前の消灯と点灯演出（始り） ------------------- */

// 試合開始画面表示時に消灯
function disableMatchDisplays() {
  // 1) ブロック盤
  ["barA","barB"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.add("inactive");
  });

  // 2) ゲームカウント盤
  ["gameAFront","gameABack","gameBFront","gameBBack"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.add("inactive");
  });

  // 3) ミニゲーム盤
  document.querySelectorAll(".mini-game-container").forEach(container => {
    container.classList.add("inactive");
    container.querySelectorAll(".mini-flip-container, .mini-flipper, .mini-front, .mini-back")
      .forEach(el => el.classList.add("inactive"));
  });

  // 4) 白丸
  document.querySelectorAll(".middle-symbol").forEach(el => el.classList.add("inactive"));

  // 5) ポイント盤（外枠 + 内部 front/back）
  ["pointAFlip","pointBFlip"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.add("inactive");
    el?.querySelectorAll(".flip-wrapper, .front, .back").forEach(f => f.classList.add("inactive"));
  });

  // 6) ロゴ
  document.querySelectorAll(".rogo-text").forEach(el => el.classList.add("inactive"));

  // 7) 操作禁止
  matchControlsEnabled = false;

  // 8) ポイントボタンも無効化
  disableScoreButtons(true);
}

// vsボタン押下で点灯
function enableMatchDisplays() {
  // 1) ブロック盤
  ["barA","barB"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.remove("inactive");
  });

  // 2) ゲームカウント盤
  ["gameAFront","gameABack","gameBFront","gameBBack"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.remove("inactive");
  });

  // 3) ミニゲーム盤
  document.querySelectorAll(".mini-game-container").forEach(container => {
    container.classList.remove("inactive");
    container.querySelectorAll(".mini-flip-container, .mini-flipper, .mini-front, .mini-back")
      .forEach(el => el.classList.remove("inactive"));
  });

  // 4) 白丸
  document.querySelectorAll(".middle-symbol").forEach(el => el.classList.remove("inactive"));

  // 5) ポイント盤（外枠 + 内部 front/back）
  ["pointAFlip","pointBFlip"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.remove("inactive");
    el?.querySelectorAll(".flip-wrapper, .front, .back").forEach(f => f.classList.remove("inactive"));
  });

  // 6) ロゴ
  document.querySelectorAll(".rogo-text").forEach(el => el.classList.remove("inactive"));

  // 7) 操作許可
  matchControlsEnabled = true;

  // 8) ポイントボタンも有効化
  disableScoreButtons(false);
}

/* ------------------- vs（レディ）ボタンを押す前の消灯と点灯演出（終り） ------------------- */

function updateScore() {
  //----------------------------------------------------
  // 1) 基本スコア（内部管理値）の反映
  //----------------------------------------------------
  const flipAFront = document.querySelector('#pointAFlip .front span');
  const flipABack  = document.querySelector('#pointAFlip .back span');
  const flipBFront = document.querySelector('#pointBFlip .front span');
  const flipBBack  = document.querySelector('#pointBFlip .back span');

  const pA = scoreA;
  const pB = scoreB;

  //----------------------------------------------------
  // 2) 今のゲームがファイナルか？
  //----------------------------------------------------
  const finalThreshold = (matchType === 5 ? 2 : (matchType === 7 ? 3 : 4));
  const isFinal = (gameA === finalThreshold && gameB === finalThreshold);

  //----------------------------------------------------
  // 3) デュース判定ライン
  //----------------------------------------------------
  const deuceBase = isFinal ? 6 : 3;

  let dispA = pA;
  let dispB = pB;

  //----------------------------------------------------
  // 4) デュース領域の処理
  //----------------------------------------------------
  if (pA >= deuceBase && pB >= deuceBase) {

    if (pA === pB) {
      // D - D （デュース）
      dispA = "D";
      dispB = "D";
      if (pA === deuceBase) {
        document.getElementById("deuceDisplay").textContent = "デュース";
      } else {
        document.getElementById("deuceDisplay").textContent = "デュースアゲイン";
      }
    } else if (pA === pB + 1) {
      dispA = "A";
      dispB = "D";
      document.getElementById("deuceDisplay").textContent = "";
    } else if (pB === pA + 1) {
      dispA = "D";
      dispB = "A";
      document.getElementById("deuceDisplay").textContent = "";
    } else {
      dispA = pA;
      dispB = pB;
      document.getElementById("deuceDisplay").textContent = "";
    }

  } else {
    dispA = pA;
    dispB = pB;
    document.getElementById("deuceDisplay").textContent = "";
  }

  //----------------------------------------------------
  // 5) Flip 表示へ反映
  //----------------------------------------------------
  flipAFront.textContent = dispA;
  flipABack.textContent  = dispA;
  flipBFront.textContent = dispB;
  flipBBack.textContent  = dispB;

  //----------------------------------------------------
  // 6) ゲームカウント表示
  //----------------------------------------------------
  document.getElementById('gameAFront').textContent = gameA;
  document.getElementById('gameABack').textContent  = gameA;
  document.getElementById('gameBFront').textContent = gameB;
  document.getElementById('gameBBack').textContent  = gameB;

  //----------------------------------------------------
  // 7) 進捗バー更新（フラグに従って描画先を決める）
  const rawBarA = document.getElementById('barA');
  const rawBarB = document.getElementById('barB');
  if (rawBarA && rawBarB) {
  // フラグに応じて Aチームのブロックをどの DOM に書き込むか決定
  const teamADest = isBarSwapped ? rawBarB : rawBarA;
  const teamBDest = isBarSwapped ? rawBarA : rawBarB;

  // クリア
  teamADest.innerHTML = '';
  teamBDest.innerHTML = '';

  const maxPoints =
    (gameA === Math.ceil(matchType / 2) - 1 &&
     gameB === Math.ceil(matchType / 2) - 1)
      ? 7
      : 4;

  // チーム色取得
  let colorA = window.getComputedStyle(document.querySelector('.bg-teamA')).backgroundColor;
  let colorB = window.getComputedStyle(document.querySelector('.bg-teamB')).backgroundColor;

  // ★重要★ 見た目の入れ替え（isBarSwapped）に応じて色も入れ替える
  if (isBarSwapped) {
    [colorA, colorB] = [colorB, colorA];
  }

  for (let i = 0; i < maxPoints; i++) {
    let blkA = document.createElement('div');
    blkA.className = 'score-block';
    blkA.style.background = (i < pA) ? colorA : 'rgba(255,255,255,0.2)';
    teamADest.appendChild(blkA);

    let blkB = document.createElement('div');
    blkB.className = 'score-block';
    blkB.style.background = (i < pB) ? colorB : 'rgba(255,255,255,0.2)';
    teamBDest.appendChild(blkB);
  }
}

  //----------------------------------------------------
  // 8) 桁数に応じた縮小処理
  //----------------------------------------------------
  document.querySelectorAll('.flip-container').forEach(el => {
    const span = el.querySelector('.front span');
    if (span) {
      const num = span.textContent.trim().replace(/\D/g, '');
      el.dataset.length = num.length;
    }
  });

  //----------------------------------------------------
  // 9) サーバー優先のポイントコール（ゼロオール非表示対応）
  //----------------------------------------------------
  const pointCallDisplay = document.getElementById("currentPointCall");
  const infoText = document.getElementById("infoText");
  if (!pointCallDisplay || !infoText) return;

  const map = ["ゼロ","ワン","ツー","スリー","フォー","ファイブ","シックス"];
  let serverPoint, receiverPoint;

  if (currentServerTeam === 'A') {
    serverPoint = pA;
    receiverPoint = pB;
  } else {
    serverPoint = pB;
    receiverPoint = pA;
  }

  let pointCall = "";
  if (!(serverPoint === 0 && receiverPoint === 0)) {
    // 0-0 の場合は表示しない
    pointCall = (serverPoint === receiverPoint)
      ? `${map[serverPoint]}オール`
      : `${map[serverPoint]} ${map[receiverPoint]}`;
  }

  pointCallDisplay.textContent = pointCall;
  infoText.innerHTML = pointCall;
  infoText.style.color = "#ffffff";
}

// --------------------　addPoint / undoPoint / reset の最初でインクリメント --------------------

function bumpDisplayVersion() {
    displayVersion++;
}

// ==================== addPoint（安全版） ====================
function addPoint(team) {
    bumpDisplayVersion();
    if (!matchControlsEnabled || matchEnded) return;

    const finalThreshold = getFinalThreshold(matchType);
    const inFinalGame =
        finalThreshold !== null &&
        gameA === finalThreshold &&
        gameB === finalThreshold;

    if (inFinalGame) totalPointsInFinal++;

    // --- Undo用履歴保存 ---
    historyStack.push({
        scoreA, scoreB, gameA, gameB, deuceCount,
        totalPointsInFinal, wasDeuce,
        currentServerTeam, currentReceiverTeam,
        currentServerFixed,
        finalInitDone,
        lastTotalPoints,
        matchEnded,
        finalGameActive,
        courtRotation,
        independentRotation,
        rotation: courtRotation + independentRotation,
        finalText: document.getElementById("finalDisplay")?.textContent || "",
        finalGradient: document.getElementById("finalDisplay")?.classList.contains("final-gradient") || false,
        deuceText: document.getElementById("deuceDisplay")?.textContent || "",
    });

    // 最大履歴数制限
    if (historyStack.length > MAX_HISTORY) historyStack.shift();

    // --- ポイント加算 ---
    if (team === "A") scoreA++;
    else scoreB++;

    // --- ファイナル開始時サーバー初期化 ---
    let finalJustStarted = false;
    if (!finalInitDone &&
        finalThreshold !== null &&
        gameA === finalThreshold - 1 &&
        gameB === finalThreshold - 1 &&
        scoreA === 0 && scoreB === 0
    ) {
        const prevReceiver = currentReceiverTeam;
        currentServerTeam = prevReceiver;
        currentReceiverTeam = prevReceiver === "A" ? "B" : "A";

        finalInitDone = true;
        lastTotalPoints = 0;
        updateServerIndicator();
        finalJustStarted = true;
    }

    checkGameStatus();
    updateScore();
    updatePointCall();
    if (currentServerTeam) refereeCall();

    const infoMsg = (team === "A" ? teamAName : teamBName) + " に1ポイント入りました";
    showInfo(infoMsg, team === "A" ? "#ffffff" : "#ffff00");
    adjustAllInfoFonts();

    if (finalJustStarted) {
        clearAllTimers();
        finalGameTimeoutId = setTimeout(() => {
            if (!finalGameActive || matchEnded || isUndoing) return;
            showFinalGameEntryDisplay();
        }, 5000);
    }
}

// ==================== undoPoint（安全版） ====================
function undoPoint(event) {
    bumpDisplayVersion();
    if (event) event.stopPropagation();
    if (historyStack.length === 0) return;

    isUndoing = true;       // ★ Undo開始

    clearAllTimers();       // ★ 既存タイマー破棄
    cancelReadyDisplayTimers();

    const last = historyStack.pop();

    // 1) 状態復元
    scoreA = last.scoreA;
    scoreB = last.scoreB;
    gameA  = last.gameA;
    gameB  = last.gameB;

    finalGameActive = isFinalGameState(gameA, gameB, getFinalThreshold(matchType));
    deuceCount = last.deuceCount || 0;
    totalPointsInFinal = last.totalPointsInFinal || 0;
    wasDeuce = last.wasDeuce || false;
    currentServerFixed = last.currentServerFixed ?? false;
    matchEnded = last.matchEnded ?? false;

    // 2) サーバー復元
    currentServerTeam   = last.currentServerTeam || "";
    currentReceiverTeam = last.currentReceiverTeam || "";
    updateServerIndicator();

    // 3) Final 表示復元（Undo中は安全）
    const finalDisplay = document.getElementById("finalDisplay");
    if (finalDisplay) {
        finalDisplay.textContent = last.finalText || "";
        finalDisplay.classList.toggle("final-gradient", !!last.finalGradient);
        adjustFinalDisplayFont();
    }

    // 3.5) コート回転復元
    if (typeof last.rotation === "number") restoreCourtRotation(last.rotation);

    // 4) デュース表示
    const deuceDisplay = document.getElementById("deuceDisplay");
    if (deuceDisplay) deuceDisplay.textContent = last.deuceText || "";

    // 5) スコア・コール
    updateScore();
    updatePointCall();
    if (currentServerTeam) refereeCall();

    // 6) 完全リセット時
    if (scoreA === 0 && scoreB === 0 && gameA === 0 && gameB === 0) {
        currentServerFixed = false;
        finalGameActive = false;

        document.querySelectorAll(".middle-symbol")
            .forEach(el => el.classList.add("inactive"));

        setTimeout(() => {
            disableMatchDisplays();
            currentServerTeam = "";
            currentReceiverTeam = "";
            updateServerIndicator();
            if (selectedServer) { selectedServer.team = ""; selectedServer.player = ""; }

            const pointCall = document.getElementById("currentPointCall");
            const infoText  = document.getElementById("infoText");
            if (pointCall) pointCall.textContent = "";
            if (infoText)  infoText.textContent  = "";
            if (deuceDisplay) deuceDisplay.textContent = "";
            if (finalDisplay) finalDisplay.textContent = "";

            matchControlsEnabled = true;
            vsButtonEnabled = true;
            document.getElementById("readyButton")?.classList.remove("inactive");
        }, 10);
    } else {
        enableMatchDisplays();
    }

    // 7) Final 内部再判定
    preCheckFinal();

    // 8) ボタン復帰
    disableScoreButtons(false);

    // 9) 情報表示
    showInfo("1ポイント戻しました");
    adjustAllInfoFonts();

    isUndoing = false;  // ★ Undo終了
}

// --------------------------- 試合リセット関連 ---------------------------

// -------------------- 試合リセット(共通) --------------------
function resetMatchState() {
    bumpDisplayVersion();
    cancelReadyDisplayTimers();
    gameA = gameB = scoreA = scoreB = 0;
    historyStack = [];
    matchEnded = false;
    deuceCount = 0;
    finalInitDone = false;
    finalGameActive = false;
    totalPointsInFinal = 0;
    isUndoing = false;

    selectedServer = { team:'', name:'' };
    currentServerTeam = 'A';
    currentReceiverTeam = 'B';
    currentServerFixed = false;
    resetServerIndicator();
    resetCourtRotation();
    updatePlayerPositions();
    updateScore();

    const finalDisplay = document.getElementById('finalDisplay');
    if(finalDisplay) {
        finalDisplay.textContent = '';
        finalDisplay.classList.remove('final-gradient');
        adjustFinalDisplayFont();
    }
    const deuceDisplay = document.getElementById('deuceDisplay');
    if(deuceDisplay) deuceDisplay.textContent = '';

    disableMatchDisplays();

    vsButtonEnabled = true;
    const readyBtn = document.getElementById('readyButton');
    if (readyBtn) readyBtn.classList.remove('inactive');

    const infoText = document.getElementById("infoText");
    if (infoText) {
        infoText.textContent = "① サーバーをタップ → ② [ vs ]をタップ";
        infoText.style.color = "#ffffff";
        infoText.classList.add("blink-text");
        setTimeout(()=>infoText.classList.remove("blink-text"),1000);
    }

    clearAllTimers();
}

// -------------------- 試合リセットボタン --------------------

function resetMatch() {
    // ボタンを水色グラデーションに
    const blueGradient = 'linear-gradient(to bottom, #a0dfff, #5eb8ff)';

    showConfirm('試合をリセットしますか？', function(result){
        if (result) resetMatchState();
    }, blueGradient);
}

// -------------------- 試合画面（リセット）から設定画面に戻るボタン) --------------------
function returnToSetup() {
    // OKボタンをオレンジグラデーションに
    const orangeGradient = 'linear-gradient(to bottom, #ffca7a, #ff8c00)';

    showConfirm('設定画面に戻りますか？<br>試合データはリセットされます', function(result){
        if(result) {
            resetMatchState(); // 共通処理呼び出し

            // 画面切替
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'flex';
        }
    }, orangeGradient);
}

// --------------------------- 試合リセット関連 ---------------------------

// ------------------------------------ ゲーム判定 ------------------------------------

// ==================== 初期化 ====================
function initializeMatch() {
    scoreA = 0;
    scoreB = 0;
    gameA = 0;
    gameB = 0;

    currentServerTeam = '';
    currentReceiverTeam = '';

    initialServerTeam = null;

    lastTotalPoints = 0; // ファイナル専用
    matchEnded = false;
    isBarSwapped = false;

    updateServerIndicator();
    updateScore();
    setFinalDisplay("");
}


// ==================== メイン判定 ====================
// ==================== checkGameStatus（統合安全版） ====================
function checkGameStatus() {
    if (matchEnded) return;

    const finalThreshold = getFinalThreshold(matchType);
    const isFinalGame = isFinalGameState(gameA, gameB, finalThreshold);
    const winner = judgeGameWinner(scoreA, scoreB, isFinalGame);

    // ★ ファイナルフラグ更新
    finalGameActive = isFinalGame && !matchEnded;

    // ---------- ファイナル中：2ポイント交代 ----------
    if (handleFinalGameServerChange(isFinalGame)) {
        updateABSwapByRotation();
        updatePointCall();

        const block = Math.floor((scoreA + scoreB) / 2);
        const changeText =
            (block % 2 === 1) ? "チェンジサイズ" : "チェンジサービス";

        setFinalDisplay(changeText);
        handleChangeSideDisplay(changeText);
    }

    // ---------- ゲーム勝者確定 ----------
    if (winner) {
        if (winner === 'A') gameA++;
        else gameB++;

        // ゲーム数からサーバー再計算
        updateServerByGameCount();
        updateABSwapByRotation();
        updatePointCall();
        refereeCall();

        const totalGames = gameA + gameB;
        const changeText =
            (totalGames % 2 === 0)
                ? "ゲーム　チェンジサービス"
                : "ゲーム　チェンジサイズ";

        setFinalDisplay(changeText);
        handleChangeSideDisplay(changeText);

        scoreA = 0;
        scoreB = 0;
        updateScore();

        scheduleGameCountDisplay();

        // ---------- ファイナルゲーム突入表示 ----------
        if (finalThreshold !== null && gameA === finalThreshold && gameB === finalThreshold) {
            finalGameActive = true;

            // 既存タイマー破棄
            clearAllTimers();

            finalGameTimeoutId = setTimeout(() => {
                if (!finalGameActive || matchEnded || isUndoing) return;
                setFinalDisplay("ファイナルゲーム");
            }, 16000);  // 
        }
    }

    // ---------- マッチ終了 ----------
    const matchResult = applyMatchEndLogic(matchType);

    if (matchResult.ended) {
        finalGameActive = false;
        clearAllTimers(); // ★ 予約タイマー破棄

        setFinalDisplay("ゲームセット");
        disableScoreButtons(true);

        currentServerTeam = '';
        currentReceiverTeam = '';
        updateServerIndicator();

        matchWinnerTimeoutId = setTimeout(() => {
            if (isUndoing) return; // Undo中は表示抑制

            const teamAName = document.getElementById('displayTeamA')?.textContent || 'Aチーム';
            const teamBName = document.getElementById('displayTeamB')?.textContent || 'Bチーム';
            const pairAName = document.getElementById('pairA')?.textContent.replace('ペア','').trim();
            const pairBName = document.getElementById('pairB')?.textContent.replace('ペア','').trim();

            setFinalDisplay(
                matchResult.winner === 'A'
                    ? `${teamAName}　${pairAName}ペア　の勝ちです`
                    : `${teamBName}　${pairBName}ペア　の勝ちです`
            );

            launchConfetti();
        }, 5000);
    }
}

// ==================== 判定ロジック ====================
function getFinalThreshold(matchType) {
    switch (matchType) {
        case 3: return null;
        case 5: return 2;
        case 7: return 3;
        case 9: return 4;
        default: return null;
    }
}

function isFinalGameState(gameA, gameB, finalThreshold) {
    return finalThreshold !== null &&
           gameA === finalThreshold &&
           gameB === finalThreshold;
}

function judgeGameWinner(scoreA, scoreB, isFinalGame) {
    if (isFinalGame) {
        if (scoreA >= 7 && scoreA - scoreB >= 2) return 'A';
        if (scoreB >= 7 && scoreB - scoreA >= 2) return 'B';
        return null;
    }
    if (scoreA >= 4 || scoreB >= 4) {
        if (scoreA - scoreB >= 2) return 'A';
        if (scoreB - scoreA >= 2) return 'B';
    }
    return null;
}


// ==================== ファイナル中交代 ====================
function handleFinalGameServerChange(isFinalGame) {
    if (!isFinalGame) return false;

    const totalPoints = scoreA + scoreB;

    if (totalPoints % 2 === 0 && totalPoints !== lastTotalPoints) {
        [currentServerTeam, currentReceiverTeam] =
            [currentReceiverTeam, currentServerTeam];
        updateServerIndicator();
        lastTotalPoints = totalPoints;
        return true;
    }

    lastTotalPoints = totalPoints;
    return false;
}

// ==================== マッチ終了 ====================
function applyMatchEndLogic(matchType) {
    const matchWin = Math.ceil(matchType / 2);

    if (matchEnded) return { ended: false };

    if (gameA >= matchWin || gameB >= matchWin) {
        matchEnded = true;
        currentServerTeam = '';
        currentReceiverTeam = '';
        return {
            ended: true,
            winner: (gameA > gameB) ? 'A' : 'B'
        };
    }
    return { ended: false };
}

// ==================== 表示系 ====================
function scheduleGameCountDisplay() {
    if (matchEnded) return;

    const myVersion = displayVersion;

    if (gameCountTimeout) clearTimeout(gameCountTimeout);

    gameCountTimeout = setTimeout(() => {
        if (displayVersion !== myVersion) return; // ★ 古い命令は破棄
        if (matchEnded) return;

        const map = ["ゼロ","ワン","ツー","スリー","フォー","ファイブ","シックス"];
        const all = Math.floor(matchType / 2);

        const conv = (a,b) => {
            if (a === b && a >= 1 && a <= all) return map[a] + "オール";
            if (a === b && a > all) return "デュース";
            return map[a] + map[b];
        };

        const text =
            "ゲームカウント " +
            ((currentServerTeam === 'A') ? conv(gameA,gameB) : conv(gameB,gameA));

        setFinalDisplay(text);

    }, 8000);
}

// ==================== タイマー破棄 ====================
function clearAllTimers() {
    if (finalGameTimeoutId) { clearTimeout(finalGameTimeoutId); finalGameTimeoutId = null; }
    if (matchWinnerTimeoutId) { clearTimeout(matchWinnerTimeoutId); matchWinnerTimeoutId = null; }
}

// ==================== setFinalDisplay（安全版） ====================
function setFinalDisplay(text) {
    if (isUndoing) return;  // Undo 中は表示しない
    const el = document.getElementById("finalDisplay");
    if (!el) return;

    // ゲームセット後は「ファイナルゲーム」だけ表示禁止
    if (matchEnded && text === "ファイナルゲーム") return;

    el.textContent = text;
    adjustFinalDisplayFont();

    const finalThreshold = getFinalThreshold(matchType);
    const stillFinal =
        finalThreshold !== null &&
        gameA === finalThreshold &&
        gameB === finalThreshold;

    if (finalGameActive && stillFinal && text !== "ゲームセット") {
        // 何もしない（将来拡張用）
    }
}

function handleChangeSideDisplay(text) {
    if (matchEnded) return;
    if (text === "チェンジサイズ" || text === "ゲーム　チェンジサイズ") {
        setTimeout(() => rotateCourt(180), 50);
    }
}

// ==================== ゲーム数からサーバーを再計算 ====================
function updateServerByGameCount() {
    if (!initialServerTeam) return;

    const finishedGames = gameA + gameB;

    if (finishedGames % 2 === 0) {
        currentServerTeam = initialServerTeam;
        currentReceiverTeam = (initialServerTeam === 'A') ? 'B' : 'A';
    } else {
        currentServerTeam = (initialServerTeam === 'A') ? 'B' : 'A';
        currentReceiverTeam = initialServerTeam;
    }

    updateServerIndicator();
}

// ------------------------------------ ゲーム判定 ------------------------------------

/* ------ undopoint用コート回転を戻す関数 ------ */
function restoreCourtRotation(rotationValue) {
    if (typeof rotationValue !== "number") return;

    courtRotation = rotationValue;

    const court = document.getElementById("courtContainer");
    if (court) {
        court.style.transform = `rotate(${courtRotation}deg)`;
    }

    // プレイヤー位置・レイアウト・AB入れ替えも更新
    updatePlayerPositions();
    updateCourtLayout();
    updateABSwapByRotation();
}
/* ------ undopoint用コート回転を戻す関数 ------ */

// -------------------- ポイントコール修正版（統一版） --------------------
function updatePointCall() {
    if (matchEnded) return;
    if (!currentServerTeam) return;

    const pointCallDisplay = document.getElementById("currentPointCall");
    const infoText = document.getElementById("infoText");
    if (!pointCallDisplay || !infoText) return;

    const serverPoint = currentServerTeam === 'A' ? scoreA : scoreB;
    const receiverPoint = currentServerTeam === 'A' ? scoreB : scoreA;

    // matchTypeに応じたファイナル閾値を取得（3ゲームマッチはnull）
    const finalThreshold = getFinalThreshold(matchType);
    const isFinal = finalThreshold !== null && gameA === finalThreshold && gameB === finalThreshold;
    const deuceBase = isFinal ? 6 : 3;

    let pointCall = "";

    if (serverPoint >= deuceBase && receiverPoint >= deuceBase) {
        if (serverPoint === receiverPoint) {
            pointCall = "デュース";
            wasDeuce = true;
        } else if (Math.abs(serverPoint - receiverPoint) === 1) {
            const leader = (serverPoint > receiverPoint) ? currentServerTeam : (currentServerTeam === 'A' ? 'B' : 'A');
            pointCall = (leader === currentServerTeam)
                ? "アドバンテージ サーバー"
                : "アドバンテージ レシーバー";
            wasDeuce = true;
        } else {
            pointCall = `${serverPoint} ${receiverPoint}`;
            wasDeuce = false;
        }
    } else if (serverPoint === receiverPoint) {
        pointCall = serverPoint + "オール";
        wasDeuce = false;
    } else {
        pointCall = `${serverPoint} ${receiverPoint}`;
        wasDeuce = false;
    }

    pointCallDisplay.textContent = pointCall;
    infoText.textContent = pointCall;
    infoText.style.color = "#ffffff";
}

// -------------------- 主審コール（統一版） --------------------
function refereeCall() {
    const display = document.getElementById('deuceDisplay');
    if (!display || !currentServerTeam) return;
    if (matchEnded) { display.textContent=""; return; }

    const pA = scoreA;
    const pB = scoreB;

    // matchTypeに応じたファイナル閾値を取得（3ゲームマッチはnull）
    const finalThreshold = getFinalThreshold(matchType);
    const isFinal = finalThreshold !== null && gameA === finalThreshold && gameB === finalThreshold;
    const deuceBase = isFinal ? 6 : 3;

    if (pA === 0 && pB === 0) { display.textContent=""; return; }

    if (pA >= deuceBase && pB >= deuceBase) {
        if (pA === pB) {
            display.textContent = ((!isFinal && pA===3) || (isFinal && pA===6)) ? "デュース" : "デュースアゲイン";
            wasDeuce = true;
        } else if (Math.abs(pA - pB)===1) {
            const leader = pA>pB?'A':'B';
            display.textContent = (leader===currentServerTeam) ? "アドバンテージ サーバー" : "アドバンテージ レシーバー";
            wasDeuce = true;
        } else {
            display.textContent="";
            wasDeuce=false;
        }
        return;
    }

    if (isFinal) {
        const finalPoints = ["ゼロ","ワン","ツー","スリー","フォー","ファイブ","シックス"];
        if (pA===pB && pA<=6) display.textContent = finalPoints[pA]+"オール";
        else display.textContent = currentServerTeam==='A'? finalPoints[pA]+finalPoints[pB]:finalPoints[pB]+finalPoints[pA];
        return;
    }

    const normalCall = {
        "0,1":"ゼロワン","0,2":"ゼロツー","0,3":"ゼロスリー",
        "1,0":"ワンゼロ","1,1":"ワンオール","1,2":"ワンツー","1,3":"ワンスリー",
        "2,0":"ツーゼロ","2,1":"ツーワン","2,2":"ツーオール","2,3":"ツースリー",
        "3,0":"スリーゼロ","3,1":"スリーワン","3,2":"スリーツー"
    };

    display.textContent = currentServerTeam==='A'? normalCall[`${pA},${pB}`]||"" : normalCall[`${pB},${pA}`]||"";
}

/* --------------------------- コート内サーバータップの可否 ---------------------------- */

function canSelectServerOnCourt() {

  if (matchEnded) return false;

  // ★ ゲーム・ポイントが完全初期なら無条件でOK
  if (
    gameA === 0 &&
    gameB === 0 &&
    scoreA === 0 &&
    scoreB === 0
  ) return true;

  // それ以外は vs前のみOK
  return !vsButtonPressed;
}

// サーバーは「試合開始前」または「完全初期状態」のみ変更可能
/* --------------------------- コート内サーバータップの可否 ---------------------------- */

/* --------------------------- A/B自動入替えコード ---------------------------- */

// === A/B を入れ替えるべきか判定するロジック ===
function shouldSwapABByRotation(courtRotation, independentRotation) {
    const totalRotation = (courtRotation + independentRotation) % 360;
    const rotation = (totalRotation + 360) % 360; // 正規化
    return rotation === 270;
}

// === 回転角から A/B を自動入れ替え（最終ロジック版） ===
function updateABSwapByRotation() {
    const shouldSwap = shouldSwapABByRotation(
        courtRotation,
        independentRotation
    );

    setABSwapState(shouldSwap);
}

// === A/B 入替え状態を設定する（ロジック専用） ===
function setABSwapState(shouldBeSwapped) {
    if (shouldBeSwapped === isSwappedAB) return;

    // 状態を先に切り替える（重要）
    isSwappedAB = shouldBeSwapped;

    // 表示は必ず1回だけ呼ぶ
    renderABSwapView();
}

function applyABSwap() {
    setABSwapState(true);
}

function revertABSwap() {
    setABSwapState(false);
}

// === A/B 入替え表示（View専用・最終形） ===
function renderABSwapView() {

    // ---- チーム名表示 ----
    swapElements("#displayTeamA", "#displayTeamB");
    swapBgColor(".bg-teamA", ".bg-teamB");

    // ---- ペア名 ----
    swapElements("#pairA", "#pairB");

    // ---- ゲームカウント ----
    swapElements("#gameAFront", "#gameBFront");
    swapElements("#gameABack",  "#gameBBack");

    // ---- ミニ盤 ----
    swapElements(".mini-front.A", ".mini-front.B");
    swapElements(".mini-back.A",  ".mini-back.B");

    // ---- ポイント ----
    swapElements("#pointAFlip", "#pointBFlip");

    // ---- マージン（状態だけを見る） ----
    const pointA = document.getElementById("pointAFlip");
    const pointB = document.getElementById("pointBFlip");
    if (pointA && pointB) {
        if (isSwappedAB) {
            pointA.style.marginLeft  = "15px";
            pointA.style.marginRight = "0px";
            pointB.style.marginLeft  = "0px";
            pointB.style.marginRight = "15px";
        } else {
            pointA.style.marginLeft  = "0px";
            pointA.style.marginRight = "15px";
            pointB.style.marginLeft  = "15px";
            pointB.style.marginRight = "0px";
        }
    }

    // ---- 積み上げバー ----
    swapBars();

    // ---- サーブ表示 ----
    swapElements(".middle-box.left", ".middle-box.right");
}

// === 要素の入れ替え（内容丸ごとスワップ） ===
function swapElements(selA, selB) {
    const a = document.querySelector(selA);
    const b = document.querySelector(selB);
    if (a && b) {
        const temp = document.createElement("div");
        a.parentNode.insertBefore(temp, a);

        b.parentNode.insertBefore(a, b);
        temp.parentNode.insertBefore(b, temp);

        temp.remove();
    }
}

// === 背景色を入れ替え（クラス単位で確実に切替） ===
function swapBgColor(selA, selB) {
    const elemsA = document.querySelectorAll(selA);
    const elemsB = document.querySelectorAll(selB);

    const count = Math.min(elemsA.length, elemsB.length);

    for (let i = 0; i < count; i++) {
        const a = elemsA[i];
        const b = elemsB[i];

        a.classList.toggle("bg-teamA");
        a.classList.toggle("bg-teamB");

        b.classList.toggle("bg-teamA");
        b.classList.toggle("bg-teamB");
    }
}

// === 積み上げバー専用スワップ（中身だけ入れ替え） ===
function swapBars() {
    const barA = document.getElementById('barA');
    const barB = document.getElementById('barB');
    if (!barA || !barB) return;

    const tmp = barA.innerHTML;
    barA.innerHTML = barB.innerHTML;
    barB.innerHTML = tmp;

    // ← ここで入れ替わったことを記録（重要）
    isBarSwapped = !isBarSwapped;
}

/* --------------------------- A/B自動入替えコード ---------------------------- */

/* ------------------- チーム名と選手名背景色変更スクロールバー始り ------------------- */
const teamCombos = [
  // ==============================
  // デフォルト色
  // ==============================
  {teamA:"#ffffff", teamB:"#ffff00"}, 
  {teamA:"#ffff00", teamB:"#ffffff"}, 

  // ==============================
  // ややビビッド・高コントラスト
  // ==============================
  {teamA:"#FF6F91", teamB:"#6EC1E4"}, {teamA:"#6EC1E4", teamB:"#FF6F91"},
  {teamA:"#7FDBFF", teamB:"#FFB347"}, {teamA:"#FFB347", teamB:"#7FDBFF"},
  {teamA:"#A2E4A4", teamB:"#FF9AA2"}, {teamA:"#FF9AA2", teamB:"#A2E4A4"},
  {teamA:"#FFD47F", teamB:"#8ED1FC"}, {teamA:"#8ED1FC", teamB:"#FFD47F"},
  {teamA:"#FF9C6E", teamB:"#B39DDB"}, {teamA:"#B39DDB", teamB:"#FF9C6E"},
  {teamA:"#FFB6C1", teamB:"#4FC3F7"}, {teamA:"#4FC3F7", teamB:"#FFB6C1"},
  {teamA:"#FFCC80", teamB:"#81C784"}, {teamA:"#81C784", teamB:"#FFCC80"},
  {teamA:"#FF8A80", teamB:"#80D8FF"}, {teamA:"#80D8FF", teamB:"#FF8A80"},
  {teamA:"#F5A623", teamB:"#64B5F6"}, {teamA:"#64B5F6", teamB:"#F5A623"},
  {teamA:"#FF7043", teamB:"#AED581"}, {teamA:"#AED581", teamB:"#FF7043"},
  {teamA:"#FFCA28", teamB:"#90CAF9"}, {teamA:"#90CAF9", teamB:"#FFCA28"},
  {teamA:"#E57373", teamB:"#4DD0E1"}, {teamA:"#4DD0E1", teamB:"#E57373"},
  {teamA:"#FFAB91", teamB:"#BA68C8"}, {teamA:"#BA68C8", teamB:"#FFAB91"},
  {teamA:"#FFB74D", teamB:"#4DB6AC"}, {teamA:"#4DB6AC", teamB:"#FFB74D"},
  {teamA:"#FF8F00", teamB:"#64FFDA"}, {teamA:"#64FFDA", teamB:"#FF8F00"},
  {teamA:"#FF5252", teamB:"#40C4FF"}, {teamA:"#40C4FF", teamB:"#FF5252"},

// ==============================
// 濃いビビッド＋対決意識
// ==============================
{teamA:"#FF1744", teamB:"#009688"}, {teamA:"#009688", teamB:"#FF1744"},
{teamA:"#D500F9", teamB:"#00B0FF"}, {teamA:"#00B0FF", teamB:"#D500F9"},
{teamA:"#FF6D00", teamB:"#1DE9B6"}, {teamA:"#1DE9B6", teamB:"#FF6D00"},
{teamA:"#C51162", teamB:"#00E5FF"}, {teamA:"#00E5FF", teamB:"#C51162"},
{teamA:"#FF4081", teamB:"#00C853"}, {teamA:"#00C853", teamB:"#FF4081"},
{teamA:"#FFAB00", teamB:"#6200EA"}, {teamA:"#6200EA", teamB:"#FFAB00"},
{teamA:"#FF5252", teamB:"#2962FF"}, {teamA:"#2962FF", teamB:"#FF5252"},
{teamA:"#FF6E40", teamB:"#1B5E20"}, {teamA:"#1B5E20", teamB:"#FF6E40"},
{teamA:"#FFEA00", teamB:"#AA00FF"}, {teamA:"#AA00FF", teamB:"#FFEA00"},
{teamA:"#FF3D00", teamB:"#00BFA5"}, {teamA:"#00BFA5", teamB:"#FF3D00"},
{teamA:"#F50057", teamB:"#00B0FF"}, {teamA:"#00B0FF", teamB:"#F50057"},
{teamA:"#FF9100", teamB:"#304FFE"}, {teamA:"#304FFE", teamB:"#FF9100"},

// ==============================
// スプラトゥーン風
// ==============================
{teamA:"#FF3CAC", teamB:"#00FFD4"}, {teamA:"#00FFD4", teamB:"#FF3CAC"},
{teamA:"#FF9500", teamB:"#1CE6FF"}, {teamA:"#1CE6FF", teamB:"#FF9500"},
{teamA:"#FF1C1C", teamB:"#B8FF1C"}, {teamA:"#B8FF1C", teamB:"#FF1C1C"},
{teamA:"#FF6EC7", teamB:"#6EFFA2"}, {teamA:"#6EFFA2", teamB:"#FF6EC7"},
{teamA:"#FFEB3B", teamB:"#00FF9D"}, {teamA:"#00FF9D", teamB:"#FFEB3B"},

// ==============================
// マリオカート風
// ==============================
{teamA:"#FF0000", teamB:"#00CC00"}, {teamA:"#00CC00", teamB:"#FF0000"},
{teamA:"#FF8800", teamB:"#0088FF"}, {teamA:"#0088FF", teamB:"#FF8800"},
{teamA:"#FFEE00", teamB:"#CC00FF"}, {teamA:"#CC00FF", teamB:"#FFEE00"},
{teamA:"#FF4444", teamB:"#44FF44"}, {teamA:"#44FF44", teamB:"#FF4444"},
{teamA:"#FFAA33", teamB:"#33AAFF"}, {teamA:"#33AAFF", teamB:"#FFAA33"},

// ==============================
// モンハン風
// ==============================
{teamA:"#8B4513", teamB:"#FF4500"}, {teamA:"#FF4500", teamB:"#8B4513"},
{teamA:"#A0522D", teamB:"#1E90FF"}, {teamA:"#1E90FF", teamB:"#A0522D"},
{teamA:"#0000FF", teamB:"#008000"}, {teamA:"#008000", teamB:"#0000FF"},
{teamA:"#CD853F", teamB:"#7B68EE"}, {teamA:"#7B68EE", teamB:"#CD853F"},
{teamA:"#DEB887", teamB:"#FF6347"}, {teamA:"#FF6347", teamB:"#DEB887"},

// ==============================
  // 濃いめパステル・Switch調
  // ==============================
  {teamA:"#ff9fbf", teamB:"#8fd3ff"}, {teamA:"#8fd3ff", teamB:"#ff9fbf"},
  {teamA:"#ffb38a", teamB:"#9fc5ff"}, {teamA:"#9fc5ff", teamB:"#ffb38a"},
  {teamA:"#ffd38f", teamB:"#a7a0ff"}, {teamA:"#a7a0ff", teamB:"#ffd38f"},
  {teamA:"#ffa4cc", teamB:"#88e0c0"}, {teamA:"#88e0c0", teamB:"#ffa4cc"},
  {teamA:"#ffc19a", teamB:"#98b8ff"}, {teamA:"#98b8ff", teamB:"#ffc19a"},
  {teamA:"#ffabc2", teamB:"#90e5a8"}, {teamA:"#90e5a8", teamB:"#ffabc2"},
  {teamA:"#ffcf8e", teamB:"#88b6ff"}, {teamA:"#88b6ff", teamB:"#ffcf8e"},
  {teamA:"#ffa0a8", teamB:"#9fe0ff"}, {teamA:"#9fe0ff", teamB:"#ffa0a8"},
  {teamA:"#ffc8a0", teamB:"#8ea0ff"}, {teamA:"#8ea0ff", teamB:"#ffc8a0"},
  {teamA:"#ff95b8", teamB:"#8ef7c0"}, {teamA:"#8ef7c0", teamB:"#ff95b8"},
  {teamA:"#ffb28c", teamB:"#98d8ff"}, {teamA:"#98d8ff", teamB:"#ffb28c"},
  {teamA:"#ffdba0", teamB:"#92b4ff"}, {teamA:"#92b4ff", teamB:"#ffdba0"},
  {teamA:"#ff9ac8", teamB:"#8feac0"}, {teamA:"#8feac0", teamB:"#ff9ac8"},
  {teamA:"#ffc7a8", teamB:"#9fb0ff"}, {teamA:"#9fb0ff", teamB:"#ffc7a8"},
  {teamA:"#ffadc5", teamB:"#82ebd0"}, {teamA:"#82ebd0", teamB:"#ffadc5"},
  {teamA:"#ffd090", teamB:"#8abaff"}, {teamA:"#8abaff", teamB:"#ffd090"},
  {teamA:"#ffaac0", teamB:"#93e9b8"}, {teamA:"#93e9b8", teamB:"#ffaac0"},
  {teamA:"#ffce9c", teamB:"#8ec3ff"}, {teamA:"#8ec3ff", teamB:"#ffce9c"},
  {teamA:"#ff94d0", teamB:"#86efd0"}, {teamA:"#86efd0", teamB:"#ff94d0"},
  {teamA:"#ffc5a0", teamB:"#95b2ff"}, {teamA:"#95b2ff", teamB:"#ffc5a0"},
  {teamA:"#ffb0d0", teamB:"#7fe0b0"}, {teamA:"#7fe0b0", teamB:"#ffb0d0"},
  {teamA:"#ffd99e", teamB:"#8ab2ff"}, {teamA:"#8ab2ff", teamB:"#ffd99e"},
  {teamA:"#ff92b4", teamB:"#9ae5ff"}, {teamA:"#9ae5ff", teamB:"#ff92b4"},
  {teamA:"#ffba90", teamB:"#86b0ff"}, {teamA:"#86b0ff", teamB:"#ffba90"},

// ==============================
// 濃い色 × 白（コントラスト強化・整理版）
// ==============================

// 赤系（代表1色）
{teamA:"#FF1744", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#FF1744"},

// 紫系（代表1色）
{teamA:"#6200EA", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#6200EA"},

// 青系（代表1色）
{teamA:"#2962FF", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#2962FF"},

// 緑系（代表1色）
{teamA:"#1B5E20", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#1B5E20"},

// 黄・橙系（1色）
{teamA:"#FF9100", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#FF9100"},

// ピンク系（スプラ系代表）
{teamA:"#FF3CAC", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#FF3CAC"},

// シアン系
{teamA:"#00B0FF", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#00B0FF"},

// 茶系（モンハン代表）
{teamA:"#8B4513", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#8B4513"},

// 緑（鮮やか寄り・別系統）
{teamA:"#008000", teamB:"#ffffff"}, {teamA:"#ffffff", teamB:"#008000"}

];

const pickerWrapper = document.getElementById("teamPicker");
const pickerItemHeight = 30;

// アイテム作成（縦スクロール＆3周ループ）
for (let loop = 0; loop < 3; loop++) {
  teamCombos.forEach(c => {
    const div = document.createElement("div");
    div.className = "team-picker-item";

    const bgA = document.createElement("div");
    bgA.className = "team-scroll-bgA";
    bgA.style.background = c.teamA;

    const bgB = document.createElement("div");
    bgB.className = "team-scroll-bgB";
    bgB.style.background = c.teamB;

    const labelA = document.createElement("div");
    labelA.className = "team-scroll-labelA";
    labelA.textContent = "Aチーム";

    const labelB = document.createElement("div");
    labelB.className = "team-scroll-labelB";
    labelB.textContent = "Bチーム";

    div.appendChild(bgA);
    div.appendChild(bgB);
    div.appendChild(labelA);
    div.appendChild(labelB);

    pickerWrapper.appendChild(div);
  });
}


// 保存値があれば初期スクロール位置を設定
function setInitialScroll() {
  const savedA = localStorage.getItem("teamAColor");
  const savedB = localStorage.getItem("teamBColor");
  const items = document.querySelectorAll("#teamPicker .team-picker-item");

  if (savedA && savedB) {
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const cA = item.querySelector(".team-scroll-bgA").style.background;
      const cB = item.querySelector(".team-scroll-bgB").style.background;

      if (cA === savedA && cB === savedB) {
        const targetIndex = i % teamCombos.length;
        pickerWrapper.scrollTop = targetIndex * pickerItemHeight;
        break;
      }
    }
  } else {
    pickerWrapper.scrollTop = teamCombos.length * pickerItemHeight;
  }
}


// ===========================
// A/B 入替え対応版
// ===========================
function updateTeamPickerCenter() {
  const items = document.querySelectorAll("#teamPicker .team-picker-item");
  const wrapperRect = pickerWrapper.getBoundingClientRect();
  let closest = null;
  let minDist = Infinity;

  items.forEach(item => {
    const rect = item.getBoundingClientRect();
    const itemCenter = rect.top + rect.height / 2;
    const wrapperCenter = wrapperRect.top + wrapperRect.height / 2;
    const dist = Math.abs(itemCenter - wrapperCenter);
    if (dist < minDist) { minDist = dist; closest = item; }
  });

  items.forEach(it => it.classList.remove("center"));

  if (closest) {
    closest.classList.add("center");

    // スクロールバー左右の色
    const colorLeft = closest.querySelector(".team-scroll-bgA").style.background;
    const colorRight = closest.querySelector(".team-scroll-bgB").style.background;

    let finalA, finalB;

    // ★ A/B 入替え状態に応じて左右を反転 ★
    if (typeof isSwappedAB !== "undefined" && isSwappedAB) {
      // 入れ替え後：左 = B、右 = A
      finalA = colorRight;
      finalB = colorLeft;
    } else {
      // 通常：左 = A、右 = B
      finalA = colorLeft;
      finalB = colorRight;
    }

    // チーム背景更新
    document.querySelectorAll(".bg-teamA").forEach(el => el.style.background = finalA);
    document.querySelectorAll(".bg-teamB").forEach(el => el.style.background = finalB);

    // CSS変数更新
    document.documentElement.style.setProperty('--teamB-bg-color', finalB);

    // 保存
    localStorage.setItem("teamAColor", finalA);
    localStorage.setItem("teamBColor", finalB);

    // スコアに応じたブロックバー更新
    if (typeof updateScore === "function") updateScore();
  }
}


// スクロールイベント（無限スクロール）
pickerWrapper.addEventListener("scroll", () => {
  const maxScroll = pickerWrapper.scrollHeight - pickerWrapper.clientHeight;

  if (pickerWrapper.scrollTop < pickerItemHeight) {
    pickerWrapper.scrollTop += teamCombos.length * pickerItemHeight;
  } else if (pickerWrapper.scrollTop > maxScroll - pickerItemHeight) {
    pickerWrapper.scrollTop -= teamCombos.length * pickerItemHeight;
  }

  updateTeamPickerCenter();
});


// 初期表示
setInitialScroll();
updateTeamPickerCenter();

/* ------------------- チーム名と選手名背景色変更スクロールバー終り ------------------- */

/* ------------------- 得点盤文字色とロゴ背景色の変更（1回クリック即反映版） ------------------- */
(function(){
  const scorePicker = document.getElementById('scorePickerCustom');
  const ITEM_H = 40;
  const LOOPS = 3;

  let savedA = localStorage.getItem('scoreLastColorA') || '#0000FF';
  let savedB = localStorage.getItem('scoreLastColorB') || '#008000';

  function toRGB(color){
    const div = document.createElement("div");
    div.style.color = color;
    document.body.appendChild(div);
    const rgb = getComputedStyle(div).color;
    document.body.removeChild(div);
    return rgb;
  }

  function rgbToHex(rgb){
    const result = rgb.match(/\d+/g);
    if(!result) return '#000000';
    return "#" + result.map(x=>parseInt(x).toString(16).padStart(2,'0')).join('').toUpperCase();
  }

const brightCombos = [
  // ==============================
  // デフォルト（青/緑）
  // ==============================
  ["#00CED1","#D2691E"], ["#D2691E","#00CED1"],

  // ==============================
  // エヴァ風（紫 / 赤 / 黄 / 緑 / 青紫）
  // ==============================
  ["#7B00FF","#FFD700"], ["#FFD700","#7B00FF"],
  ["#FF0000","#00FF80"], ["#00FF80","#FF0000"],
  ["#FFC107","#3F51B5"], ["#3F51B5","#FFC107"],
  ["#8000FF","#00FF80"], ["#00FF80","#8000FF"],
  ["#FF3300","#1E90FF"], ["#1E90FF","#FF3300"],
  ["#FFEB3B","#673AB7"], ["#673AB7","#FFEB3B"],
  ["#4CAF50","#FF9800"], ["#FF9800","#4CAF50"],
  ["#9B4DFF","#FF8F00"], ["#FF8F00","#9B4DFF"],
  ["#D50000","#00BCD4"], ["#00BCD4","#D50000"],
  ["#FFCA28","#00C853"], ["#00C853","#FFCA28"],
  ["#66FFCC","#8E24AA"], ["#8E24AA","#66FFCC"],
  ["#E60000","#4CAF50"], ["#4CAF50","#E60000"],
  ["#FBC02D","#E91E63"], ["#E91E63","#FBC02D"],
  ["#00C853","#3F51B5"], ["#3F51B5","#00C853"],
  ["#7B00FF","#2196F3"], ["#2196F3","#7B00FF"],
  ["#00E676","#C62828"], ["#C62828","#00E676"],
  ["#FF1744","#8BC34A"], ["#8BC34A","#FF1744"],
  ["#00FF80","#FF6D00"], ["#FF6D00","#00FF80"],
  ["#FFD700","#1E90FF"], ["#1E90FF","#FFD700"],
  ["#7B00FF","#FF0000"], ["#FF0000","#7B00FF"],

  // ==============================
  // スプラトゥーン風
  // ==============================
  ["#FF3CAC","#00FFD4"], ["#00FFD4","#FF3CAC"],
  ["#FF9500","#1CE6FF"], ["#1CE6FF","#FF9500"],
  ["#FF1C1C","#B8FF1C"], ["#B8FF1C","#FF1C1C"],
  ["#FF6EC7","#6EFFA2"], ["#6EFFA2","#FF6EC7"],
  ["#FFEB3B","#00FF9D"], ["#00FF9D","#FFEB3B"],
  // --- 追加 ---
  ["#FF6F61","#61FF6F"], ["#61FF6F","#FF6F61"],
  ["#FFA07A","#20B2AA"], ["#20B2AA","#FFA07A"],
  ["#FF1493","#7FFF00"], ["#7FFF00","#FF1493"],
  ["#00FFFF","#FF4500"], ["#FF4500","#00FFFF"],

  // ==============================
  // マリオカート風
  // ==============================
  ["#FF0000","#00CC00"], ["#00CC00","#FF0000"],
  ["#FF8800","#0088FF"], ["#0088FF","#FF8800"],
  ["#FFEE00","#CC00FF"], ["#CC00FF","#FFEE00"],
  ["#FF4444","#44FF44"], ["#44FF44","#FF4444"],
  ["#FFAA33","#33AAFF"], ["#33AAFF","#FFAA33"],
  // --- 追加 ---
  ["#FF0000","#FFFF00"], ["#FFFF00","#FF0000"],
  ["#00FF00","#FF00FF"], ["#FF00FF","#00FF00"],
  ["#FF8C00","#1E90FF"], ["#1E90FF","#FF8C00"],
  ["#FF69B4","#00CED1"], ["#00CED1","#FF69B4"],

  // ==============================
  // ゼルダ風
  // ==============================
  ["#1B5E20","#FFD700"], ["#FFD700","#1B5E20"],
  ["#4CAF50","#FFEB3B"], ["#FFEB3B","#4CAF50"],
  ["#2E7D32","#FFC107"], ["#FFC107","#2E7D32"],
  ["#66BB6A","#FFEE58"], ["#FFEE58","#66BB6A"],
  ["#81C784","#FFF176"], ["#FFF176","#81C784"],

  // ==============================
  // カービィ風
  // ==============================
  ["#FF69B4","#FFD1DC"], ["#FFD1DC","#FF69B4"],
  ["#FF1493","#FFB6C1"], ["#FFB6C1","#FF1493"],
  ["#FF7F50","#FFE4E1"], ["#FFE4E1","#FF7F50"],
  ["#FF69B4","#FFC0CB"], ["#FFC0CB","#FF69B4"],
  ["#FF3399","#FF99CC"], ["#FF99CC","#FF3399"],

  // ==============================
  // ヨッシー風
  // ==============================
  ["#00FF00","#00CED1"], ["#00CED1","#00FF00"],
  ["#ADFF2F","#7FFFD4"], ["#7FFFD4","#ADFF2F"],
  ["#32CD32","#87CEFA"], ["#87CEFA","#32CD32"],
  ["#7CFC00","#40E0D0"], ["#40E0D0","#7CFC00"],
  ["#00FA9A","#00FFFF"], ["#00FFFF","#00FA9A"],

  // ==============================
  // モンハン風
  // ==============================
  ["#8B4513","#FF4500"], ["#FF4500","#8B4513"],
  ["#A0522D","#1E90FF"], ["#1E90FF","#A0522D"],
  ["#0000FF","#008000"], ["#008000","#0000FF"],
  ["#CD853F","#7B68EE"], ["#7B68EE","#CD853F"],
  ["#DEB887","#FF6347"], ["#FF6347","#DEB887"],
  // --- 追加 ---
  ["#8B0000","#FFD700"], ["#FFD700","#8B0000"],
  ["#006400","#FF8C00"], ["#FF8C00","#006400"],
  ["#4B0082","#FF4500"], ["#FF4500","#4B0082"],
  ["#2E8B57","#FF6347"], ["#FF6347","#2E8B57"],

  // ==============================
  // サンリオ風（正反対の色意識）
  // ==============================
  ["#FF1493","#00CED1"], ["#00CED1","#FF1493"],
  ["#FF4500","#1E90FF"], ["#1E90FF","#FF4500"],
  ["#FF69B4","#228B22"], ["#228B22","#FF69B4"],
  ["#FF8C00","#8A2BE2"], ["#8A2BE2","#FF8C00"],
  ["#FF0000","#00FFFF"], ["#00FFFF","#FF0000"],
  ["#FFD700","#6A5ACD"], ["#6A5ACD","#FFD700"],
  ["#FF6347","#008000"], ["#008000","#FF6347"],
  ["#FFA500","#0000FF"], ["#0000FF","#FFA500"],
  ["#FF69B4","#4B0082"], ["#4B0082","#FF69B4"],
  ["#FF4500","#00FF7F"], ["#00FF7F","#FF4500"],

  // ==============================
  // ポケモン風（正反対色＋はっきり色）
  // ==============================
  ["#FF0000","#1E90FF"], ["#1E90FF","#FF0000"],
  ["#FF8C00","#32CD32"], ["#32CD32","#FF8C00"],
  ["#00CED1","#FF4500"], ["#FF4500","#00CED1"],
  ["#8A2BE2","#FFD700"], ["#FFD700","#8A2BE2"],
  ["#FF1493","#00FA9A"], ["#00FA9A","#FF1493"],
  ["#FF6347","#0000CD"], ["#0000CD","#FF6347"],
  ["#1E90FF","#FF4500"], ["#FF4500","#1E90FF"],
  ["#FF0000","#00CED1"], ["#00CED1","#FF0000"],
  ["#32CD32","#FF0000"], ["#FF0000","#32CD32"],

  // ==============================
  // アンパンマン風（はっきり色＋対決）
  // ==============================
  ["#FF4500","#1E90FF"], ["#1E90FF","#FF4500"],
  ["#FF6347","#006400"], ["#006400","#FF6347"],
  ["#FFA500","#8B00FF"], ["#8B00FF","#FFA500"],
  ["#D2691E","#00CED1"], ["#00CED1","#D2691E"],
  ["#FF7F50","#0000FF"], ["#0000FF","#FF7F50"],
  ["#FFD700","#FF1493"], ["#FF1493","#FFD700"],
  ["#FF69B4","#008000"], ["#008000","#FF69B4"],
  ["#FF4500","#00FFFF"], ["#00FFFF","#FF4500"],
  ["#FFA500","#4B0082"], ["#4B0082","#FFA500"],
  ["#FF6347","#00FA9A"], ["#00FA9A","#FF6347"],

  // ==============================
  // ミックス追加
  // ==============================
  ["#FF4500","#00FF7F"], ["#00FF7F","#FF4500"],
  ["#FFD700","#FF1493"], ["#FF1493","#FFD700"],
  ["#00CED1","#FF6347"], ["#FF6347","#00CED1"],
  ["#ADFF2F","#FF69B4"], ["#FF69B4","#ADFF2F"],
  ["#1E90FF","#FFFF00"], ["#FFFF00","#1E90FF"],
  ["#FF8C00","#00FA9A"], ["#00FA9A","#FF8C00"],
  ["#7FFFD4","#FF00FF"], ["#FF00FF","#7FFFD4"],
  ["#FFB6C1","#00BFFF"], ["#00BFFF","#FFB6C1"],
  ["#FF4500","#00FFFF"], ["#00FFFF","#FF4500"],
  ["#FFD700","#00FF7F"], ["#00FF7F","#FFD700"],

  // ==============================
  // 追加20パターン
  // ==============================
  ["#FF6347","#7FFFD4"], ["#7FFFD4","#FF6347"],
  ["#00FA9A","#FF69B4"], ["#FF69B4","#00FA9A"],
  ["#1E90FF","#FF1493"], ["#FF1493","#1E90FF"],
  ["#FFD700","#8B0000"], ["#8B0000","#FFD700"],
  ["#FF8C00","#00CED1"], ["#00CED1","#FF8C00"],
  ["#ADFF2F","#FF4500"], ["#FF4500","#ADFF2F"],
  ["#32CD32","#FF00FF"], ["#FF00FF","#32CD32"],
  ["#7CFC00","#FF1493"], ["#FF1493","#7CFC00"],
  ["#00CED1","#FF8C00"], ["#FF8C00","#00CED1"],
  ["#D2691E","#00FFFF"], ["#00FFFF","#D2691E"]
];

  // スクロール内容構築
  function scorePickerBuild(){
    scorePicker.innerHTML='';
    for(let loop=0; loop<LOOPS; loop++){
      brightCombos.forEach((c, idx)=>{
        const item = document.createElement('div');
        item.className='scorePicker-item';
        item.dataset.baseIndex=idx;

        const bgA = document.createElement('div');
        bgA.className='scorePicker-bgA';
        bgA.style.background=c[0];

        const bgB = document.createElement('div');
        bgB.className='scorePicker-bgB';
        bgB.style.background=c[1];

        const labelA = document.createElement('div');
        labelA.className='scorePicker-labelA';
        labelA.innerHTML='<span>A</span>';

        const labelB = document.createElement('div');
        labelB.className='scorePicker-labelB';
        labelB.innerHTML='<span>D</span>';

        item.appendChild(bgA);
        item.appendChild(bgB);
        item.appendChild(labelA);
        item.appendChild(labelB);
        scorePicker.appendChild(item);

        // ★クリックで即反映
        item.addEventListener('click', () => {
          forceApplyScore(item);
        });
      });
    }
  }

  // 中央色を即適用する処理（改良版）
  function forceApplyScore(item){
  if(!item) return;
  const colorA = item.querySelector('.scorePicker-bgA').style.background || '#0000FF';
  const colorB = item.querySelector('.scorePicker-bgB').style.background || '#008000';

  const applyColors = () => {
    document.querySelectorAll('#pointAFlip .front, #pointAFlip .back').forEach(el=>el.style.color=colorA);
    document.querySelectorAll('#pointBFlip .front, #pointBFlip .back').forEach(el=>el.style.color=colorB);
    document.querySelectorAll('#gameAFront, #gameABack').forEach(el=>el.style.color=colorA);
    document.querySelectorAll('#gameBFront, #gameBBack').forEach(el=>el.style.color=colorB);

    const lblA = item.querySelector('.scorePicker-labelA span');
    const lblB = item.querySelector('.scorePicker-labelB span');
    if(lblA) lblA.style.color=colorA;
    if(lblB) lblB.style.color=colorB;

    const rogo = document.querySelector('.rogo-text');
    if(rogo){
      rogo.style.background = `linear-gradient(to bottom, ${colorA} 50%, ${colorB} 50%)`;
      rogo.style.color='#fff';
    }

    localStorage.setItem('scoreLastColorA', colorA);
    localStorage.setItem('scoreLastColorB', colorB);
  };

  requestAnimationFrame(applyColors);
}

  // 中央色更新（スクロール用）
  function scorePickerUpdate(){
    const items = Array.from(scorePicker.querySelectorAll('.scorePicker-item'));
    if(items.length===0) return;

    const wrapperRect = scorePicker.getBoundingClientRect();
    let closest = null;
    let minDist = Infinity;

    items.forEach(it=>{
      const r = it.getBoundingClientRect();
      const d = Math.abs(r.top + r.height/2 - (wrapperRect.top+wrapperRect.height/2));
      if(d < minDist){
        minDist = d;
        closest = it;
      }
    });

    items.forEach(it=>it.classList.remove('center'));
    if(!closest) return;
    closest.classList.add('center');

    // スクロールで色変更も即適用
    forceApplyScore(closest);
  }

  function scorePickerSetInitial(){
    requestAnimationFrame(()=>{
      const items = Array.from(scorePicker.querySelectorAll('.scorePicker-item'));
      if(savedA && savedB){
        for(let i=0; i<items.length; i++){
          const bgA = rgbToHex(toRGB(items[i].querySelector('.scorePicker-bgA').style.background));
          const bgB = rgbToHex(toRGB(items[i].querySelector('.scorePicker-bgB').style.background));

          if(bgA === savedA && bgB === savedB){
            const baseIdx = items[i].dataset.baseIndex;
            scorePicker.scrollTop = Number(baseIdx)*ITEM_H + brightCombos.length*ITEM_H;
            scorePickerUpdate();
            return;
          }
        }
      }
      scorePicker.scrollTop = brightCombos.length*ITEM_H;
      scorePickerUpdate();
    });
  }

  // スクロール無限ループ
  scorePicker.addEventListener('scroll', ()=>{
    const max = scorePicker.scrollHeight - scorePicker.clientHeight;
    if(scorePicker.scrollTop < ITEM_H) scorePicker.scrollTop += brightCombos.length*ITEM_H;
    else if(scorePicker.scrollTop > max - ITEM_H) scorePicker.scrollTop -= brightCombos.length*ITEM_H;
    scorePickerUpdate();
  });

  scorePickerBuild();
  scorePickerSetInitial();
})();

/* ------------------- 得点盤文字色とロゴ背景色の変更（1回クリック即反映版） ------------------- */

/* ------------------- 背景とコートの色（テニス風パターン） ------------------- */
const combos = [
  // ===========================
  // ✅ デフォルト（維持）
  // ===========================
  {court:"#228B22", out:"#006400"},
  {court:"#32CD32", out:"#006400"},

  // ===========================
  // ✅ ハード（青系）
  // ===========================
  {court:"#1E90FF", out:"#006400"},
  {court:"#4169E1", out:"#006400"},
  {court:"#4682B4", out:"#006400"},
  {court:"#00CED1", out:"#006400"},
  {court:"#87CEEB", out:"#006400"},

  // ===========================
  // ✅ クレー（茶・橙系）
  // ===========================
  {court:"#D2691E", out:"#8B4513"},
  {court:"#FF7F50", out:"#A0522D"},
  {court:"#CD853F", out:"#8B4513"},
  {court:"#FFA07A", out:"#A0522D"},
  {court:"#FF8C00", out:"#8B4513"},
  {court:"#F4A460", out:"#8B4513"},
  {court:"#FF4500", out:"#A0522D"},

  // ===========================
  // ✅ 芝（緑系）
  // ===========================
  {court:"#006400", out:"#228B22"},
  {court:"#2E8B57", out:"#006400"},
  {court:"#008000", out:"#006400"},
  {court:"#3CB371", out:"#2E8B57"},

  // ===========================
  // ✅ 混合（実在しそう）
  // ===========================
  {court:"#1E90FF", out:"#8B4513"},
  {court:"#D2691E", out:"#2E8B57"},
  {court:"#FF7F50", out:"#006400"},
  {court:"#228B22", out:"#A0522D"},
  {court:"#4169E1", out:"#8B4513"},
  {court:"#FF4500", out:"#2E8B57"},

  // ===========================
  // ✅ 明度調整版：青系
  // ===========================
  {court:"#1C6FD1", out:"#2E8B57"},
  {court:"#4A7EC1", out:"#006400"},
  {court:"#3A5FB4", out:"#228B22"},
  {court:"#2F4F4F", out:"#8B4513"},
  {court:"#4F8FC1", out:"#2E8B57"},

  // ===========================
  // ✅ 明度調整版：緑系
  // ===========================
  {court:"#6BD600", out:"#006400"},
  {court:"#82D682", out:"#2E8B57"},
  {court:"#7AAE2E", out:"#228B22"},
  {court:"#536D1F", out:"#8B4513"},
  {court:"#2CBF2C", out:"#4B5320"},

  // ===========================
  // ✅ 明度調整版：茶系
  // ===========================
  {court:"#A0522D", out:"#5C4033"},
  {court:"#8B4513", out:"#D2691E"},
  {court:"#CD853F", out:"#A0522D"},
  {court:"#DEB887", out:"#8B4513"},
  {court:"#D2B48C", out:"#A0522D"},
  {court:"#BC8F8F", out:"#8B4513"},

  // ===========================
  // ✅ 青×茶 混合
  // ===========================
  {court:"#1E78D1", out:"#A0522D"},
  {court:"#3E6F9A", out:"#8B4513"},
  {court:"#4F8FC1", out:"#A0522D"},
  {court:"#009FCC", out:"#8B4513"},

  // ===========================
  // ✅ 緑×茶
  // ===========================
  {court:"#1E7A1E", out:"#A0522D"},
  {court:"#2CBF2C", out:"#8B4513"},
  {court:"#536D1F", out:"#D2691E"},
  {court:"#4A5E2A", out:"#A0522D"},
  {court:"#6BD600", out:"#8B4513"},

  // ===========================
  // ✅ ダーク系
  // ===========================
  {court:"#2F4F4F", out:"#32CD32"},
  {court:"#1C1C1C", out:"#6B8E23"},
  {court:"#2E2E2E", out:"#8B4513"},
  {court:"#3A3A3A", out:"#228B22"},
  {court:"#4F4F4F", out:"#D2691E"},

  // ===========================
  // ✅ 体育館系（木床）
  // ===========================
  {court:"#D4B57A", out:"#505050"},
  {court:"#CDB078", out:"#406080"},
  {court:"#D9C092", out:"#505050"},
  {court:"#CBB67E", out:"#4070A0"},
  {court:"#D6C184", out:"#505050"},
  {court:"#CCB072", out:"#3060A0"},
  {court:"#E0D19A", out:"#505050"},
  {court:"#D8C48C", out:"#4070A0"},
  {court:"#D9D09A", out:"#306080"},

  // ===========================
  // ✅ 非現実的・明るめコート × 暗めアウト
  // ===========================
  {court:"#FFFF00", out:"#006666"},
  {court:"#FF69B4", out:"#660033"},
  {court:"#FFA500", out:"#334400"},
  {court:"#FF4500", out:"#333300"},
  {court:"#7CFC00", out:"#003300"},
  {court:"#00FFFF", out:"#004444"},
  {court:"#FF00FF", out:"#440044"},
  {court:"#00FF7F", out:"#004422"},
  {court:"#FFD700", out:"#664400"},
  {court:"#7FFF00", out:"#336600"},
  {court:"#00FF00", out:"#003300"},
  {court:"#FF6347", out:"#332200"},
  {court:"#FF1493", out:"#440033"},
  {court:"#FFA07A", out:"#443300"},
  {court:"#00FFFF", out:"#002222"},
  {court:"#FFD700", out:"#332200"},
  {court:"#FF4500", out:"#330011"},
  {court:"#7FFF00", out:"#223300"},
  {court:"#FF00FF", out:"#330033"},
  {court:"#00FF7F", out:"#002211"},
];

const wrapper = document.getElementById("picker");
const itemHeight = 30;

// アイテム生成
for(let loop=0; loop<3; loop++){
  combos.forEach(c=>{
    const div = document.createElement("div");
    div.className = "picker-item";

    const bgCourt = document.createElement("div");
    bgCourt.className = "bg-court";
    bgCourt.style.background = c.court;

    const bgOut = document.createElement("div");
    bgOut.className = "bg-out";
    bgOut.style.background = c.out;

    const divider = document.createElement("div");
    divider.className = "divider";
    const dividerLeft = document.createElement("div");
    dividerLeft.className = "divider-left";

    const labelCourt = document.createElement("div");
    labelCourt.className = "label-court";
    labelCourt.textContent = "イン";

    const labelOut = document.createElement("div");
    labelOut.className = "label-out";
    labelOut.textContent = "アウト";

    div.appendChild(bgCourt);
    div.appendChild(bgOut);
    div.appendChild(divider);
    div.appendChild(dividerLeft);
    div.appendChild(labelCourt);
    div.appendChild(labelOut);

    wrapper.appendChild(div);
  });
}

// 中央アイテム判定
function updateCenter(){
  const items = document.querySelectorAll(".picker-item");
  const wrapperRect = wrapper.getBoundingClientRect();
  let closest = null;
  let minDist = Infinity;
  items.forEach(item=>{
    const rect = item.getBoundingClientRect();
    const itemCenter = rect.top + rect.height/2;
    const wrapperCenter = wrapperRect.top + wrapperRect.height/2;
    const dist = Math.abs(itemCenter - wrapperCenter);
    if(dist<minDist){ minDist = dist; closest = item; }
  });
  items.forEach(it=>it.classList.remove("center"));
  if(closest){
    closest.classList.add("center");
    const courtColor = closest.querySelector(".bg-court").style.background;
    const outColor = closest.querySelector(".bg-out").style.background;

    document.getElementById("courtContainer").style.background = courtColor;
    document.body.style.background = outColor;

    // PWA用 theme-color を更新
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if(metaTheme) metaTheme.setAttribute("content", outColor);

    return {courtColor, outColor};
  }
}

// 保存色に合わせて中央アイテムを初期選択
function selectSavedItem(){
  const savedCourt = localStorage.getItem('courtColor');
  const savedOut = localStorage.getItem('outColor');
  const savedScroll = localStorage.getItem('scrollTop');
  const items = document.querySelectorAll(".picker-item");

  if(savedScroll){
    wrapper.scrollTop = parseInt(savedScroll,10);
    updateCenter();
    return;
  }

  if(savedCourt && savedOut){
    for(let i=0; i<items.length; i++){
      const item = items[i];
      const cCourt = item.querySelector(".bg-court").style.background;
      const cOut = item.querySelector(".bg-out").style.background;
      if(cCourt === savedCourt && cOut === savedOut){
        const targetIndex = i % combos.length;
        wrapper.scrollTop = targetIndex * itemHeight;
        updateCenter();
        return;
      }
    }
  }

  // 保存なしの場合は従来通り中央アイテム
  wrapper.scrollTop = combos.length * itemHeight;
  updateCenter();
}

// 無限スクロール + 保存
let scrollTimer;
wrapper.addEventListener("scroll", ()=>{
  const maxScroll = wrapper.scrollHeight - wrapper.clientHeight;
  if(wrapper.scrollTop < itemHeight){
    wrapper.scrollTop += combos.length*itemHeight;
  } else if(wrapper.scrollTop > maxScroll - itemHeight){
    wrapper.scrollTop -= combos.length*itemHeight;
  }

  clearTimeout(scrollTimer);
  scrollTimer = setTimeout(()=>{
    const colors = updateCenter();
    if(colors){
      localStorage.setItem('courtColor', colors.courtColor);
      localStorage.setItem('outColor', colors.outColor);
      localStorage.setItem('scrollTop', wrapper.scrollTop);
    }
  }, 150);
});

// 初期表示
window.addEventListener("load", selectSavedItem);

/* ------------------- 背景とコートの色（終り） ------------------- */

/* ------------------- 色の組み合わせお気に入り ------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const DEFAULT_FAVORITE = {
    team_scroll_bgA: "#FFFFFF",
    team_scroll_bgB: "#FFFF00",
    scoreA_color: "#00CED1",
    scoreB_color: "#D2691E",
    court: "#228B22",
    out: "#006400"
  };
  const MAX_FAVORITES = 5;
  const ITEM_H = 30;
  const SAVE_TIME = 2000;
  const DELETE_THRESHOLD = 180;

  const favWrapper = document.getElementById('favoritesPicker');
  if (!favWrapper) return;

  let favorites = JSON.parse(localStorage.getItem('favorites3bars')) || Array(MAX_FAVORITES).fill(null);
  const TOTAL_ITEMS = MAX_FAVORITES + 1; // 0=★ + 5 favorites

  function rgbToHex(rgb) {
    if (!rgb) return "#000000";
    if (rgb.startsWith("#")) return rgb.toUpperCase();
    const m = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!m) return "#000000";
    return "#" + [1, 2, 3].map(i => parseInt(m[i]).toString(16).padStart(2, '0')).join('').toUpperCase();
  }

  function getFavoriteByDisplayIndex(displayIndex) {
    return displayIndex === 0 ? DEFAULT_FAVORITE : favorites[displayIndex - 1];
  }

  function updateFavoritesActive() {
    const displayIndex = getCenterFavoriteIndex();
    favWrapper.querySelectorAll('.favorites-picker-item').forEach((item, idx) => {
      item.classList.toggle('active', idx % TOTAL_ITEMS === displayIndex);
    });
  }

  function getCenterFavoriteIndex() {
    const scrollTop = favWrapper.scrollTop;
    return Math.round(scrollTop / ITEM_H) % TOTAL_ITEMS;
  }

 function buildFavoritesPicker() {
  const currentScroll = favWrapper.scrollTop;
  favWrapper.innerHTML = '';
  const LOOP_COUNT = 100;

  for (let loop = 0; loop < LOOP_COUNT; loop++) {
    for (let idx = 0; idx < TOTAL_ITEMS; idx++) {

      const div = document.createElement('div');
      div.className = 'favorites-picker-item';
      div.dataset.index = idx;

      const numberSpan = document.createElement('span');
      numberSpan.className = 'number';
      numberSpan.textContent = idx === 0 ? '★' : ['①', '②', '③', '④', '⑤'][idx - 1];
      div.appendChild(numberSpan);

      // ★ ここで新しいキー名で取得
      const data = getFavoriteByDisplayIndex(idx);

      const blocks = [
        { key: 'team_scroll_bgA', text: 'Aチーム', cls: 'left' },
        { key: 'team_scroll_bgB', text: 'Bチーム', cls: 'left' },
        { key: 'scoreA_color', text: 'A', cls: 'middle' },
        { key: 'scoreB_color', text: 'D', cls: 'middle' },
        { key: 'court', text: 'イン', cls: 'right' },
        { key: 'out', text: 'アウト', cls: 'right' }
      ];

      blocks.forEach((b, i) => {
        const block = document.createElement('div');
        block.className = `fav-color ${b.cls}`;

        const span = document.createElement('span');
        span.textContent = b.text;

        if (data) {
          if (b.cls === 'middle') {
            // A/D の黒背景のまま上に色文字を乗せる
            block.style.background = '#000';
            span.style.color = data[b.key];
          } else {
            // レフト・ライト・イン・アウト
            block.style.background = data[b.key];
            span.style.color = (i >= 4) ? '#fff' : '#000';
          }
        }

        block.appendChild(span);
        div.appendChild(block);
      });

      // ★ スワイプ削除 ＆ 長押し保存（以前の仕様そのまま）
      if (idx !== 0) {
        div.style.position = 'relative';

        /* 長押しによる保存バー（現在は透明水色） */
        const saveBar = document.createElement('div');
        saveBar.className = 'longpress-save';
        saveBar.style.position = 'absolute';
        saveBar.style.top = '0';
        saveBar.style.left = '0';
        saveBar.style.height = '100%';
        saveBar.style.width = '0%';
        saveBar.style.background = 'linear-gradient(90deg, rgba(255,0,0,0.4), rgba(255,165,0,0.4), rgba(255,255,0,0.4), rgba(0,255,0,0.4), rgba(0,0,255,0.4), rgba(75,0,130,0.4), rgba(238,130,238,0.4))'; // ← ここを虹色に修正したい
        saveBar.style.borderRadius = '2px';
        div.appendChild(saveBar);


// ===== 1回だけ宣言 =====
let saveTimer, saveInterval;

const startPress = () => {
  const startTime = Date.now();
  saveBar.style.width = '0%';

  saveInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    saveBar.style.width = Math.min(100, (elapsed / SAVE_TIME) * 100) + '%';
  }, 50);

  saveTimer = setTimeout(() => {
    saveFavorite(idx - 1);
    clearInterval(saveInterval);
    saveBar.style.width = '0%';
  }, SAVE_TIME);
};

const cancelPress = () => {
  clearTimeout(saveTimer);
  clearInterval(saveInterval);
  saveBar.style.width = '0%';
};

// ===== 既存（そのまま）=====
div.addEventListener('mousedown', startPress);
div.addEventListener('mouseup', cancelPress);
div.addEventListener('mouseleave', cancelPress);
div.addEventListener('touchstart', startPress);
div.addEventListener('touchend', cancelPress);
div.addEventListener('touchcancel', cancelPress);

// ===== ★ 追加するのはここだけ =====
let pointerActive = false;

div.addEventListener('pointerdown', (e) => {
  pointerActive = true;
  e.preventDefault(); // ← OSの長押しだけ無効化
});

div.addEventListener('pointerup', () => {
  pointerActive = false;
});

div.addEventListener('pointerleave', () => {
  pointerActive = false;
});

div.addEventListener('pointercancel', () => {
  pointerActive = false;
});

        // スワイプ削除
        let startX = 0, currentX = 0, isDragging = false;

        const startDrag = x => {
          startX = x;
          currentX = x;
          isDragging = true;
          div.style.transition = 'none';
        };

        const moveDrag = x => {
          if (!isDragging) return;
          currentX = x;
          div.style.transform = `translateX(${currentX - startX}px)`;
        };

        const endDrag = () => {
          if (!isDragging) return;
          isDragging = false;

          const delta = currentX - startX;

          if (Math.abs(delta) > DELETE_THRESHOLD) {
            div.style.transition = '0.2s';
            div.style.transform = `translateX(${delta > 0 ? 200 : -200}px)`;
            setTimeout(() => deleteFavorite(idx - 1), 200);
          } else {
            div.style.transition = '0.2s';
            div.style.transform = 'translateX(0)';
          }
        };

        div.addEventListener('mousedown', e => startDrag(e.clientX));
        document.addEventListener('mousemove', e => isDragging && moveDrag(e.clientX));
        document.addEventListener('mouseup', endDrag);

        div.addEventListener('touchstart', e => startDrag(e.touches[0].clientX));
        div.addEventListener('touchmove', e => moveDrag(e.touches[0].clientX));
        div.addEventListener('touchend', endDrag);
      }

      div.addEventListener('click', () => {
        const realIndex = parseInt(div.dataset.index);
        applyFavorite(realIndex);
      });

      favWrapper.appendChild(div);
    }
  }

  requestAnimationFrame(() => {
    favWrapper.scrollTop = currentScroll === 0 ? TOTAL_ITEMS * ITEM_H : currentScroll;
    updateFavoritesActive();
  });
}

favWrapper.addEventListener('scroll', () => {
  const maxScroll = favWrapper.scrollHeight - favWrapper.clientHeight;
  const SAFE_ZONE = ITEM_H * 2;

  if (favWrapper.scrollTop < SAFE_ZONE) {
    requestAnimationFrame(() => {
      favWrapper.scrollTop += TOTAL_ITEMS * ITEM_H;
    });
  } else if (favWrapper.scrollTop > maxScroll - SAFE_ZONE) {
    requestAnimationFrame(() => {
      favWrapper.scrollTop -= TOTAL_ITEMS * ITEM_H;
    });
  }

  updateFavoritesActive();
});

  /* --------------------------------------------------------
      得点盤にも1回クリックで全て反映
     -------------------------------------------------------- */
  function forceApplyScoreColor(lblA, lblB, f) {
    if (!lblA || !lblB) return;

    const colorA = f.scoreA_color;
    const colorB = f.scoreB_color;

    const applyColors = () => {
      document.querySelectorAll('#pointAFlip .front, #pointAFlip .back').forEach(el => el.style.color = colorA);
      document.querySelectorAll('#pointBFlip .front, #pointBFlip .back').forEach(el => el.style.color = colorB);
      document.querySelectorAll('#gameAFront, #gameABack').forEach(el => el.style.color = colorA);
      document.querySelectorAll('#gameBFront, #gameBBack').forEach(el => el.style.color = colorB);

      lblA.style.color = colorA;
      lblB.style.color = colorB;

      const rogo = document.querySelector('.rogo-text');
      if (rogo) {
        rogo.style.background = `linear-gradient(to bottom, ${colorA} 50%, ${colorB} 50%)`;
        rogo.style.color = '#fff';
      }

      localStorage.setItem('scoreLastColorA', colorA);
      localStorage.setItem('scoreLastColorB', colorB);
    };

    requestAnimationFrame(() => { applyColors(); requestAnimationFrame(applyColors); });
  }

  function applyFavorite(displayIndex) {
    const f = getFavoriteByDisplayIndex(displayIndex);
    if (!f) return;

    // チーム
    const teamWrapper = document.getElementById('teamPicker');
    if (teamWrapper) {
    const items = teamWrapper.querySelectorAll('.team-picker-item');
    const centerIndex = Math.floor(items.length / 3);
    const item = items[centerIndex];
    const bgA = item.querySelector('.team-scroll-bgA');
    const bgB = item.querySelector('.team-scroll-bgB');
    if (bgA) bgA.style.background = f.team_scroll_bgA;
    if (bgB) bgB.style.background = f.team_scroll_bgB;
    teamWrapper.scrollTop = ITEM_H * centerIndex;
    if (typeof updateTeamPickerCenter === 'function') updateTeamPickerCenter();
   }


    // コート
    const courtWrapper = document.getElementById('picker');
    if (courtWrapper) {
      const items = courtWrapper.querySelectorAll('.picker-item');
      const centerIndex = Math.floor(items.length / 3);
      const item = items[centerIndex];
      const bgCourt = item.querySelector('.bg-court');
      const bgOut = item.querySelector('.bg-out');
      if (bgCourt) bgCourt.style.background = f.court;
      if (bgOut) bgOut.style.background = f.out;
      courtWrapper.scrollTop = ITEM_H * centerIndex;
      if (typeof updateCenter === 'function') updateCenter();
    }

    // 得点盤
    const scoreWrapper = document.getElementById('scorePickerCustom');
    if (scoreWrapper) {
      const items = scoreWrapper.querySelectorAll('.scorePicker-item');
      const centerIndex = Math.floor(items.length / 3);
      const item = items[centerIndex];
      const lblA = item.querySelector('.scorePicker-labelA span');
      const lblB = item.querySelector('.scorePicker-labelB span');

      forceApplyScoreColor(lblA, lblB, f);

      scoreWrapper.scrollTop = ITEM_H * centerIndex;
    }
  }

  function deleteFavorite(realIndex) {
    favorites[realIndex] = null;
    localStorage.setItem('favorites3bars', JSON.stringify(favorites));
    buildFavoritesPicker();
  }

function saveFavorite(realIndex) {

  /* ------------------- スコアスクロールバーの色取得 ------------------- */
  const scoreWrapper = document.getElementById('scorePickerCustom');
  let colorA = '#FFFFFF', colorB = '#FFFFFF';

  if (scoreWrapper) {
    const wrapperRect = scoreWrapper.getBoundingClientRect();
    const items = Array.from(scoreWrapper.querySelectorAll('.scorePicker-item'));
    let closest = null, minDist = Infinity;

    items.forEach(it => {
      const r = it.getBoundingClientRect();
      const d = Math.abs(r.top + r.height / 2 - (wrapperRect.top + wrapperRect.height / 2));
      if (d < minDist) { minDist = d; closest = it; }
    });

    if (closest) {
      const lblA = closest.querySelector('.scorePicker-labelA span');
      const lblB = closest.querySelector('.scorePicker-labelB span');
      if (lblA) colorA = rgbToHex(lblA.style.color);
      if (lblB) colorB = rgbToHex(lblB.style.color);
    }
  }


  /* ------------------- チームスクロールバーの色取得（修正点） ------------------- */
  const teamWrapper = document.getElementById('teamPicker');
  let teamA = '#FF0000';
  let teamB = '#00FF00';

  if (teamWrapper) {
    const wrapperRect = teamWrapper.getBoundingClientRect();
    const items = Array.from(teamWrapper.querySelectorAll('.team-picker-item'));
    let closest = null, minDist = Infinity;

    items.forEach(it => {
      const r = it.getBoundingClientRect();
      const d = Math.abs(r.top + r.height / 2 - (wrapperRect.top + wrapperRect.height / 2));
      if (d < minDist) { minDist = d; closest = it; }
    });

    if (closest) {
      const bgA = closest.querySelector('.team-scroll-bgA');
      const bgB = closest.querySelector('.team-scroll-bgB');
      if (bgA) teamA = rgbToHex(bgA.style.background);
      if (bgB) teamB = rgbToHex(bgB.style.background);
    }
  }


  /* ------------------- ローカル保存データ作成 ------------------- */
  const colors = {
    team_scroll_bgA: teamA,
    team_scroll_bgB: teamB,
    scoreA_color: colorA,
    scoreB_color: colorB,
    court: rgbToHex(document.getElementById('courtContainer')?.style.background) || '#444444',
    out: rgbToHex(document.body.style.background) || '#222222'
  };

  favorites[realIndex] = colors;
  localStorage.setItem('favorites3bars', JSON.stringify(favorites));

  buildFavoritesPicker();
}

buildFavoritesPicker();

});
/* ------------------- 色の組み合わせお気に入り終り ------------------- */

/* ------------------- アプリURLをコピーして友達に共有 ------------------- */

document.getElementById('copyURL').addEventListener('click', () => {
  const urlField = document.getElementById('appURL');
  urlField.select();
  urlField.setSelectionRange(0, 99999); // スマホ対応

  navigator.clipboard.writeText(urlField.value)
    .then(() => {
      // コピー成功時にシンプルダイアログを表示
      showSimpleAlert("URLをコピーしました!");
    })
    .catch(() => {
      showSimpleAlert("コピーに失敗しました");
    });
});

/* ------------------- アプリURLをコピーして友達に共有 ------------------- */

/* ------------------- お天気 高速安全版（最終・アラート付き） ------------------- */

const locationCache = {};
let isSearching = false;
let safeDateInterval = null;
let lastRegion = "地域";
let lastSearchedRegion = localStorage.getItem("lastSearchedRegion") || "";
let lastLat = 37.75;
let lastLon = 140.47;
let weatherInterval = null;

// 日時表示（午前／午後＋⏰＋秒控えめ＋曜日色分け）
function getSafeJapaneseDateTime() {
    const d = new Date();
    const y = d.getFullYear() - 2018;
    const m = d.getMonth() + 1;
    const day = d.getDate();

    const weekIndex = d.getDay();
    const weekChar = ['日','月','火','水','木','金','土'][weekIndex];

    let weekClass = 'week-weekday';
    if (weekIndex === 0) weekClass = 'week-sun';
    if (weekIndex === 6) weekClass = 'week-sat';

    // 午前・午後
    const hour24 = d.getHours();
    const ampm = hour24 < 12 ? '午前' : '午後';

    // 12時間制
    let hour12 = hour24 % 12;
    if (hour12 === 0) hour12 = 12;

    const h = String(hour12).padStart(2,'0');
    const min = String(d.getMinutes()).padStart(2,'0');
    const sec = String(d.getSeconds()).padStart(2,'0');

 return `令和${y}年${m}月${day}日（<span class="${weekClass}">${weekChar}</span>）
 <span style="margin-left:4px;">${ampm}</span>
 ${h}:${min}<span style="opacity:0.7;font-size:0.9em">:${sec}</span>`;

}

function startSafeDateTime() {
    const box = document.getElementById("safeDateTimeBox");
    if (!box) return;
    if (safeDateInterval) clearInterval(safeDateInterval);

    // 初回表示
    box.innerHTML = getSafeJapaneseDateTime();

    // 1秒ごと更新
    safeDateInterval = setInterval(() => {
        box.innerHTML = getSafeJapaneseDateTime();
    }, 1000);
}

window.addEventListener("DOMContentLoaded", startSafeDateTime);

// 天気コード変換
function codeToWeather(code) {
    const map = {
        0: {name:'快晴', icon:'<i class="wi wi-day-sunny"></i>'},
        1: {name:'晴れ', icon:'<i class="wi wi-day-sunny"></i>'},
        2: {name:'薄曇', icon:'<i class="wi wi-day-cloudy"></i>'},
        3: {name:'曇り', icon:'<i class="wi wi-cloud"></i>'},
        45:{name:'霧', icon:'<i class="wi wi-fog"></i>'},
        48:{name:'濃霧', icon:'<i class="wi wi-fog"></i>'},
        51:{name:'霧雨（弱）', icon:'<i class="wi wi-sprinkle"></i>'},
        53:{name:'霧雨', icon:'<i class="wi wi-sprinkle"></i>'},
        55:{name:'霧雨（強）', icon:'<i class="wi wi-sprinkle"></i>'},
        61:{name:'弱い雨', icon:'<i class="wi wi-showers"></i>'},
        63:{name:'雨', icon:'<i class="wi wi-rain"></i>'},
        65:{name:'強い雨', icon:'<i class="wi wi-rain-wind"></i>'},
        66:{name:'みぞれ（弱）', icon:'<i class="wi wi-sleet"></i>'},
        67:{name:'みぞれ（強）', icon:'<i class="wi wi-sleet"></i>'},
        71:{name:'弱い雪', icon:'<i class="wi wi-snow"></i>'},
        73:{name:'雪', icon:'<i class="wi wi-snow"></i>'},
        75:{name:'大雪', icon:'<i class="wi wi-snowflake-cold"></i>'},
        77:{name:'雪粒', icon:'<i class="wi wi-snowflake-cold"></i>'},
        85:{name:'にわか雪（弱）', icon:'<i class="wi wi-snow"></i>'},
        86:{name:'にわか雪（強）', icon:'<i class="wi wi-snow-wind"></i>'},
        95:{name:'雷雨', icon:'<i class="wi wi-thunderstorm"></i>'},
        96:{name:'雷雨（雹）', icon:'<i class="wi wi-hail"></i>'},
        97:{name:'激しい雷雨', icon:'<i class="wi wi-storm-showers"></i>'},
        default:{name:"不明", icon:''}
    };
    return map[code] || map.default;
}

// 天気ボックス用: 市まで
function formatCityAddress(address) {
    if (!address) return "不明";

    // 市区町村を最優先
    if (address.city) return address.city;
    if (address.county) return address.county;
    if (address.municipality) return address.municipality;

    // 市が無い場合は県を表示
    if (address.province) return address.province;

    return "不明";
}

// ダイアログ用: 町までフル
function formatFullAddress(address) {
    if (!address) return "";
    const parts = [
        address.province,
        address.city || address.county,
        address.ward,
        address.town || address.suburb || address.hamlet || address.quarter
    ];
    return parts.filter(Boolean).join("");
}

// フォント調整
function adjustFontSize(el, max=13, min=8) {
    el.style.fontSize = max+"px";
    if(el.scrollWidth > el.clientWidth) el.style.fontSize = min+"px";
}

// 天気取得
function loadWeather(lat, lon, displayRegion) {
    lastLat = lat;
    lastLon = lon;

    const url = `https://api.open-meteo.com/v1/forecast
?latitude=${lat}
&longitude=${lon}
&current_weather=true
&hourly=precipitation_probability,apparent_temperature
&timezone=Asia/Tokyo`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const w = data.current_weather;
            const hour = new Date().getHours();
            const precipProb = data.hourly.precipitation_probability[hour];
            const info = codeToWeather(w.weathercode);
            const isThunder = w.weathercode >= 95;

            lastRegion = displayRegion;

            const weatherBox = document.getElementById("weatherBox");

            // ★ 県（都道府県）かどうか判定
            const isPrefecture = /[都道府県]$/.test(displayRegion);

            // 数値整理
            const temp  = Math.round(w.temperature);
            const feels = Math.round(data.hourly.apparent_temperature[hour]);
            const wind  = Math.round(w.windspeed);
            const rain  = Math.round(precipProb);
            const isHeavyRain  = precipProb >= 70;
            const isStrongWind = wind >= 8;

            // ★ 全角スペース・テキスト直書きを完全排除
            weatherBox.innerHTML = `
                <span class="region ${isPrefecture ? 'prefecture' : ''}">
                    ${displayRegion}
                </span>

                ${info.icon}

                <span class="weather-name">${info.name}</span>

                <span class="temp">気温${temp}℃</span>
                <span class="feels">体感${feels}℃</span>

                <span class="wind ${isStrongWind ? 'strong-wind' : ''}">
                    風${wind}m/s
                </span>

                <span class="rain ${isHeavyRain ? 'heavy-rain' : ''}">
                    雨${rain}%
                </span>

                ${isThunder ? '<span class="thunder-alert">雷</span>' : ''}
            `;

            // フォント調整（既存ロジック維持）
            adjustFontSize(weatherBox, 13, 10);

            // アイコンサイズ微調整
            const icon = weatherBox.querySelector("i");
            if (icon) {
                icon.style.fontSize =
                    Math.min(16, weatherBox.clientHeight - 4) + "px";
            }
        })
        .catch(() => {
            document.getElementById("weatherBox").textContent = "取得失敗";
        });
}

// 住所 → 緯度経度
function addressToLatLon(address) {
    if(locationCache[address]) return Promise.resolve(locationCache[address]);
    if(isSearching) return Promise.reject("検索中");
    isSearching = true;
    const q = "日本 " + address;
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(q)}`;
    return fetch(url)
        .then(res=>res.json())
        .then(data=>{
            isSearching=false;
            if(data.length===0) throw new Error("住所が見つかりません");
            const pos = {lat:data[0].lat, lon:data[0].lon, address:data[0].address};
            locationCache[address]=pos;
            return pos;
        })
        .catch(err=>{isSearching=false; throw err;});
}

// 自動更新
function startWeatherAutoUpdate() {
    if(weatherInterval) clearInterval(weatherInterval);
    weatherInterval = setInterval(()=>loadWeather(lastLat,lastLon,formatCityAddress({city:lastRegion})), 10*60*1000);
}

// 初期読み込み
if(lastSearchedRegion){
    addressToLatLon(lastSearchedRegion)
        .then(pos=>{
            const fullAddr = formatFullAddress(pos.address);
            const cityAddr = formatCityAddress(pos.address);
            loadWeather(pos.lat,pos.lon,cityAddr);
            startWeatherAutoUpdate();
        })
        .catch(()=>{ loadWeather(lastLat,lastLon,formatCityAddress({city:lastRegion})); startWeatherAutoUpdate(); });
} else {
    loadWeather(lastLat,lastLon,formatCityAddress({city:lastRegion}));
    startWeatherAutoUpdate();
}

// モーダル操作
document.getElementById("weatherBox").onclick = ()=>{
    const modal = document.getElementById("addressModal");
    const addressInput = document.getElementById("addressInput");
    addressInput.value = localStorage.getItem("lastSearchedRegion") || "";

    const resolved = document.getElementById("resolvedAddress");
    if(resolved) resolved.textContent = "";

    const confirmBtn = document.getElementById("addressConfirmBtn");
    if(confirmBtn) confirmBtn.disabled = true;

    // 検索済みフル住所をリセット
    window._pendingAddress = null;

    modal.style.display = "flex";
};

// 検索ボタン
document.getElementById("addressSearchBtn").onclick = ()=>{
    const addr = document.getElementById("addressInput").value.trim();
    if(!addr) return;

addressToLatLon(addr)
    .then(pos=>{
        const fullAddr = formatFullAddress(pos.address);
        const cityAddr = formatCityAddress(pos.address);
        loadWeather(pos.lat,pos.lon,cityAddr);

        const resolved = document.getElementById("resolvedAddress");
        if(resolved){
            resolved.textContent = "※ 表示地点（自動判定）：" + fullAddr;
            resolved.style.color = "#000080"; // 紺色に設定
        }

        const confirmBtn = document.getElementById("addressConfirmBtn");
        if(confirmBtn) confirmBtn.disabled = false;

        // 検索済みフル住所を保存
        window._pendingAddress = fullAddr;
    })

// 住所検索に失敗したとき
.catch(()=>{
    const resolved = document.getElementById("resolvedAddress");
    if(resolved){
        resolved.textContent = "住所が見つかりません";
        resolved.style.color = "#000080"; // 紺色に設定
    }
});

};

// Enterキー
document.getElementById("addressInput").addEventListener("keydown", e=>{
    if(e.key==="Enter"){ e.preventDefault(); document.getElementById("addressSearchBtn").click(); }
});

// キャンセル
document.getElementById("addressCancelBtn").onclick = ()=>{
    document.getElementById("addressModal").style.display="none";
};

// 確定
// 確定
document.getElementById("addressConfirmBtn").onclick = ()=>{
    // 入力フォームに検索済みフル住所を反映（_pendingAddress は null でも大丈夫）
    if(window._pendingAddress){
        document.getElementById("addressInput").value = window._pendingAddress;
        localStorage.setItem("lastSearchedRegion", window._pendingAddress);
    }
    // モーダルを閉じる
    document.getElementById("addressModal").style.display="none";
};

/* ------------------- お天気 高速安全版 最終・アラート付き 完了 ------------------- */

/* --------------------------- スケーリング（全スマホ対応版） ---------------------------- */
function applyAutoScale() {
  const baseW = 400;   // 基準幅
  const baseH = 800;   // 基準高さ

  const screenW = window.innerWidth;
  const screenH = window.innerHeight;

  // 横縦比を考慮して縮小
  const scale = Math.min(screenW / baseW, screenH / baseH);

  const app = document.getElementById("appScaleWrapper");
  if (!app) return;

  // transform と origin を明示
  app.style.transform = `scale(${scale})`;
  app.style.transformOrigin = "top left";
  
  // 中央配置
  app.style.position = "fixed";   // ★ ← 修正！
  app.style.left = `${(screenW - baseW * scale) / 2}px`;
  app.style.top  = `${(screenH - baseH * scale) / 2}px`;
}

/* 軽量化：連続リサイズで処理を間引く */
let resizeTimeout;
function onResize() {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(applyAutoScale, 50);
}

window.addEventListener('load', applyAutoScale);
window.addEventListener('resize', onResize);
/* --------------------------- スケーリング（全スマホ対応版） ---------------------------- */

/* =========================================================
   Service Worker 制御（開発 / 本番 完全分離・最終版）
   ========================================================= */

// ---- ローカル判定（必要に応じて増やせます）----
const isLocal =
  location.hostname === 'localhost' ||
  location.hostname === '127.0.0.1' ||
  location.hostname === '0.0.0.0' ||
  location.hostname.startsWith('192.168.') ||
  location.hostname.startsWith('10.') ||
  location.hostname.match(/^172\.(1[6-9]|2\d|3[01])\./)

// ---- Service Worker 対応ブラウザか ----
if ('serviceWorker' in navigator) {

  if (isLocal) {
    // =====================================================
    // 🧪 開発環境：Service Worker を完全に無効化
    // =====================================================
    window.addEventListener('load', async () => {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs) {
        await reg.unregister();
      }
      devLog('SW disabled (development)');
    });

  } else {
    // =====================================================
    // 🚀 本番環境：Service Worker を登録
    // =====================================================
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(() => devLog('SW registered (production)'))
        .catch(err => console.error('SW error:', err));
    });
  }
}
// --------------------------------------------------------------------------

<!-- ==================== 戻るボタン終了防止 ==================== -->

// 戻るボタン検知
window.addEventListener('popstate', () => {

  if (allowExit) return;

  // 戻らせない
  history.pushState({ app: 'lock' }, '', location.href);

  showExitConfirm();
});

// ② 次に初期履歴を積む
document.addEventListener('DOMContentLoaded', () => {
  history.pushState({ app: 'root' }, '', location.href);
});

  function showExitConfirm() {
    const overlay = document.getElementById('exitConfirm');
    if (overlay) overlay.style.display = 'flex';
  }

  function closeExitConfirm() {
    const overlay = document.getElementById('exitConfirm');
    if (overlay) overlay.style.display = 'none';
  }

  function exitApp() {
  allowExit = true;
  closeExitConfirm();
  location.reload();
}
<!-- ==================== 戻るボタン終了防止 ==================== -->

<!-- ==================== OK・キャンセル　ダイアログ ==================== -->
  function showConfirm(message, callback, okColor) {
    const dialog = document.getElementById('confirmDialog');
    const confirmMessage = document.getElementById('confirmMessage');
    confirmMessage.innerHTML = message;

    // ボタン取得
    const okBtn = dialog.querySelector('button[onclick="okConfirm()"]');
    const cancelBtn = dialog.querySelector('button[onclick="closeConfirm()"]');

    if (!okBtn || !cancelBtn) return;

    // 元の背景・色・影を保持
    const okOriginal = {
        bg: okBtn.style.background,
        color: okBtn.style.color,
        shadow: okBtn.style.boxShadow,
        radius: okBtn.style.borderRadius,
    };
    const cancelOriginal = {
        bg: cancelBtn.style.background,
        color: cancelBtn.style.color,
        shadow: cancelBtn.style.boxShadow,
        radius: cancelBtn.style.borderRadius,
    };

    // OKボタンの色・ぷっくり感
    if (okColor) {
        okBtn.style.background = okColor;
        okBtn.style.color = '#ffffff';
        okBtn.style.borderRadius = '12px';
        okBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25), inset 0 2px 4px rgba(255,255,255,0.3), inset 0 -2px 4px rgba(0,0,0,0.15)';
    }

    // キャンセルボタンもぷっくり感（白でも浮いて見える）
    cancelBtn.style.borderRadius = '12px';
    cancelBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.1)';

    // ダイアログ表示
    dialog.style.display = 'flex';

    // OKクリック
    window.okConfirm = function() {
        // 元に戻す
        okBtn.style.background = okOriginal.bg;
        okBtn.style.color = okOriginal.color;
        okBtn.style.boxShadow = okOriginal.shadow;
        okBtn.style.borderRadius = okOriginal.radius;

        cancelBtn.style.background = cancelOriginal.bg;
        cancelBtn.style.color = cancelOriginal.color;
        cancelBtn.style.boxShadow = cancelOriginal.shadow;
        cancelBtn.style.borderRadius = cancelOriginal.radius;

        dialog.style.display = 'none';
        callback(true);
    };

    // キャンセルクリック
    window.closeConfirm = function() {
        // 元に戻す
        okBtn.style.background = okOriginal.bg;
        okBtn.style.color = okOriginal.color;
        okBtn.style.boxShadow = okOriginal.shadow;
        okBtn.style.borderRadius = okOriginal.radius;

        cancelBtn.style.background = cancelOriginal.bg;
        cancelBtn.style.color = cancelOriginal.color;
        cancelBtn.style.boxShadow = cancelOriginal.shadow;
        cancelBtn.style.borderRadius = cancelOriginal.radius;

        dialog.style.display = 'none';
        callback(false);
    };
}

<!-- ==================== OK・キャンセル　ダイアログ ==================== -->

<!-- ==================== シンプルOK・キャンセル　ダイアログ ==================== -->
function showSimpleConfirm(message, callback) {
    const dialog = document.getElementById('simpleConfirmDialog');
    document.getElementById('simpleConfirmMessage').innerHTML = message;
    dialog.style.display = 'flex';

    // OKが押された時
    window.simpleOK = function() {
      dialog.style.display = 'none';
      callback(true);
    }

    // キャンセルが押された時
    window.simpleCancel = function() {
      dialog.style.display = 'none';
      callback(false);
    }
  }
<!-- ==================== シンプルOK・キャンセル　ダイアログ ==================== -->

<!-- ==================== シンプルOKのみ　ダイアログ ==================== -->
function showSimpleAlert(message, callback) {
    const dialog = document.getElementById('simpleAlertDialog');
    document.getElementById('simpleAlertMessage').innerHTML = message;
    dialog.style.display = 'flex'; // ここで初めて表示

    window.simpleAlertOK = function() {
        dialog.style.display = 'none';
        if(callback) callback();
    }
}
<!-- ==================== シンプルOKのみ　ダイアログ ==================== -->

// 利用規約モーダル
const footer = document.getElementById("settingsFooter");
const modal = document.getElementById("termsDialog");
const closeBtn = modal.querySelector(".close");

// フッタークリックで表示
footer.addEventListener("click", () => {
  modal.classList.add("show");
  document.body.style.overflow = "hidden"; // 背景スクロール防止
});

// 閉じるボタン
closeBtn.addEventListener("click", () => {
  modal.classList.remove("show");
  document.body.style.overflow = "auto"; 
});

// モーダル外クリックで閉じる
window.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.classList.remove("show");
    document.body.style.overflow = "auto"; 
  }
});

// OFUSEモーダル
const openSupportModal = document.getElementById('openSupportModal');
const supportModal = document.getElementById('supportModal');
const supportClose = supportModal.querySelector('.support-close');

openSupportModal.addEventListener('click', (e) => {
  e.preventDefault();
  supportModal.style.display = 'block';
});

supportClose.addEventListener('click', () => {
  supportModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
  if (e.target === supportModal) supportModal.style.display = 'none';
});

// ===============================
// 設定画面 インフォメーションモーダル
// ===============================
document.addEventListener("DOMContentLoaded", () => {

  const helpButton = document.getElementById("helpButtonFooter");
  const helpModal  = document.getElementById("helpModal");
  const closeHelp  = document.getElementById("closeHelp");

  if (!helpButton || !helpModal || !closeHelp) return;

  helpButton.addEventListener("click", () => {
    helpModal.style.display = "block";
    helpModal.setAttribute("aria-hidden", "false");
  });

  closeHelp.addEventListener("click", () => {
    helpModal.style.display = "none";
    helpModal.setAttribute("aria-hidden", "true");
  });

  // モーダル外クリックで閉じる
  helpModal.addEventListener("click", (e) => {
    if (e.target === helpModal) {
      helpModal.style.display = "none";
      helpModal.setAttribute("aria-hidden", "true");
    }
  });

});


// ===============================
// 試合画面 インフォメーションモーダル
// ===============================
document.addEventListener("DOMContentLoaded", () => {

  const openBtn  = document.getElementById("matchInfoButton");
  const modal    = document.getElementById("matchInfoModal");
  const closeBtn = document.getElementById("closeMatchInfo");

  if (!openBtn || !modal || !closeBtn) return;

  // 開く
  openBtn.addEventListener("click", () => {
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
  });

  // 閉じる
  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  });

  // 背景クリックで閉じる
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    }
  });

});

</script>
</body>
</html>